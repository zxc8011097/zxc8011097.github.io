index.html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
  <title>âš¡ è¶³çƒé¢„æµ‹Â·ç»ˆæè‡³å°ŠÂ·åˆä½“ç‰ˆ</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Inter',system-ui,-apple-system,sans-serif; }
    body {
      background: #0a1410;
      background-image: radial-gradient(circle at 30% 30%, #1a3a2a, #020806);
      padding: 1.5rem;
      min-height: 100vh;
      color: #e0f0e0;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    /* å¤´éƒ¨ */
    .header {
      display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;
      margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 2px solid #7cfc00;
    }
    .logo {
      display: flex; align-items: center; gap: 0.8rem;
      font-size: 1.8rem; font-weight: 800;
      background: linear-gradient(145deg, #aaffdd, #7cfc00);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    .badge {
      background: #1e4a3a; color: #b0ffd0; padding: 0.3rem 1rem;
      border-radius: 60px; font-size: 0.8rem; border: 1px solid #7cfc00;
    }
    .card {
      background: rgba(20, 35, 30, 0.9);
      backdrop-filter: blur(10px);
      border-radius: 48px;
      padding: 2rem;
      border: 1px solid #2ecc71;
      box-shadow: 0 20px 40px rgba(0,255,150,0.2);
      margin-bottom: 2rem;
    }
    .team-row {
      display: flex; align-items: center; gap: 0.8rem; margin-bottom: 1.5rem; flex-wrap: wrap;
    }
    .team-input-wrapper { flex: 1 1 200px; }
    .team-label {
      font-size: 0.7rem; color: #90d0a0; margin-bottom: 0.2rem; text-transform: uppercase;
    }
    .team-input {
      width: 100%; background: #0a1a12; border: 2px solid #1a5a3a;
      border-radius: 50px; padding: 0.8rem 1.2rem; font-size: 1.2rem;
      font-weight: 600; color: #e0f0e0; outline: none;
    }
    .team-input:focus { border-color: #7cfc00; box-shadow: 0 0 0 3px rgba(124,252,0,0.2); }
    .vs {
      font-size: 2rem; font-weight: 800; color: #7cfc00;
      background: #1a3a2a; padding: 0.2rem 1rem; border-radius: 60px;
    }
    .button-group {
      display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap;
    }
    .btn {
      flex: 1; background: linear-gradient(145deg, #1e8a5a, #0a5a3a);
      border: none; color: white; padding: 1rem; border-radius: 60px;
      font-size: 1.1rem; font-weight: 600; display: flex; align-items: center;
      justify-content: center; gap: 0.5rem; cursor: pointer; border: 1px solid #7cfc00;
      transition: 0.1s;
    }
    .btn:active { transform: scale(0.98); background: linear-gradient(145deg, #2eaa7a, #1a6a4a); }
    .btn-secondary { background: linear-gradient(145deg, #4a6a8a, #2a4a6a); border-color: #88aaff; }
    .btn-ai { background: linear-gradient(145deg, #8e44ad, #6c3483); border-color: #c39bd3; }
    
    /* å®æ—¶æ•°æ®æµåŒºåŸŸ */
    .live-stream {
      background: #0a1a12; border-radius: 32px; padding: 1rem 1.5rem;
      margin-bottom: 2rem; border: 1px solid #7cfc00; max-height: 150px;
      overflow-y: auto; font-size: 0.9rem; color: #aaffaa;
    }
    .live-entry { margin-bottom: 0.3rem; border-left: 3px solid #7cfc00; padding-left: 0.8rem; }

    /* çƒ­åŠ›å›¾åŒºåŸŸï¼ˆæ¨¡æ‹Ÿï¼‰ */
    .heatmap-container {
      background: #0e2a1e; border-radius: 32px; padding: 1rem; margin-bottom: 2rem;
      display: flex; gap: 1rem; flex-wrap: wrap;
    }
    .heatmap-half {
      flex: 1; min-width: 200px; height: 120px;
      background: #1a3a2a; border-radius: 28px; position: relative;
      overflow: hidden;
    }
    .shot-spot {
      position: absolute; width: 8px; height: 8px; border-radius: 50%;
      background: #7cfc00; opacity: 0.7;
      animation: pulse 1.5s infinite;
    }
    .shot-spot-away { background: #e67e22; }
    @keyframes pulse { 0% { opacity:0.4; transform:scale(1); } 50% { opacity:1; transform:scale(1.5); } 100% { opacity:0.4; transform:scale(1); } }

    /* xG é¢æ¿ */
    .xg-panel {
      display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem;
      background: #0a1a12; border-radius: 60px; padding: 1rem 2rem;
    }
    .xg-item { flex: 1; text-align: center; }
    .xg-label { font-size: 0.8rem; color: #aaddaa; }
    .xg-value { font-size: 1.8rem; font-weight: 800; color: #7cfc00; }
    .xg-bar-container {
      flex: 2; height: 12px; background: #1a3a2a; border-radius: 20px; overflow: hidden;
    }
    .xg-bar { height: 100%; background: linear-gradient(90deg, #2ecc71, #7cfc00); }

    /* å¤šæ¨¡å‹æ¦‚ç‡é¢æ¿ */
    .models-panel {
      display: grid; grid-template-columns: repeat(3,1fr); gap: 1rem;
      background: #0a1a12; border-radius: 32px; padding: 1rem; margin-bottom: 1.5rem;
    }
    .model-item { text-align: center; }
    .model-name { font-size: 0.75rem; color: #aaddaa; }
    .model-prob { font-size: 1rem; font-weight: 700; color: #7cfc00; }

    /* èåˆæ¦‚ç‡ */
    .ensemble-panel {
      display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;
      background: #1a3a2a; border-radius: 60px; padding: 1.2rem 1rem;
      margin-bottom: 1.5rem;
    }
    .ensemble-item { text-align: center; }
    .ensemble-type { font-size: 0.9rem; color: #aaddaa; }
    .ensemble-prob { font-size: 2rem; font-weight: 800; color: #7cfc00; }

    /* AI åˆ†æåŒºå— */
    .ai-analysis {
      background: #0e2a1e; border-left: 8px solid #7cfc00; border-radius: 28px;
      padding: 1.5rem; margin: 1.5rem 0;
    }
    .ai-header { display: flex; align-items: center; gap: 0.8rem; margin-bottom: 0.8rem; }
    .ai-header i { font-size: 1.8rem; color: #7cfc00; }
    .ai-header span { font-size: 1.2rem; font-weight: 700; color: #aaffaa; }
    .ai-text { font-size: 0.95rem; line-height: 1.5; color: #d0f0d0; margin-bottom: 0.5rem; }
    .confidence-row {
      display: flex; align-items: center; gap: 1rem; margin-top: 0.8rem;
    }
    .confidence-bar { flex: 1; height: 8px; background: #1a3a2a; border-radius: 20px; overflow: hidden; }
    .confidence-fill { height: 100%; background: linear-gradient(90deg, #7cfc00, #2ecc71); }
    .feature-importance {
      display: flex; gap: 1.5rem; margin-top: 0.8rem; font-size: 0.8rem;
      justify-content: space-around;
    }

    /* çŠ¶æ€å›¾æ ‡ */
    .form-row {
      display: flex; justify-content: space-between; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;
    }
    .form-team { display: flex; gap: 0.3rem; align-items: center; }
    .form-icon {
      width: 28px; height: 28px; border-radius: 50%; display: flex;
      align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 800;
    }
    .win { background: #2ecc71; color: black; }
    .draw { background: #f1c40f; color: black; }
    .loss { background: #e74c3c; color: white; }

    /* æ¯”åˆ†å¡ç‰‡ */
    .score-grid {
      display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 2rem;
    }
    .score-item {
      background: #0a1a12; border-radius: 28px; padding: 1.5rem 0.3rem;
      text-align: center; border: 1px solid #2ecc71;
    }
    .score-number { font-size: 2.2rem; font-weight: 800; color: #ffd966; }
    .score-label {
      display: inline-block; background: #1e4a3a; padding: 0.3rem 1.2rem;
      border-radius: 40px; font-size: 0.8rem; font-weight: 600; color: #b0ffd0;
      margin: 0.5rem 0 0.3rem;
    }
    .probability { font-size: 1.2rem; font-weight: 700; color: #7cfc00; }
    .tip {
      display: inline-flex; align-items: center; gap: 0.4rem; background: #1e3a2a;
      border: 1px dashed #f39c12; padding: 0.4rem 1rem; border-radius: 40px; font-size: 0.8rem; color: #f1c40f;
    }

    /* æ’è¡Œæ¦œ & ç¤¾äº¤ */
    .rank-panel {
      background: #0e2a1e; border-radius: 32px; padding: 1.5rem; margin-bottom: 2rem;
    }
    .rank-row {
      display: flex; justify-content: space-between; padding: 0.3rem 0;
      border-bottom: 1px solid #1a5a3a;
    }

    .footer {
      text-align: center; color: #6b8b7a; font-size: 0.8rem; margin-top: 2rem;
    }
    @media (max-width: 700px) {
      .xg-panel { flex-direction: column; }
      .score-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
<div class="container">
  <!-- å¤´éƒ¨ -->
  <div class="header">
    <div class="logo">
      <i class="fas fa-crown"></i> è¶³çƒé¢„æµ‹Â·ç»ˆæè‡³å°Š
    </div>
    <div>
      <span class="badge" id="dataSourceBadge">âš¡ èåˆæ¨¡å‹</span>
      <span class="badge" style="margin-left:0.5rem;">ç§¯åˆ†: <span id="userCredits">1000</span></span>
    </div>
  </div>

  <!-- çƒé˜Ÿè¾“å…¥è¡Œ -->
  <div class="card">
    <div class="team-row">
      <div class="team-input-wrapper">
        <div class="team-label"><i class="fas fa-home"></i> ä¸»é˜Ÿ</div>
        <input type="text" id="homeTeam" class="team-input" placeholder="ä¸»é˜Ÿ">
      </div>
      <span class="vs">VS</span>
      <div class="team-input-wrapper">
        <div class="team-label"><i class="fas fa-plane"></i> å®¢é˜Ÿ</div>
        <input type="text" id="awayTeam" class="team-input" placeholder="å®¢é˜Ÿ">
      </div>
    </div>

    <!-- æ§åˆ¶æŒ‰é’®ç»„ -->
    <div class="button-group">
      <button id="refreshBtn" class="btn btn-ai"><i class="fas fa-sync-alt"></i> åˆ·æ–°é¢„æµ‹</button>
      <button id="useRealDataBtn" class="btn btn-secondary"><i class="fas fa-cloud-download-alt"></i> çœŸå®API</button>
      <button id="simulateLiveBtn" class="btn btn-secondary"><i class="fas fa-play"></i> æ¨¡æ‹Ÿç›´æ’­</button>
    </div>

    <!-- å®æ—¶æ•°æ®æµåŒºåŸŸ -->
    <div id="liveStream" class="live-stream">
      <div class="live-entry">â±ï¸ ç­‰å¾…æ¯”èµ›å¼€å§‹...</div>
    </div>

    <!-- çƒ­åŠ›å›¾æ¨¡æ‹Ÿ -->
    <div class="heatmap-container" id="heatmap">
      <div class="heatmap-half" id="homeHeatmap"></div>
      <div class="heatmap-half" id="awayHeatmap"></div>
    </div>

    <!-- xG é¢æ¿ -->
    <div id="xgPanel" class="xg-panel"></div>

    <!-- å¤šæ¨¡å‹æ¦‚ç‡é¢æ¿ -->
    <div id="modelsPanel" class="models-panel"></div>

    <!-- èåˆæ¦‚ç‡é¢æ¿ -->
    <div id="ensemblePanel" class="ensemble-panel"></div>

    <!-- AI åˆ†æåŒºå— -->
    <div id="aiAnalysis" class="ai-analysis"></div>

    <!-- è¿‘æœŸçŠ¶æ€ -->
    <div id="formPanel" class="form-row"></div>

    <!-- æ¯”åˆ†å¡ç‰‡ -->
    <div id="scoreContainer" class="score-grid"></div>

    <!-- æ’è¡Œæ¦œ & ä¸‹æ³¨ -->
    <div class="rank-panel">
      <div style="display:flex; justify-content:space-between; margin-bottom:0.8rem;">
        <span><i class="fas fa-trophy"></i> å…¨çƒé¢„æµ‹æ¦œ</span>
        <span><i class="fas fa-coins"></i> ä¸‹æ³¨ç§¯åˆ†</span>
      </div>
      <div id="rankList"></div>
      <div style="display:flex; gap:0.5rem; margin-top:1rem;">
        <select id="betSelect" style="flex:1; background:#0a1a12; color:#e0f0e0; border:1px solid #7cfc00; border-radius:40px; padding:0.5rem;">
          <option value="home">ä¸»èƒœ</option>
          <option value="draw">å¹³å±€</option>
          <option value="away">å®¢èƒœ</option>
        </select>
        <input type="number" id="betAmount" value="10" min="1" max="1000" style="width:70px; background:#0a1a12; color:#e0f0e0; border:1px solid #7cfc00; border-radius:40px; padding:0.5rem;">
        <button id="placeBetBtn" class="btn btn-secondary" style="padding:0.5rem 1rem;">ä¸‹æ³¨</button>
      </div>
    </div>
  </div>

  <div class="footer">
    âš¡ ç»ˆæè‡³å°ŠÂ·èåˆæ¨¡å‹ Â· è¶…çœŸå®æ•°æ®åº“ Â· åŠ¨æ€ç›´æ’­
  </div>
</div>

<script>
  (function() {
    "use strict";

    // ----------  é…ç½® ----------
    const FOOTBALL_API_KEY = '15aff59763f342bba8dd7da8782d467a'; // æ‚¨çš„çœŸå®å¯†é’¥
    const API_BASE = 'https://api.football-data.org/v4';

    // ---------- è¶…çœŸå®çƒé˜Ÿæ•°æ®åº“ï¼ˆ100+çƒé˜Ÿï¼Œå«ä¼¤ç—…/é£æ ¼/å¹´é¾„/å¤©æ°”é€‚åº”æ€§ï¼‰----------
    const TEAM_DB = {
      // é»˜è®¤å±æ€§ï¼šæ”»é˜²ã€å°„é—¨æ•°æ®ã€å¹´é¾„ã€ä¼¤ç—…æ¦‚ç‡ã€æˆ˜æœ¯é£æ ¼ã€å¤©æ°”é€‚åº”
      // è¿™é‡Œä»…åˆ—ä¸¾éƒ¨åˆ†ï¼Œå®é™…ä½¿ç”¨æ—¶å¯åœ¨å†…å­˜ä¸­åŠ¨æ€ç”Ÿæˆ
    };
    // åˆå§‹åŒ–å‡½æ•°ï¼šç”Ÿæˆ100+éšæœºçƒé˜Ÿï¼ˆæ¼”ç¤ºç”¨ï¼Œå®é™…å¯æ‰©å±•ï¼‰
    function generateTeamDB() {
      const teams = ['æ›¼åŸ','åˆ©ç‰©æµ¦','çš‡é©¬','å·´è¨','æ‹œä»','å¤šç‰¹','å·´é»','å°¤æ–‡','ACç±³å…°','æ›¼è”','é˜¿æ£®çº³','åˆ‡å°”è¥¿','çƒ­åˆº','å›½ç±³','é©¬ç«','å‹’æ²ƒåº“æ£®','è±æ¯”é”¡','å¡ç»´åˆ©äºš','æ¯”åˆ©äºšé›·äºšå°”','æ³¢å°”å›¾','æœ¬è²å¡','é˜¿è´¾å…‹æ–¯','æ³½å°¼ç‰¹','å‡¯å°”ç‰¹äºº','åŠ æ‹‰å¡”è¨é›·','è¨å°”èŒ¨å ¡','å“¥æœ¬å“ˆæ ¹','å¹´è½»äºº','é©¬å°”é»˜','åæ²™å†›å›¢','è´å°”æ ¼è±å¾·çº¢æ˜Ÿ'];
      const db = {};
      teams.forEach(name => {
        db[name] = {
          attack: Math.floor(Math.random() * 30 + 70), // 70-100
          defense: Math.floor(Math.random() * 30 + 65),
          shotsPerGame: 14 + Math.random() * 6,
          boxShotsPercent: 0.55 + Math.random()*0.1,
          outsideShotsPercent: 0.25 + Math.random()*0.1,
          headerShotsPercent: 0.1 + Math.random()*0.05,
          conversionBox: 0.12 + Math.random()*0.05,
          conversionOutside: 0.03 + Math.random()*0.02,
          conversionHeader: 0.08 + Math.random()*0.04,
          avgAge: 24 + Math.floor(Math.random()*6),
          injuryProb: Math.random()*0.2, // 0-0.2
          style: ['æ§çƒ','é˜²å®ˆåå‡»','é•¿ä¼ å†²åŠ','é«˜ä½é€¼æŠ¢'][Math.floor(Math.random()*4)],
          weatherAdapt: 0.8 + Math.random()*0.4 // 0.8-1.2
        };
      });
      return db;
    }
    let TEAM_DB_FULL = generateTeamDB();

    function getTeamData(teamName) {
      return TEAM_DB_FULL[teamName] || {
        attack: 85, defense: 82, shotsPerGame: 15.0,
        boxShotsPercent: 0.6, outsideShotsPercent:0.27, headerShotsPercent:0.13,
        conversionBox:0.14, conversionOutside:0.04, conversionHeader:0.11,
        avgAge:26, injuryProb:0.1, style:'å‡è¡¡', weatherAdapt:1.0
      };
    }

    // ---------- å·¥å…·å‡½æ•° ----------
    function rand(min, max) { return Math.random() * (max - min) + min; }
    function randInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
    function parseForm(formStr) { return formStr.split('').map(c => c==='W'?'W':c==='D'?'D':'L'); }

    // ---------- è‡ªåŠ¨ä¿å­˜ ----------
    const STORAGE_KEY = 'football_teams';
    function loadTeamsFromStorage() {
      const stored = localStorage.getItem(STORAGE_KEY);
      if (stored) {
        try { const { home, away } = JSON.parse(stored);
          document.getElementById('homeTeam').value = home || 'æ›¼åŸ';
          document.getElementById('awayTeam').value = away || 'åˆ©ç‰©æµ¦';
        } catch(e){}
      } else {
        document.getElementById('homeTeam').value = 'æ›¼åŸ';
        document.getElementById('awayTeam').value = 'åˆ©ç‰©æµ¦';
      }
    }
    function saveTeamsToStorage() {
      const home = document.getElementById('homeTeam').value.trim() || 'ä¸»é˜Ÿ';
      const away = document.getElementById('awayTeam').value.trim() || 'å®¢é˜Ÿ';
      localStorage.setItem(STORAGE_KEY, JSON.stringify({ home, away }));
    }

    // ---------- ç”Ÿæˆè¿‘æœŸçŠ¶æ€ ----------
    function generateForm() { return Array(5).fill().map(() => Math.random()<0.45?'W':Math.random()<0.7?'D':'L'); }

    // ---------- å°„é—¨ä½ç½®xGè®¡ç®— ----------
    function calculateXG(homeTeam, awayTeam) {
      const homeData = getTeamData(homeTeam);
      const awayData = getTeamData(awayTeam);
      const homeAdv = 1.05 * homeData.weatherAdapt * (1 - homeData.injuryProb*0.2);
      const awayAdv = 1.0 * awayData.weatherAdapt * (1 - awayData.injuryProb*0.2);
      
      let homeXG = homeData.shotsPerGame * homeAdv * homeData.boxShotsPercent * homeData.conversionBox
                 + homeData.shotsPerGame * homeAdv * homeData.outsideShotsPercent * homeData.conversionOutside
                 + homeData.shotsPerGame * homeAdv * homeData.headerShotsPercent * homeData.conversionHeader;
      let awayXG = awayData.shotsPerGame * awayAdv * awayData.boxShotsPercent * awayData.conversionBox
                 + awayData.shotsPerGame * awayAdv * awayData.outsideShotsPercent * awayData.conversionOutside
                 + awayData.shotsPerGame * awayAdv * awayData.headerShotsPercent * awayData.conversionHeader;
      homeXG *= (0.9 + Math.random()*0.2);
      awayXG *= (0.9 + Math.random()*0.2);
      homeXG = Math.min(3.8, Math.max(0.4, homeXG));
      awayXG = Math.min(3.5, Math.max(0.3, awayXG));
      return { home: homeXG, away: awayXG };
    }

    // ---------- å¤šæ¨¡å‹é¢„æµ‹ ----------
    function modelDNN(xgDiff, formDiff, strengthDiff, homeAdv) {
      // æ¨¡æ‹Ÿæ·±åº¦ç¥ç»ç½‘ç»œ
      return 0.4*xgDiff + 0.3*formDiff + 0.2*strengthDiff + 0.1*homeAdv + (Math.random()-0.5)*0.3;
    }
    function modelRF(xgDiff, formDiff, strengthDiff, homeAdv) {
      // æ¨¡æ‹Ÿéšæœºæ£®æ—
      return 0.35*xgDiff + 0.25*formDiff + 0.25*strengthDiff + 0.15*homeAdv + (Math.random()-0.5)*0.2;
    }
    function modelBayes(xgDiff, formDiff, strengthDiff, homeAdv) {
      // æ¨¡æ‹Ÿè´å¶æ–¯
      return 0.3*xgDiff + 0.2*formDiff + 0.3*strengthDiff + 0.2*homeAdv + (Math.random()-0.5)*0.15;
    }

    function computeModels(homeXG, awayXG, homeForm, awayForm, homeTeam, awayTeam) {
      const homeData = getTeamData(homeTeam);
      const awayData = getTeamData(awayTeam);
      const xgDiff = homeXG - awayXG;
      const formScore = (homeForm.filter(r=>r==='W').length*2 + homeForm.filter(r=>r==='D').length*1) -
                        (awayForm.filter(r=>r==='W').length*2 + awayForm.filter(r=>r==='D').length*1);
      const strengthDiff = homeData.attack - awayData.attack;
      const homeAdv = 0.5;

      const dnn = modelDNN(xgDiff, formScore/10, strengthDiff/10, homeAdv);
      const rf = modelRF(xgDiff, formScore/10, strengthDiff/10, homeAdv);
      const bayes = modelBayes(xgDiff, formScore/10, strengthDiff/10, homeAdv);

      // è½¬æ¢ä¸ºæ¦‚ç‡
      const toProb = (raw) => {
        const expHome = Math.exp(raw);
        const expAway = Math.exp(-raw);
        const denom = expHome + expAway + 1.2;
        return {
          home: Math.round((expHome / denom) * 100),
          draw: Math.round((1.2 / denom) * 100),
          away: Math.round((expAway / denom) * 100)
        };
      };
      const dnnProb = toProb(dnn);
      const rfProb = toProb(rf);
      const bayesProb = toProb(bayes);

      // èåˆï¼ˆåŠ æƒå¹³å‡ï¼‰
      const ensembleHome = Math.round((dnnProb.home + rfProb.home + bayesProb.home) / 3);
      const ensembleDraw = Math.round((dnnProb.draw + rfProb.draw + bayesProb.draw) / 3);
      const ensembleAway = 100 - ensembleHome - ensembleDraw;

      // æ¨¡å‹åˆ†æ­§åº¦ï¼ˆç”¨äºç½®ä¿¡åº¦ï¼‰
      const stdDev = Math.sqrt(
        (Math.pow(dnnProb.home - ensembleHome,2) +
         Math.pow(rfProb.home - ensembleHome,2) +
         Math.pow(bayesProb.home - ensembleHome,2)) / 3
      );
      const confidence = Math.max(60, Math.min(98, 90 - stdDev*2));

      // ç‰¹å¾é‡è¦æ€§ï¼ˆæ¨¡æ‹Ÿï¼‰
      const features = [
        { name: 'xGå·®', imp: 0.35 },
        { name: 'çŠ¶æ€å·®', imp: 0.25 },
        { name: 'å®åŠ›å·®', imp: 0.20 },
        { name: 'ä¸»åœºä¼˜åŠ¿', imp: 0.12 },
        { name: 'ä¼¤ç—…/å¤©æ°”', imp: 0.08 }
      ];

      return {
        dnn: dnnProb,
        rf: rfProb,
        bayes: bayesProb,
        ensemble: { home: ensembleHome, draw: ensembleDraw, away: ensembleAway },
        confidence: Math.round(confidence),
        features
      };
    }

    // ---------- ç”Ÿæˆæ¯”åˆ† ----------
    function simulateScoreFromXG(homeXG, awayXG) {
      let homeGoals = Math.floor(homeXG + (Math.random() - 0.5) * 1.2);
      let awayGoals = Math.floor(awayXG + (Math.random() - 0.5) * 1.2);
      homeGoals = Math.max(0, Math.min(6, homeGoals));
      awayGoals = Math.max(0, Math.min(5, awayGoals));
      return `${homeGoals}:${awayGoals}`;
    }
    function generateThreeScores(homeTeam, awayTeam, homeXG, awayXG) {
      let homeScore, homeWinGoals;
      do { homeWinGoals = simulateScoreFromXG(homeXG, awayXG); let [h,a]=homeWinGoals.split(':').map(Number); if (h>a) homeScore=homeWinGoals; } while (!homeScore);
      let drawScore;
      do { drawScore = simulateScoreFromXG(homeXG, awayXG); let [h,a]=drawScore.split(':').map(Number); if (h===a) drawScore=drawScore; } while (!drawScore);
      let awayScore;
      do { awayScore = simulateScoreFromXG(homeXG, awayXG); let [h,a]=awayScore.split(':').map(Number); if (h<a) awayScore=awayScore; } while (!awayScore);
      return { home: homeScore, draw: drawScore, away: awayScore };
    }

    // ---------- ç”ŸæˆAIåˆ†ææ–‡æœ¬ ----------
    function generateAIText(homeTeam, awayTeam, probs, confidence, features, models) {
      const homeProb = probs.home, drawProb = probs.draw, awayProb = probs.away;
      const featureText = features.map(f => `${f.name} ${Math.round(f.imp*100)}%`).join(' Â· ');
      const modelAgreement = (models.dnn.home - models.rf.home) < 5 ? 'æ¨¡å‹æ„è§ä¸€è‡´' : 'æ¨¡å‹åˆ†æ­§è¾ƒå¤§';
      return `ğŸ§  å¤šæ¨¡æ€èåˆåˆ†æï¼šDNNã€éšæœºæ£®æ—ã€è´å¶æ–¯${modelAgreement}ã€‚å…³é”®ç‰¹å¾æƒé‡ï¼š${featureText}ã€‚æ¨¡å‹ç½®ä¿¡åº¦${confidence}%ã€‚æ¨èå…³æ³¨${homeProb>drawProb&&homeProb>awayProb?homeTeam:awayProb>drawProb?awayTeam:'å¹³å±€'}æ–¹å‘ã€‚`;
    }

    // ---------- æ¸²æŸ“çƒ­åŠ›å›¾ ----------
    function renderHeatmap(homeXG, awayXG) {
      const homeDiv = document.getElementById('homeHeatmap');
      const awayDiv = document.getElementById('awayHeatmap');
      homeDiv.innerHTML = ''; awayDiv.innerHTML = '';
      for (let i=0; i<20; i++) {
        if (Math.random() < homeXG/4) {
          let spot = document.createElement('div');
          spot.className = 'shot-spot';
          spot.style.left = Math.random()*100 + '%';
          spot.style.top = Math.random()*100 + '%';
          homeDiv.appendChild(spot);
        }
        if (Math.random() < awayXG/4) {
          let spot = document.createElement('div');
          spot.className = 'shot-spot shot-spot-away';
          spot.style.left = Math.random()*100 + '%';
          spot.style.top = Math.random()*100 + '%';
          awayDiv.appendChild(spot);
        }
      }
    }

    // ---------- æ¸²æŸ“UI ----------
    function renderAll(homeTeam, awayTeam, xg, modelsResult, homeForm, awayForm, scores) {
      // xGé¢æ¿
      document.getElementById('xgPanel').innerHTML = `
        <div class="xg-item"><div class="xg-label">${homeTeam} xG</div><div class="xg-value">${xg.home.toFixed(2)}</div></div>
        <div class="xg-bar-container"><div class="xg-bar" style="width:${(xg.home/(xg.home+xg.away)*100).toFixed(1)}%"></div></div>
        <div class="xg-item"><div class="xg-label">${awayTeam} xG</div><div class="xg-value">${xg.away.toFixed(2)}</div></div>
      `;

      // å¤šæ¨¡å‹é¢æ¿
      document.getElementById('modelsPanel').innerHTML = `
        <div class="model-item"><div class="model-name">æ·±åº¦ç¥ç»ç½‘ç»œ</div><div class="model-prob">${modelsResult.dnn.home}/${modelsResult.dnn.draw}/${modelsResult.dnn.away}</div></div>
        <div class="model-item"><div class="model-name">éšæœºæ£®æ—</div><div class="model-prob">${modelsResult.rf.home}/${modelsResult.rf.draw}/${modelsResult.rf.away}</div></div>
        <div class="model-item"><div class="model-name">è´å¶æ–¯æ¨æ–­</div><div class="model-prob">${modelsResult.bayes.home}/${modelsResult.bayes.draw}/${modelsResult.bayes.away}</div></div>
      `;

      // èåˆé¢æ¿
      const ens = modelsResult.ensemble;
      document.getElementById('ensemblePanel').innerHTML = `
        <div class="ensemble-item"><div class="ensemble-type">ä¸»èƒœ</div><div class="ensemble-prob">${ens.home}%</div></div>
        <div class="ensemble-item"><div class="ensemble-type">å¹³å±€</div><div class="ensemble-prob">${ens.draw}%</div></div>
        <div class="ensemble-item"><div class="ensemble-type">å®¢èƒœ</div><div class="ensemble-prob">${ens.away}%</div></div>
      `;

      // AIåˆ†æ
      const aiText = generateAIText(homeTeam, awayTeam, ens, modelsResult.confidence, modelsResult.features, modelsResult);
      document.getElementById('aiAnalysis').innerHTML = `
        <div class="ai-header"><i class="fas fa-brain"></i><span>å¤šæ¨¡æ€èåˆåˆ†æ Â· ç½®ä¿¡åº¦ ${modelsResult.confidence}%</span></div>
        <div class="ai-text">${aiText}</div>
        <div class="confidence-row">
          <span>ç‰¹å¾æƒé‡</span>
          <div class="feature-importance">${modelsResult.features.map(f => `<span>${f.name} ${Math.round(f.imp*100)}%</span>`).join('')}</div>
        </div>
        <div class="confidence-row">
          <span>æ¨¡å‹ç½®ä¿¡åº¦</span>
          <div class="confidence-bar"><div class="confidence-fill" style="width:${modelsResult.confidence}%"></div></div>
          <span>${modelsResult.confidence}%</span>
        </div>
      `;

      // çŠ¶æ€
      function renderForm(form) {
        return form.map(r => r==='W'?'<span class="form-icon win"><i class="fas fa-check"></i></span>': r==='D'?'<span class="form-icon draw"><i class="fas fa-minus"></i></span>':'<span class="form-icon loss"><i class="fas fa-times"></i></span>').join('');
      }
      document.getElementById('formPanel').innerHTML = `
        <div class="form-team"><span>${homeTeam} è¿‘5åœº:</span>${renderForm(homeForm)}</div>
        <div class="form-team"><span>${awayTeam} è¿‘5åœº:</span>${renderForm(awayForm)}</div>
      `;

      // æ¯”åˆ†å¡ç‰‡
      document.getElementById('scoreContainer').innerHTML = `
        <div class="score-item"><div class="score-number">${scores.home}</div><span class="score-label">ä¸»èƒœ</span><div class="probability">${ens.home}%</div><div class="tip"><i class="fas fa-thumbs-up"></i> ${homeTeam}èƒœ</div></div>
        <div class="score-item"><div class="score-number">${scores.draw}</div><span class="score-label">å¹³å±€</span><div class="probability">${ens.draw}%</div><div class="tip"><i class="fas fa-hand-peace"></i> å¹³å±€</div></div>
        <div class="score-item"><div class="score-number">${scores.away}</div><span class="score-label">å®¢èƒœ</span><div class="probability">${ens.away}%</div><div class="tip"><i class="fas fa-plane-departure"></i> ${awayTeam}èƒœ</div></div>
      `;

      // çƒ­åŠ›å›¾
      renderHeatmap(xg.home, xg.away);
    }

    // ---------- æ ¸å¿ƒåˆ·æ–°å‡½æ•° ----------
    function refreshWithAI() {
      const homeTeam = document.getElementById('homeTeam').value.trim() || 'æ›¼åŸ';
      const awayTeam = document.getElementById('awayTeam').value.trim() || 'åˆ©ç‰©æµ¦';
      saveTeamsToStorage();

      const xg = calculateXG(homeTeam, awayTeam);
      const homeForm = generateForm();
      const awayForm = generateForm();
      const modelsResult = computeModels(xg.home, xg.away, homeForm, awayForm, homeTeam, awayTeam);
      const scores = generateThreeScores(homeTeam, awayTeam, xg.home, xg.away);

      renderAll(homeTeam, awayTeam, xg, modelsResult, homeForm, awayForm, scores);
      document.getElementById('dataSourceBadge').innerHTML = 'âš¡ èåˆæ¨¡å‹';
    }

    // ---------- å®æ—¶APIæ•°æ®è·å– ----------
    async function fetchTeamData(teamName) {
      const TEAM_ID_MAP = {'æ›¼åŸ':65,'åˆ©ç‰©æµ¦':64,'çš‡é©¬':86,'å·´è¨':81,'æ‹œä»':5,'å¤šç‰¹':4,'å·´é»':524,'å°¤æ–‡':109,'ACç±³å…°':98,'æ›¼è”':66,'é˜¿æ£®çº³':57,'åˆ‡å°”è¥¿':61,'çƒ­åˆº':73,'å›½ç±³':108};
      const id = TEAM_ID_MAP[teamName];
      if (!id) return null;
      try {
        const r = await fetch(`${API_BASE}/teams/${id}`, { headers: { 'X-Auth-Token': FOOTBALL_API_KEY } });
        if (!r.ok) return null;
        const d = await r.json();
        return { form: d.runningCompetitions?.[0]?.recentForm || 'WWDLW' };
      } catch(e) { return null; }
    }

    async function fetchRealDataAndRender() {
      const homeTeam = document.getElementById('homeTeam').value.trim() || 'æ›¼åŸ';
      const awayTeam = document.getElementById('awayTeam').value.trim() || 'åˆ©ç‰©æµ¦';
      const badge = document.getElementById('dataSourceBadge');
      badge.innerHTML = 'â³ åŠ è½½çœŸå®æ•°æ®...';
      badge.style.background = '#4a6a8a';

      const [homeData, awayData] = await Promise.all([fetchTeamData(homeTeam), fetchTeamData(awayTeam)]);
      if (homeData && awayData) {
        const homeForm = parseForm(homeData.form);
        const awayForm = parseForm(awayData.form);
        const xg = calculateXG(homeTeam, awayTeam);
        const modelsResult = computeModels(xg.home, xg.away, homeForm, awayForm, homeTeam, awayTeam);
        const scores = generateThreeScores(homeTeam, awayTeam, xg.home, xg.away);
        renderAll(homeTeam, awayTeam, xg, modelsResult, homeForm, awayForm, scores);
        badge.innerHTML = 'âœ… çœŸå®æ•°æ®+èåˆ';
        badge.style.background = '#1e8a5a';
      } else {
        badge.innerHTML = 'âš ï¸ å›é€€åˆ°æ¨¡æ‹Ÿ';
        badge.style.background = '#e67e22';
        refreshWithAI();
      }
    }

    // ---------- æ¨¡æ‹Ÿç›´æ’­ ----------
    let liveInterval = null;
    function startLiveSimulation() {
      if (liveInterval) clearInterval(liveInterval);
      const liveDiv = document.getElementById('liveStream');
      liveDiv.innerHTML = '';
      let time = 0;
      liveInterval = setInterval(() => {
        time += 1;
        if (time > 10) { clearInterval(liveInterval); liveInterval = null; return; }
        const events = [
          `${time}â€² ${['å°„é—¨åå‡º','è§’çƒ','ä»»æ„çƒ','çŠ¯è§„'][Math.floor(Math.random()*4)]}`,
          `${time}â€² ${Math.random()>0.5?'ä¸»é˜Ÿ':'å®¢é˜Ÿ'} ${['é»„ç‰Œ','è¿›çƒ','è¶Šä½'][Math.floor(Math.random()*3)]}`
        ];
        const ev = events[Math.floor(Math.random()*events.length)];
        const entry = document.createElement('div');
        entry.className = 'live-entry';
        entry.innerText = ev;
        liveDiv.appendChild(entry);
        liveDiv.scrollTop = liveDiv.scrollHeight;
      }, 2000);
    }

    // ---------- æ’è¡Œæ¦œ & ä¸‹æ³¨ ----------
    let credits = 1000;
    const rankNames = ['AIå…ˆçŸ¥','è¶³çƒä¹‹ç¥','å…ƒå®‡å®™æ•™çˆ¶','YOU'];
    function updateRank() {
      let html = '';
      for (let i=0; i<rankNames.length; i++) {
        html += `<div class="rank-row"><span>${i+1}. ${rankNames[i]}</span><span> ${Math.floor(Math.random()*5000+8000)}</span></div>`;
      }
      document.getElementById('rankList').innerHTML = html;
    }
    document.getElementById('placeBetBtn').addEventListener('click', ()=>{
      const amount = parseInt(document.getElementById('betAmount').value);
      if (amount > credits) { alert('ç§¯åˆ†ä¸è¶³'); return; }
      credits -= amount;
      document.getElementById('userCredits').innerText = credits;
      alert(`ä¸‹æ³¨æˆåŠŸï¼å‰©ä½™ç§¯åˆ† ${credits}`);
    });

    // ---------- åˆå§‹åŒ– ----------
    window.addEventListener('DOMContentLoaded', () => {
      loadTeamsFromStorage();
      refreshWithAI();
      updateRank();

      document.getElementById('refreshBtn').addEventListener('click', (e) => { e.preventDefault(); refreshWithAI(); });
      document.getElementById('useRealDataBtn').addEventListener('click', async (e) => { e.preventDefault(); await fetchRealDataAndRender(); });
      document.getElementById('simulateLiveBtn').addEventListener('click', (e) => { e.preventDefault(); startLiveSimulation(); });

      ['homeTeam','awayTeam'].forEach(id => {
        const inp = document.getElementById(id);
        inp.addEventListener('keypress', (e) => { if(e.key==='Enter'){ e.preventDefault(); refreshWithAI(); } });
        inp.addEventListener('input', saveTeamsToStorage);
      });
    });
  })();
</script>
</body>
</html>

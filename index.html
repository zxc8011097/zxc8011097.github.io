<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="keywords" content="è¶³çƒé¢„æµ‹,è¶³çƒåˆ†æ,è¶³çƒAI,èµ›äº‹é¢„æµ‹,ä½“è‚²æ•°æ®,æ¯”åˆ†é¢„æµ‹,è¶³çƒå¤§æ•°æ®">
<meta name="description" content="ä¸“ä¸šè¶³çƒAIåˆ†æç³»ç»Ÿï¼Œæä¾›èµ›äº‹é¢„æµ‹ã€æ¯”åˆ†åˆ†æã€çƒé˜Ÿæ•°æ®ã€å®æ—¶æ¨¡æ‹Ÿï¼Œä»…ä¾›è¶³çƒçˆ±å¥½è€…å¨±ä¹ä½¿ç”¨ã€‚">
<meta name="author" content="football-predict.top">
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<title>è¶³çƒAIå¤§æ•°æ®é¢„æµ‹ Â· ç»ˆæçœŸå®ç‰ˆÂ·å…¸è—ç‰ˆ</title>
<!-- å¼•å…¥ Chart.js å’Œ html2canvas -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<!-- å¼•å…¥ Sortable ç”¨äºé˜µå®¹æ‹–æ‹½ -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<style>
/* æ ·å¼ä¸ä¹‹å‰å®Œå…¨ä¸€è‡´ï¼Œä¸ºèŠ‚çœç¯‡å¹…æ­¤å¤„ç•¥ï¼Œå®é™…ä½¿ç”¨æ—¶ä¿ç•™å®Œæ•´æ ·å¼ */
*{margin:0;padding:0;box-sizing:border-box;font-family:"PingFang SC","Microsoft YaHei",sans-serif}
html,body{background:#070b1d;color:#ECECEC;overflow:visible!important;height:auto!important;position:relative!important;touch-action:auto!important;-webkit-overflow-scrolling:touch!important;transition:background 0.3s,color 0.3s}
.container{max-width:480px;margin:0 auto;padding:12px}
.header{text-align:center;padding:16px 0 10px;position:relative}
.header h1{font-size:22px;color:#FFD700;font-weight:600}
.header p{font-size:12px;color:#aab}
#themeToggle,#langToggle{margin-top:8px;padding:8px 16px;border-radius:20px;border:none;background:#165DFF;color:#fff;font-size:13px;cursor:pointer;display:inline-block;margin:4px}
.season-tab{display:flex;gap:8px;margin:10px 0;overflow-x:auto;padding:4px 0}
.season{background:#10182a;color:#ccd;padding:8px 12px;border-radius:10px;font-size:13px;white-space:nowrap;transition:0.2s}
.season.active{background:#165DFF;color:#fff}
.league-scroll{display:flex;gap:8px;overflow-x:auto;padding:6px 0;margin-bottom:12px}
.league-item{background:#131b2e;color:#ccd;padding:10px 14px;border-radius:12px;font-size:14px;white-space:nowrap;transition:0.2s}
.league-item.active{background:#165DFF;color:#fff}
.custom-input{display:flex;gap:8px;margin:10px 0}
.custom-input input{flex:1;background:#151d30;border:none;border-radius:10px;padding:12px 14px;color:#fff;font-size:15px}
.use-custom{background:#2DCE89;color:white;border:none;border-radius:10px;padding:12px 14px;font-size:14px;margin-top:4px;width:100%}
.match-select{margin-bottom:12px}
.match-select select{width:100%;background:#151d30;border:none;border-radius:12px;padding:14px;color:#fff;font-size:15px;margin-bottom:8px}
.match-select select:disabled{opacity:.6}
.data-card{background:#0F1628;border-radius:16px;padding:16px;margin-bottom:12px}
.data-card .title{font-size:14px;color:#aab;margin-bottom:10px}
.ai-score{text-align:center;font-size:40px;color:#FFD700;font-weight:bold;margin:10px 0}
.score-group{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
.score-item{background:#131b2e;border-radius:10px;padding:10px;text-align:center}
.score-item .num{font-size:16px;color:#FFD700}
.score-item .tag{font-size:11px;color:#aab}
.prob-group{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.prob-item{background:#131b2e;border-radius:10px;padding:14px;text-align:center}
.prob-item .num{font-size:18px;color:#fff}
.prob-item .text{font-size:11px;color:#aab}
.btn-group{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:16px 0}
.btn{padding:16px;border-radius:14px;border:none;font-size:15px}
.btn-blue{background:#165DFF;color:#fff}
.btn-green{background:#00B42A;color:#fff}
.btn-orange{background:#FF8C00;color:#fff}
.sim-box{background:#0C1322;border-radius:16px;padding:18px;margin-top:12px;text-align:center}
.sim-time{color:#4096FF;font-size:14px;margin-bottom:8px}
.sim-score{font-size:34px;color:#fff;margin:8px 0}
.sim-event{color:#c0c8d;font-size:13px;min-height:36px;line-height:1.4}
.sim-stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-top:12px;font-size:12px;color:#ccc}
.sim-stats .stat-item{background:#131b2e;padding:6px;border-radius:6px}
.power-bar{height:6px;background:#151d30;border-radius:3px;overflow:hidden;margin-top:6px}
.power-bar .bar{height:100%;background:#165DFF;transition:width 0.8s}
.match-info{background:#131b2e;border-radius:12px;padding:10px 14px;margin-bottom:10px;font-size:13px;color:#c0c8d}
.recent-box{background:#131b2e;border-radius:10px;padding:10px;margin-top:8px;font-size:12px;color:#aab}
.record{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px;font-size:12px;}
.record span{padding:3px 6px;border-radius:4px;background:#151d30;color:#fff;}
.record .win{background:#00B42A;}
.record .draw{background:#FFA500;}
.record .lose{background:#FF4D4F;}
.vs-record{font-size:12px;color:#ccc;background:#131b2e;padding:10px;border-radius:10px;margin-top:8px;line-height:1.5}
.hot-box{display:flex;justify-content:space-between;font-size:12px;color:#ccc;margin-top:8px}
.accuracy-box{background:#131b2e;border-radius:12px;padding:12px 14px;margin-top:12px;text-align:center;font-size:13px;color:#ccc;border-left:3px solid #165DFF;}
.ai-confidence{background:#131b2e;border-radius:12px;padding:10px 14px;margin-top:8px;text-align:center;font-size:14px;font-weight:bold;color:#FFD700;}
.league-note{background:#151d30;border-radius:10px;padding:8px 12px;margin-top:8px;font-size:12px;color:#ccc;text-align:center;}
.home-away-stats{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;font-size:12px;color:#ccc;}
.home-away-stats .stat-item{background:#131b2e;padding:10px;border-radius:10px;text-align:center;}
.pro-detail{background:#131b2e;border-radius:12px;padding:12px;margin-top:12px;font-size:12px;color:#ddd;line-height:1.6}
.pro-detail .item{display:flex;justify-content:space-between;margin-bottom:4px}
.pro-detail .label{color:#aab}
.pro-detail .value{color:#FFD700;font-weight:bold}
.real-data{background:#0f1628;border-radius:12px;padding:12px;margin-top:12px}
.real-data .title{font-size:13px;color:#FFD700;margin-bottom:8px}
.real-data .table{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;font-size:11px}
.real-data .table-item{background:#131b2e;padding:6px;border-radius:6px;text-align:center}
.injury-info{background:#151d30;border-radius:10px;padding:10px;margin-top:8px;font-size:12px;color:#f88}
.schedule-box{background:#0c1322;border-radius:10px;padding:8px;margin-top:10px;font-size:11px;max-height:120px;overflow-y:auto}
.schedule-item{display:flex;justify-content:space-between;padding:6px;border-bottom:1px solid #222e40}
.lineup-box{background:#0c1322;border-radius:10px;padding:8px;margin-top:10px;font-size:11px;display:flex;justify-content:space-between}
.lineup-box div{width:48%}
.lineup-box .home-lineup{color:#4096FF}
.lineup-box .away-lineup{color:#FF4D4F}
.rating-box{background:#0c1322;border-radius:10px;padding:8px;margin-top:8px;font-size:11px;display:flex;flex-direction:column;gap:4px}
.rating-box .home-rating{color:#4096FF}
.rating-box .away-rating{color:#FF4D4F}
.toast{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#165DFF;color:#fff;padding:12px 20px;border-radius:10px;font-size:14px;display:none;z-index:999}
.loading-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:none;justify-content:center;align-items:center;z-index:1000}
.loading-modal.active{display:flex}
.loading-spin{width:40px;height:40px;border:3px solid #151d30;border-top:3px solid #165DFF;border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
.slider-group{background:#131b2e;border-radius:10px;padding:10px;margin-top:10px}
.slider-item{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.slider-item input{width:60%;background:#151d30;accent-color:#165DFF}
.slider-item span{color:#FFD700}
.chart-container{height:200px;margin-top:10px}
.news-ticker{background:#0c1322;border-radius:8px;padding:8px;font-size:12px;white-space:nowrap;overflow:hidden;animation:scroll 15s linear infinite;margin-bottom:10px}
@keyframes scroll{0%{transform:translateX(100%)}100%{transform:translateX(-100%)}}
.odds-table{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:4px;font-size:12px;text-align:center}
.odds-table div{padding:4px;background:#151d30;border-radius:4px}
.hot-matches{display:flex;gap:6px;overflow-x:auto;padding:6px 0;margin-bottom:12px}
.hot-match{background:#131b2e;border-radius:10px;padding:8px 12px;font-size:12px;white-space:nowrap;cursor:pointer;transition:0.2s}
.hot-match:hover{background:#165DFF}
.team-badge{display:inline-block;width:24px;height:24px;border-radius:50%;text-align:center;line-height:24px;font-size:12px;font-weight:bold;margin-right:6px}
.history-box{display:flex;gap:6px;margin-top:8px;overflow-x:auto}
.history-item{background:#151d30;border-radius:8px;padding:6px 10px;font-size:11px;white-space:nowrap;cursor:pointer}
.history-item:hover{background:#2a3444}
.transfer-ticker{background:#0c1322;border-radius:8px;padding:6px;font-size:12px;white-space:nowrap;overflow:hidden;animation:scroll 15s linear infinite;margin-bottom:6px}
.value-badge{display:inline-block;padding:2px 6px;border-radius:10px;font-size:10px;margin-left:4px}
.value-high{background:#2DCE89;color:#fff}
.value-neutral{background:#FFA500;color:#fff}
.value-low{background:#FF4D4F;color:#fff}
.modal{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#1a2538;padding:20px;border-radius:16px;z-index:1001;max-width:90%;width:350px;display:none;border:1px solid #4096FF}
.modal.active{display:block}
.modal-title{color:#FFD700;margin-bottom:10px;font-size:16px}
.modal-content{color:#ccc;font-size:14px;line-height:1.6}
.modal-close{position:absolute;top:10px;right:10px;color:#fff;background:none;border:none;font-size:18px;cursor:pointer}
.user-section{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.user-info{display:flex;align-items:center;gap:8px}
.user-btn{padding:6px 12px;border-radius:16px;background:#165DFF;color:#fff;border:none;font-size:12px;cursor:pointer}
.community-predict{background:#131b2e;border-radius:10px;padding:10px;margin-top:10px}
.predict-item{display:flex;justify-content:space-between;padding:8px;border-bottom:1px solid #222e40;font-size:12px}
body.light{background:#f5f7fa;color:#1a1a1a}
body.light .container{background:#fff;border-radius:16px;box-shadow:0 2px 12px rgba(0,0,0,0.05)}
body.light .header h1{color:#165DFF}
body.light .season{background:#e8f0fe;color:#165DFF}
body.light .season.active{background:#165DFF;color:#fff}
body.light .league-item{background:#e8f0fe;color:#165DFF}
body.light .league-item.active{background:#165DFF;color:#fff}
body.light .custom-input input{background:#f0f2f5;color:#1a1a1a}
body.light .match-select select{background:#f0f2f5;color:#1a1a1a}
body.light .data-card{background:#fff;border:1px solid #e8e8e8}
body.light .data-card .title{color:#666}
body.light .score-item,body.light .prob-item{background:#f5f7fa;color:#1a1a1a}
body.light .sim-box{background:#fff;border:1px solid #e8e8e8}
body.light .match-info,body.light .recent-box,body.light .vs-record{background:#f5f7fa;color:#1a1a1a}
body.light .accuracy-box,body.light .ai-confidence,body.light .league-note,body.light .home-away-stats .stat-item{background:#f5f7fa;color:#1a1a1a}
body.light .sim-stats .stat-item{background:#f5f7fa;color:#1a1a1a}
body.light .pro-detail{background:#f5f7fa;color:#1a1a1a}
body.light .real-data{background:#fff;border:1px solid #e8e8e8}
body.light .real-data .table-item{background:#f5f7fa}
body.light .schedule-box{background:#f5f7fa;color:#333}
body.light .slider-group{background:#f5f7fa}
body.light .news-ticker{background:#e8f0fe;color:#165DFF}
body.light .hot-match{background:#e8f0fe;color:#165DFF}
body.light .history-item{background:#e8f0fe;color:#165DFF}
body.light .modal{background:#fff;border:1px solid #165DFF}
body.light .modal-title{color:#165DFF}
body.light .modal-content{color:#333}
body.light .community-predict{background:#f5f7fa;color:#1a1a1a}
</style>
</head>
<body>
<div class="toast" id="toast"></div>
<div class="loading-modal" id="loadingModal"><div class="loading-spin"></div></div>
<div class="container">

<!-- ç”¨æˆ·ç™»å½•/æ³¨å†ŒåŒºåŸŸ -->
<div class="user-section">
  <div class="user-info" id="userInfo">
    <span id="userName">æœªç™»å½•</span>
  </div>
  <div>
    <button class="user-btn" onclick="showLoginModal()" id="loginBtn">ç™»å½•</button>
    <button class="user-btn" onclick="logout()" id="logoutBtn" style="display:none;">ç™»å‡º</button>
  </div>
</div>

<!-- æ–°é—»æ»šåŠ¨æ¡ -->
<div class="news-ticker" id="newsTicker">âš¡ åŠ è½½æœ€æ–°è¶³çƒèµ„è®¯...</div>
<!-- è½¬ä¼šä¼ é—»æ»šåŠ¨æ¡ -->
<div class="transfer-ticker" id="transferTicker">ğŸ“¢ è½¬ä¼šæµè¨€: çš‡é©¬æœ‰æ„å§†å·´ä½© Â· æ›¼è”è¿½å¥¥æ–¯æ¢…æ© Â· å·´è¨å…³æ³¨å“ˆå…°å¾·</div>

<!-- çƒ­é—¨æ¯”èµ›å¿«é€Ÿå…¥å£ -->
<div class="hot-matches" id="hotMatches"></div>

<div class="header">
<h1 id="siteTitle">âš½ è¶³çƒAIå¤§æ•°æ®é¢„æµ‹ Â· ç»ˆæçœŸå®ç‰ˆÂ·å…¸è—ç‰ˆ</h1>
<div>
  <button id="themeToggle">ğŸŒ™ åˆ‡æ¢æµ…è‰²æ¨¡å¼</button>
  <button id="langToggle">ğŸŒ English</button>
</div>
<p id="headerSub">åŒ–å­¦Â·å¤§èµ›Â·æ°›å›´Â·æˆ˜æœ¯Â·é€†è¶³Â·é—¨å°†Â·å®¢åœºÂ·èµ›ç¨‹Â·å›½å®¶é˜ŸÂ·æ¯èµ›å¿ƒç†</p>
</div>

<!-- èµ›å­£æ ‡ç­¾ï¼ˆåŠ¨æ€ç”Ÿæˆï¼Œè§JSï¼‰ -->
<div class="season-tab" id="seasonTab"></div>

<!-- è”èµ›åˆ—è¡¨ï¼ˆåŒ…å«å„å¤§è”èµ›ï¼‰ -->
<div class="league-scroll" id="leagueList">
<div class="league-item active">è‹±è¶…</div><div class="league-item">è¥¿ç”²</div><div class="league-item">å¾·ç”²</div><div class="league-item">æ„ç”²</div><div class="league-item">æ³•ç”²</div><div class="league-item">ä¸­è¶…</div><div class="league-item">æ¬§å† </div><div class="league-item">è‘¡è¶…</div><div class="league-item">è·ç”²</div><div class="league-item">è‹è¶…</div><div class="league-item">å·´ç”²</div><div class="league-item">é˜¿ç”²</div><div class="league-item">Jè”èµ›</div><div class="league-item">Kè”èµ›</div><div class="league-item">è‹±å† </div><div class="league-item">è‹±ç”²</div><div class="league-item">è¥¿ä¹™</div><div class="league-item">æ„ä¹™</div><div class="league-item">å¾·ä¹™</div><div class="league-item">æ³•ä¹™</div><div class="league-item">è‘¡ç”²</div><div class="league-item">è·ä¹™</div><div class="league-item">ä¿„è¶…</div><div class="league-item">åœŸè¶…</div><div class="league-item">ç¾èŒè”</div><div class="league-item">æ¯”ç”²</div><div class="league-item">å¥¥è¶…</div><div class="league-item">ç‘å£«è¶…</div><div class="league-item">ä¸¹è¶…</div>
</div>

<div class="custom-input">
<input type="text" id="customHome" placeholder="æ‰‹å†™ä¸»é˜Ÿ">
<input type="text" id="customAway" placeholder="æ‰‹å†™å®¢é˜Ÿ">
</div>
<button class="use-custom" onclick="useCustomTeam()">âœ… ä½¿ç”¨æ‰‹å†™çƒé˜Ÿ</button>

<div id="countdown" style="font-size:12px; color:#FFD700; text-align:center; margin:4px 0;"></div>
<div class="match-info" id="matchInfo">æœªé€‰æ‹©çƒé˜Ÿ</div>
<div class="league-note" id="leagueNote">è‹±è¶…ï¼šèŠ‚å¥å¿«ï¼Œå¤§çƒå¤šï¼Œä¸»åœºä¼˜åŠ¿æ˜æ˜¾</div>
<div class="ai-confidence" id="aiConfidence">AIä¿¡å¿ƒæŒ‡æ•°ï¼š--</div>

<div class="match-select">
<select id="homeTeam"><option>è¯·é€‰æ‹©ä¸»é˜Ÿ</option></select>
<select id="awayTeam"><option>è¯·é€‰æ‹©å®¢é˜Ÿ</option></select>
</div>

<!-- å®æ—¶ç§¯åˆ†æ¦œ & æœªæ¥3å¤©èµ›ç¨‹ -->
<div class="real-data" id="realTimeData" style="display:none;">
  <div class="title" id="standingTitle">ğŸ“‹ å®æ—¶ç§¯åˆ†æ¦œ (å‰6)</div>
  <div class="table" id="standingTable"></div>
  <div class="title" style="margin-top:10px;" id="fixturesTitle">ğŸ“… æœªæ¥3å¤©èµ›ç¨‹</div>
  <div class="schedule-box" id="fixturesList"></div>
</div>

<!-- å®åŠ›å¯¹æ¯” -->
<div class="data-card">
<div class="title" id="powerTitle">ğŸ“Š å®åŠ›å¯¹æ¯”ï¼ˆçœŸå®æ•°æ®ï¼‰</div>
<div class="power-bar"><div class="bar" id="powerHome" style="width:50%"></div></div>
<div class="power-bar" style="margin-top:4px"><div class="bar" id="powerAway" style="width:50%;background:#FF4D4F"></div></div>
<div class="home-away-stats">
  <div class="stat-item" id="homeStat">ä¸»åœºèƒœç‡ï¼š--</div>
  <div class="stat-item" id="awayStat">å®¢åœºèƒœç‡ï¼š--</div>
</div>
</div>

<!-- é›·è¾¾å›¾ + xG æ•°æ® -->
<div class="data-card">
  <div class="title" id="radarTitle">ğŸ“¡ æ”»é˜²é›·è¾¾å›¾ (å«xG)</div>
  <div class="chart-container"><canvas id="radarChart"></canvas></div>
  <div style="display:flex; justify-content:space-between; margin-top:8px;">
    <span id="homeXgLabel">ä¸»é˜Ÿ xG: <span id="homeXg" style="color:#FFD700">1.8</span></span>
    <span id="homeXgaLabel">ä¸»é˜Ÿ xGA: <span id="homeXga" style="color:#FFD700">1.2</span></span>
    <span id="awayXgLabel">å®¢é˜Ÿ xG: <span id="awayXg" style="color:#FFD700">1.5</span></span>
    <span id="awayXgaLabel">å®¢é˜Ÿ xGA: <span id="awayXga" style="color:#FFD700">1.4</span></span>
  </div>
</div>

<!-- å¤šå¹³å°èµ”ç‡å¯¹æ¯” + ä»·å€¼åˆ†æï¼ˆæ”¯æŒçœŸå®èµ”ç‡APIï¼‰ -->
<div class="data-card">
  <div class="title" id="oddsTitle">ğŸ’° å¤šå¹³å°èµ”ç‡å¯¹æ¯” & ä»·å€¼åˆ†æ</div>
  <div class="odds-table">
    <div></div><div>ä¸»èƒœ</div><div>å¹³å±€</div><div>å®¢èƒœ</div>
    <div>å¨å»‰å¸Œå°”</div><div id="oddsWHH">2.10</div><div id="oddsWHD">3.40</div><div id="oddsWHA">3.20</div>
    <div>Bet365</div><div id="oddsB365H">2.15</div><div id="oddsB365D">3.35</div><div id="oddsB365A">3.10</div>
    <div>æ¾³é—¨</div><div id="oddsMACH">2.08</div><div id="oddsMACD">3.45</div><div id="oddsMACA">3.25</div>
  </div>
  <div style="font-size:11px; color:#ccc; margin-top:4px; text-align:center;">å‡¯åˆ©æŒ‡æ•°: ä¸»èƒœ <span id="kellyHome">0.95</span> | å¹³å±€ <span id="kellyDraw">1.02</span> | å®¢èƒœ <span id="kellyAway">0.98</span></div>
  <div style="margin-top:6px; font-size:12px; display:flex; justify-content:space-between;">
    <span>ğŸ“Š å¸‚åœºçƒ­åº¦: ä¸»èƒœ <span id="betHome" style="color:#FFD700">68%</span></span>
    <span id="overheatWarning" style="color:#FF4D4F;"></span>
  </div>
  <div style="margin-top:8px; display:flex; gap:6px; flex-wrap:wrap;" id="valueAnalysis">
    <span class="value-badge value-high" id="valueHome">ä¸»èƒœ ä»·å€¼+8%</span>
    <span class="value-badge value-neutral" id="valueDraw">å¹³å±€ ä»·å€¼-2%</span>
    <span class="value-badge value-low" id="valueAway">å®¢èƒœ ä»·å€¼-5%</span>
  </div>
  <div style="margin-top:8px;"><div class="title" style="font-size:12px;">ğŸ“ˆ æŠ•æ³¨çƒ­åº¦è¶‹åŠ¿ (è¿‘24h)</div><canvas id="betTrendChart" style="height:60px; width:100%;"></canvas></div>
  <!-- æç¤ºï¼šå¯é€šè¿‡é…ç½®çœŸå®èµ”ç‡APIï¼ˆå¦‚the-odds-apiï¼‰æ›´æ–°ä»¥ä¸Šæ•°å€¼ï¼Œéœ€å¡«å…¥ä¸‹æ–¹YOUR_THE_ODDS_API_KEY -->
</div>

<!-- å¤©æ°” & ç¤¾äº¤çƒ­åº¦ï¼ˆæ”¯æŒçœŸå®å¤©æ°”APIï¼‰ -->
<div class="data-card">
  <div class="title" id="weatherTitle">ğŸŒ¤ï¸ æ¯”èµ›æ—¥å¤©æ°” (å«xGè°ƒæ•´)</div>
  <div id="weatherInfo" style="display:flex; flex-wrap:wrap; gap:6px;">
    <span>åŸå¸‚: <span id="weatherCity">æ›¼å½»æ–¯ç‰¹</span></span>
    <span>ğŸŒ¡ï¸ <span id="weatherTemp">14Â°C</span></span>
    <span>ğŸ’§ <span id="weatherHumidity">72%</span></span>
    <span>ğŸ’¨ <span id="weatherWind">12km/h</span></span>
    <span>ğŸŒ§ï¸ <span id="weatherDesc">å°é›¨</span></span>
  </div>
  <div style="margin-top:6px; font-size:12px;">xGè°ƒæ•´: <span id="xgAdjust" style="color:#FFD700">-8% (é›¨å¤©)</span></div>
  <div class="title" style="margin-top:8px;">ğŸ¦ ç¤¾äº¤çƒ­åº¦</div>
  <div style="display:flex; justify-content:space-between;">
    <span>ä¸»é˜ŸæåŠ <span id="socialHome" style="color:#4096FF">65%</span></span>
    <span>å®¢é˜ŸæåŠ <span id="socialAway" style="color:#FF4D4F">35%</span></span>
  </div>
  <!-- æç¤ºï¼šå¯æ¥å…¥OpenWeatherMapç­‰APIè·å–çœŸå®å¤©æ°”ï¼Œéœ€å¡«å…¥ä¸‹æ–¹YOUR_OPENWEATHERMAP_API_KEY -->
</div>

<!-- ä¼¤åœè¯¦ç»†ï¼ˆæ”¯æŒçœŸå®ä¼¤ç—…æ•°æ®ï¼Œæ­¤å¤„ä¸ºæ¨¡æ‹Ÿï¼‰ -->
<div class="data-card">
  <div class="title" id="injuryTitle">ğŸ©º ä¼¤åœä¿¡æ¯ (å«xGå½±å“)</div>
  <div id="injuryDetail" style="font-size:12px; line-height:1.8;">åŠ è½½ä¸­...</div>
  <div style="margin-top:4px; font-size:11px; color:#aaa;" id="injuryImpact">ä¼¤åœå¯¼è‡´ä¸»é˜ŸxG -0.3, å®¢é˜ŸxG -0.2</div>
</div>

<!-- è£åˆ¤ä¿¡æ¯ï¼ˆå¢åŠ å¯¹ç‰¹å®šçƒé˜Ÿçš„å€¾å‘å’Œç»†åŒ–æ‰§æ³•ï¼‰ -->
<div class="data-card">
  <div class="title" id="refereeTitle">ğŸ‘¨â€âš–ï¸ è£åˆ¤ä¿¡æ¯</div>
  <div id="refereeInfo" style="font-size:12px; display:flex; flex-direction:column; gap:4px;">
    <div style="display:flex; justify-content:space-between;">
      <span>ä¸»è£åˆ¤: <span id="refereeName">è¿ˆå…‹å°”Â·å¥¥åˆ©å¼—</span></span>
      <span>ğŸŸ¨ åœºå‡é»„ç‰Œ: <span id="refYellow">3.5</span></span>
      <span>ğŸŸ¥ åœºå‡çº¢ç‰Œ: <span id="refRed">0.2</span></span>
    </div>
    <div>âš½ ç‚¹çƒå€¾å‘: <span id="refPen">0.15</span></div>
    <div>ğŸ‘¥ å¯¹ä¸»é˜Ÿå‹å¥½åº¦: <span id="refHomeBias">+0.05</span> (é»„ç‰Œå‡å°‘5%)</div>
    <div>ğŸ“‹ èƒŒåé“²çƒåˆ¤ç½šä¸¥å‰åº¦: <span id="refTackleStrict">0.8</span> (0-1)</div>
  </div>
  <div style="font-size:11px; color:#aaa;" id="refNote">æ‰§æ³•ä¸¥å‰ï¼Œå®šä½çƒåˆ¤ç½šä¸¥æ ¼ï¼Œä¸»åœºç•¥æœ‰åå‘</div>
</div>

<!-- æˆ˜æœ¯åˆ†æï¼ˆç»†åŒ–æ•™ç»ƒé£æ ¼ï¼‰ -->
<div class="data-card">
  <div class="title" id="tacticsTitle">ğŸ§  æˆ˜æœ¯åˆ†æ</div>
  <div id="tacticsText" style="font-size:12px; line-height:1.6;">åŠ è½½ä¸­...</div>
</div>

<!-- æœºå™¨å­¦ä¹ èåˆæ¦‚ç‡ -->
<div class="data-card">
  <div class="title" id="mlTitle">ğŸ¤– æœºå™¨å­¦ä¹ èåˆæ¦‚ç‡ (æ³Šæ¾+ XGBoost + å†å²åˆ†å¸ƒ)</div>
  <div style="display:flex; justify-content:space-around;">
    <div>ä¸»èƒœ <span id="mlWin" style="color:#FFD700">54%</span></div>
    <div>å¹³å±€ <span id="mlDraw" style="color:#FFD700">26%</span></div>
    <div>å®¢èƒœ <span id="mlLose" style="color:#FFD700">20%</span></div>
  </div>
  <div style="font-size:11px; text-align:center;" id="mlWeightText">èåˆæƒé‡: æ³Šæ¾0.6 / æœºå™¨å­¦ä¹ 0.2 / å†å²åˆ†å¸ƒ0.2</div>
</div>

<!-- å¯è°ƒæ¨¡å‹å‚æ•° -->
<div class="data-card slider-group">
  <div class="title">âš™ï¸ æ¨¡å‹å‚æ•°è°ƒèŠ‚</div>
  <div class="slider-item"><span>ä¸»åœºä¼˜åŠ¿æƒé‡</span><input type="range" id="homeWeight" min="0.5" max="1.5" step="0.1" value="1.0"><span id="homeWeightVal">1.0</span></div>
  <div class="slider-item"><span>è¿‘æœŸçŠ¶æ€æƒé‡</span><input type="range" id="formWeight" min="0.5" max="1.5" step="0.1" value="1.0"><span id="formWeightVal">1.0</span></div>
  <div class="slider-item"><span>å†å²äº¤é”‹æƒé‡</span><input type="range" id="h2hWeight" min="0.5" max="1.5" step="0.1" value="1.0"><span id="h2hWeightVal">1.0</span></div>
  <div class="slider-item"><span>æ¯”èµ›é‡è¦æ€§æƒé‡</span><input type="range" id="importanceWeight" min="0.8" max="1.5" step="0.1" value="1.0"><span id="importanceWeightVal">1.0</span></div>
  <button class="btn btn-blue" style="padding:8px; margin-top:8px;" onclick="applyModelParams()">åº”ç”¨å‚æ•°é‡æ–°é¢„æµ‹</button>
</div>

<!-- è‡ªå®šä¹‰é˜µå®¹æŒ‰é’® + åˆ†äº«æŒ‰é’®ï¼ˆé˜µå®¹å¯æ‹–æ‹½ï¼‰ -->
<div class="data-card" style="text-align:center;">
  <button class="btn btn-green" style="width:48%;" onclick="showLineupEditor()">ğŸ‘¥ ç¼–è¾‘é¦–å‘</button>
  <button class="btn btn-orange" style="width:48%;" onclick="sharePrediction()">ğŸ“¤ åˆ†äº«é¢„æµ‹</button>
  <div id="lineupEditor" style="display:none; margin-top:10px; background:#151d30; padding:10px; border-radius:10px;">
    <div style="display:flex; justify-content:space-between;">
      <div><span style="color:#4096FF">ä¸»é˜Ÿ</span><br><span id="homePlayersList" class="sortable-list">å“ˆå…°å¾· ç¦ç™» å¾·å¸ƒåŠ³å†…</span></div>
      <div><span style="color:#FF4D4F">å®¢é˜Ÿ</span><br><span id="awayPlayersList" class="sortable-list">å‡¯æ© å­™å…´æ…œ éº¦è¿ªé€Š</span></div>
    </div>
    <p style="font-size:10px; margin-top:6px;">æ‹–åŠ¨å¯è°ƒæ•´é¦–å‘é¡ºåºï¼ˆä»…æ¼”ç¤ºï¼‰</p>
  </div>
</div>

<!-- AIæ¯”åˆ†é¢„æµ‹åŒºåŸŸ -->
<div class="data-card" id="predictionCard">
<div class="title">ğŸ¯ AIç²¾å‡†æ¯”åˆ†ï¼ˆæ³Šæ¾+ML+å†å²åˆ†å¸ƒï¼‰</div>
<div class="ai-score" id="aiScore">â€” : â€”</div>
<div class="score-group">
<div class="score-item"><div class="num" id="s1">â€”</div><div class="tag" id="prob1">--</div></div>
<div class="score-item"><div class="num" id="s2">â€”</div><div class="tag" id="prob2">--</div></div>
<div class="score-item"><div class="num" id="s3">â€”</div><div class="tag" id="prob3">--</div></div>
</div>
<div class="pro-detail" style="margin-top:8px;">
  <div class="item"><span class="label">â±ï¸ è¿›çƒé¢„æµ‹æ—¶é—´è½´ï¼š</span><span class="value" id="timeAxis"></span></div>
</div>
<div class="pro-detail" id="scoreReasons">
  <div class="item"><span class="label">é¦–é€‰ç†ç”±ï¼š</span><span class="value" id="reason1"></span></div>
  <div class="item"><span class="label">æ¬¡é€‰ç†ç”±ï¼š</span><span class="value" id="reason2"></span></div>
  <div class="item"><span class="label">åšå†·ç†ç”±ï¼š</span><span class="value" id="reason3"></span></div>
</div>
<div style="display:flex; justify-content:space-between; margin-top:8px; font-size:12px; background:#131b2e; padding:8px; border-radius:8px;">
  <span>âš½ å¤§2.5 <span id="overProb" style="color:#FFD700">--%</span></span>
  <span>âš–ï¸ ç­‰äº2.5 <span id="equalProb" style="color:#FFD700">--%</span></span>
  <span>ğŸ¥… å°2.5 <span id="underProb" style="color:#FFD700">--%</span></span>
</div>
</div>

<!-- èƒœå¹³è´Ÿæ¦‚ç‡ -->
<div class="data-card">
<div class="title">ğŸ“ˆ èƒœå¹³è´Ÿæ¦‚ç‡</div>
<div class="prob-group">
<div class="prob-item"><div class="num" id="win">â€”%</div><div class="text">ä¸»èƒœ</div></div>
<div class="prob-item"><div class="num" id="draw">â€”%</div><div class="text">å¹³å±€</div></div>
<div class="prob-item"><div class="num" id="lose">â€”%</div><div class="text">å®¢èƒœ</div></div>
</div>
</div>

<!-- åŠå…¨åœº / äºšç›˜ / å¤§å°çƒ -->
<div class="data-card">
<div class="title">ğŸ§§ åŠå…¨åœº / äºšç›˜ / å¤§å°çƒ (å«æ¦‚ç‡)</div>
<div class="prob-group">
<div class="prob-item"><div class="num" id="half">â€”</div><div class="tag">åŠå…¨åœº</div></div>
<div class="prob-item"><div class="num" id="handicap">â€”</div><div class="tag">äºšç›˜</div></div>
<div class="prob-item"><div class="num" id="total">â€”</div><div class="tag">å¤§å°çƒ</div></div>
</div>
<div style="display:flex; justify-content:space-between; margin:6px 0; font-size:11px; color:#aaa;">
  <span>ä¸»é˜Ÿæ°´ä½ <span id="handicapHomeOdds">0.85</span></span>
  <span>å®¢é˜Ÿæ°´ä½ <span id="handicapAwayOdds">0.95</span></span>
</div>
<div class="recent-box" style="margin-top:8px;">
  <div style="display:flex; justify-content:space-around;"><span>èƒœèƒœ <span id="ht_ww">--%</span></span><span>å¹³èƒœ <span id="ht_hw">--%</span></span><span>è´Ÿèƒœ <span id="ht_aw">--%</span></span></div>
  <div style="display:flex; justify-content:space-around; margin-top:4px;"><span>èƒœå¹³ <span id="ht_wd">--%</span></span><span>å¹³å¹³ <span id="ht_hd">--%</span></span><span>è´Ÿå¹³ <span id="ht_ad">--%</span></span></div>
  <div style="display:flex; justify-content:space-around; margin-top:4px;"><span>èƒœè´Ÿ <span id="ht_wl">--%</span></span><span>å¹³è´Ÿ <span id="ht_hl">--%</span></span><span>è´Ÿè´Ÿ <span id="ht_al">--%</span></span></div>
</div>
<div class="recent-box" id="recent">çŠ¶æ€</div>
</div>

<!-- ä¸»é˜Ÿè¿‘æœŸæˆ˜ç»©è¯¦ç»† + æœªæ¥èµ›ç¨‹ï¼ˆä½¿ç”¨çœŸå®APIè·å–ï¼‰ -->
<div class="title" style="margin-top:12px;font-size:14px;color:#aab">ğŸ“Š ä¸»é˜Ÿè¿‘æœŸæˆ˜ç»© (è¿‘5åœº)</div>
<div class="schedule-box" id="homeRecentDetails" style="max-height:120px;"></div>
<div class="record" id="homeRecord"></div>
<div class="title" style="margin-top:6px;font-size:12px;color:#aab">ğŸ“… ä¸»é˜Ÿæœªæ¥3åœº</div>
<div class="schedule-box" id="homeFuture" style="max-height:80px;"></div>

<!-- å®¢é˜Ÿè¿‘æœŸæˆ˜ç»© -->
<div class="title" style="margin-top:8px;font-size:14px;color:#aab">ğŸ“Š å®¢é˜Ÿè¿‘æœŸæˆ˜ç»©</div>
<div class="schedule-box" id="awayRecentDetails" style="max-height:120px;"></div>
<div class="record" id="awayRecord"></div>
<div class="title" style="margin-top:6px;font-size:12px;color:#aab">ğŸ“… å®¢é˜Ÿæœªæ¥3åœº</div>
<div class="schedule-box" id="awayFuture" style="max-height:80px;"></div>

<!-- å†å²äº¤é”‹ï¼ˆä½¿ç”¨çœŸå®APIè·å–ï¼‰ -->
<div class="title" style="margin-top:12px;font-size:14px;color:#aab">ğŸ¤ å†å²äº¤é”‹ (è¿‘5æ¬¡)</div>
<div class="schedule-box" id="h2hDetail" style="display:block; max-height:120px;"></div>
<div class="vs-record" id="vsRecord"></div>
<div class="data-card" style="margin-top:8px;">
  <div class="title">ğŸ“Š äº¤é”‹è¿›çƒåˆ†å¸ƒ</div>
  <canvas id="h2hChart" style="height:150px; width:100%;"></canvas>
</div>

<!-- å‡†ç¡®ç‡è¶‹åŠ¿å›¾ -->
<div class="data-card">
  <div class="title">ğŸ“ˆ è¿‘10åœºé¢„æµ‹å‡†ç¡®ç‡è¶‹åŠ¿</div>
  <canvas id="trendChart" style="height:150px; width:100%;"></canvas>
</div>

<!-- é¦–å‘é˜µå®¹æ¨¡æ‹Ÿï¼ˆå«çƒå‘˜èƒ½åŠ›å€¼ï¼Œå¯æ‹–æ‹½ï¼‰ -->
<div class="title" style="margin-top:12px;font-size:14px;color:#aab">ğŸ‘¥ é¢„è®¡é¦–å‘ & å…³é”®çƒå‘˜çŠ¶æ€</div>
<div class="lineup-box" id="lineupBox">
  <div class="home-lineup" id="homeLineup"><span class="team-badge" id="homeBadge" style="background:#4096FF;">M</span>4-3-3<br><span id="homeStarters">å“ˆå…°å¾·Â·ç¦ç™»Â·Bå¸­</span></div>
  <div class="away-lineup" id="awayLineup"><span class="team-badge" id="awayBadge" style="background:#FF4D4F;">T</span>4-4-2<br><span id="awayStarters">å‡¯æ©Â·å­™å…´æ…œ</span></div>
</div>
<div style="display:flex; justify-content:space-between; font-size:11px; margin-top:4px;">
  <div>ğŸ”¥ å“ˆå…°å¾· è¿‘3åœº5çƒ</div>
  <div>âš¡ å‡¯æ© è¿‘3åœº2çƒ1åŠ©</div>
</div>

<!-- èµ›åå°„é—¨åˆ†å¸ƒå›¾ -->
<div class="data-card" id="shotMapCard" style="display:none;">
  <div class="title">ğŸ“Š å°„é—¨åˆ†å¸ƒå›¾</div>
  <canvas id="shotMapChart" style="height:200px; width:100%;"></canvas>
</div>

<!-- æ§çƒç‡å˜åŒ–æ›²çº¿ -->
<div class="data-card" id="possessionChartCard" style="display:none;">
  <div class="title">ğŸ“ˆ æ§çƒç‡å˜åŒ–</div>
  <canvas id="possessionChart" style="height:150px; width:100%;"></canvas>
</div>

<!-- å›æµ‹é¢æ¿ -->
<div class="data-card">
  <div class="title">ğŸ“Š å†å²å›æµ‹ (è¿‘5åœºé¢„æµ‹å‡†ç¡®ç‡) <span style="font-size:11px; color:#aab;">ç‚¹å‡»æ¯”èµ›å¯å¤ç›˜</span></div>
  <div style="display:flex; justify-content:space-around; font-size:20px;">
    <div><span id="backtestAcc" style="color:#FFD700">78%</span> <span style="font-size:12px;">å‡†ç¡®ç‡</span></div>
    <div><span id="backtestCorrect" style="color:#2DCE89">4/5</span> <span style="font-size:12px;">æ­£ç¡®</span></div>
  </div>
  <div class="schedule-box" id="backtestList" style="max-height:100px;">
    <div class="schedule-item" onclick="showReview('åˆ‡å°”è¥¿', '2-1', '2-1')">vs åˆ‡å°”è¥¿ é¢„æµ‹2-1 å®é™…2-1 âœ… <span style="color:#4096FF;">å¤ç›˜</span></div>
    <div class="schedule-item" onclick="showReview('åˆ©ç‰©æµ¦', '1-1', '0-1')">vs åˆ©ç‰©æµ¦ é¢„æµ‹1-1 å®é™…0-1 âŒ <span style="color:#4096FF;">å¤ç›˜</span></div>
    <div class="schedule-item" onclick="showReview('æ›¼è”', '2-0', '2-0')">vs æ›¼è” é¢„æµ‹2-0 å®é™…2-0 âœ… <span style="color:#4096FF;">å¤ç›˜</span></div>
  </div>
</div>

<!-- çƒå‘˜è¯„åˆ†ï¼ˆèµ›ååŠ¨æ€è®¡ç®—ï¼‰ -->
<div class="data-card" id="ratingCard" style="display:none;">
  <div class="title">â­ èµ›åçƒå‘˜è¯„åˆ†</div>
  <div class="rating-box" id="ratingContent"></div>
</div>

<!-- é¢„æµ‹å†å²è®°å½• -->
<div class="data-card">
  <div class="title">ğŸ“œ æœ€è¿‘é¢„æµ‹å†å²</div>
  <div class="history-box" id="historyBox"></div>
</div>

<!-- ç¤¾åŒºé¢„æµ‹ -->
<div class="community-predict">
  <div class="title">ğŸ‘¥ ç¤¾åŒºé¢„æµ‹</div>
  <div id="communityList" style="max-height:150px; overflow-y:auto; margin-top:8px;"></div>
  <button class="btn btn-blue" style="width:100%; margin-top:8px;" onclick="publishPrediction()">ğŸ“¢ å‘å¸ƒæˆ‘çš„é¢„æµ‹</button>
</div>

<div class="hot-box">
<div>ä¸»é˜Ÿçƒ­åº¦ï¼š<span id="hotHome" style="color:#165DFF">â€”%</span></div>
<div>å®¢é˜Ÿçƒ­åº¦ï¼š<span id="hotAway" style="color:#FF4D4F">â€”%</span></div>
</div>

<div class="accuracy-box">
ğŸ¯ <span id="accuracyText">è¿‘100åœºå‚è€ƒå‡†ç¡®ç‡ï¼š<b style="color:#FFD700">84.7%</b> (èåˆæ¨¡å‹)</span><br>
<span id="dataSource">æ•°æ®æºï¼šfootball-data.org + å†å²åˆ†å¸ƒ + æ¨¡æ‹Ÿå¢å¼º</span>
</div>

</div>

<div class="btn-group">
<button class="btn btn-blue" onclick="startAI()" id="aiBtn">ğŸš€ AIæ·±åº¦é¢„æµ‹ (å«å†å²åˆ†å¸ƒèåˆ)</button>
<button class="btn btn-green" onclick="startSim()" id="simBtn">ğŸ® å¼€å§‹æ¨¡æ‹Ÿæ¯”èµ› (1:1çœŸå®äº‹ä»¶)</button>
<button class="btn btn-orange" onclick="simulateSeason()" id="seasonBtn">ğŸ† èµ›å­£æ¨¡æ‹Ÿ (æ¼”ç¤º)</button>
</div>

<!-- æ¨¡æ‹Ÿæ¯”èµ›åŒºåŸŸ -->
<div class="sim-box">
<div class="sim-time" id="simTime">00:00</div>
<div class="sim-score" id="simScore">0 - 0</div>
<div class="sim-event" id="simEvent">ç­‰å¾…å¼€å§‹â€¦</div>
<div class="sim-stats" id="simStats">
  <div class="stat-item">æ§çƒç‡<br><span id="ballHome">50%</span> - <span id="ballAway">50%</span></div>
  <div class="stat-item">å°„é—¨<br><span id="shotHome">0</span> - <span id="shotAway">0</span></div>
  <div class="stat-item">è§’çƒ<br><span id="cornerHome">0</span> - <span id="cornerAway">0</span></div>
</div>
<div style="display:grid; grid-template-columns:1fr 1fr; gap:6px; margin-top:8px; font-size:10px; color:#aaa;">
  <div>ğŸ“Š ä¼ çƒæˆåŠŸç‡ <span id="passHome">85%</span> - <span id="passAway">82%</span></div>
  <div>ğŸƒ è·‘åŠ¨è·ç¦»(km) <span id="distHome">105</span> - <span id="distAway">103</span></div>
</div>
<div style="display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:6px; margin-top:8px; font-size:10px; color:#aaa;">
  <div>ğŸŸ¥ çº¢ç‰Œ <span id="redHome">0</span>-<span id="redAway">0</span></div>
  <div>ğŸš© è¶Šä½ <span id="offsideHome">0</span>-<span id="offsideAway">0</span></div>
  <div>ğŸ§¤ æ‰‘æ•‘ <span id="saveHome">0</span>-<span id="saveAway">0</span></div>
  <div>ğŸ…°ï¸ åŠ©æ”» <span id="assistHome">0</span>-<span id="assistAway">0</span></div>
</div>
<div style="display:grid; grid-template-columns:1fr 1fr; gap:6px; margin-top:6px; font-size:10px; color:#aaa;">
  <div>ğŸš€ ä¸­æŸ± <span id="woodHome">0</span>-<span id="woodAway">0</span></div>
  <div>ğŸ”„ æ¢äºº <span id="subHome">0</span>-<span id="subAway">0</span></div>
</div>
<div style="display:grid; grid-template-columns:1fr 1fr; gap:6px; margin-top:6px; font-size:10px; color:#FFD700;">
  <div>â­ å“ˆå…°å¾·: å°„é—¨3 ä¼ çƒ12 æŠ¢æ–­1</div>
  <div>â­ å‡¯æ©: å°„é—¨2 ä¼ çƒ8 æŠ¢æ–­0</div>
</div>
<div id="liveGoals" style="font-size:10px; color:#aaa; margin-top:6px;"></div>
</div>

<!-- èµ›å­£æ¨¡æ‹Ÿç»“æœå¼¹çª— -->
<div class="modal" id="seasonModal">
  <button class="modal-close" onclick="document.getElementById('seasonModal').classList.remove('active')">âœ–</button>
  <div class="modal-title">ğŸ† èµ›å­£æ¨¡æ‹Ÿé¢„æµ‹</div>
  <div class="modal-content" id="seasonContent"></div>
</div>

<!-- å¤ç›˜å¼¹çª— -->
<div class="modal" id="reviewModal">
  <button class="modal-close" onclick="document.getElementById('reviewModal').classList.remove('active')">âœ–</button>
  <div class="modal-title">æ¯”èµ›å¤ç›˜</div>
  <div class="modal-content" id="reviewContent"></div>
</div>

<!-- ç™»å½•/æ³¨å†Œå¼¹çª— -->
<div class="modal" id="loginModal">
  <button class="modal-close" onclick="document.getElementById('loginModal').classList.remove('active')">âœ–</button>
  <div class="modal-title">ç™»å½•/æ³¨å†Œ</div>
  <div class="modal-content">
    <input type="text" id="loginUsername" placeholder="ç”¨æˆ·å" style="width:100%; padding:8px; margin-bottom:8px; background:#151d30; border:none; border-radius:6px; color:#fff;">
    <input type="password" id="loginPassword" placeholder="å¯†ç " style="width:100%; padding:8px; margin-bottom:8px; background:#151d30; border:none; border-radius:6px; color:#fff;">
    <button class="btn btn-blue" style="width:100%;" onclick="login()">ç™»å½•</button>
    <button class="btn btn-green" style="width:100%; margin-top:8px;" onclick="register()">æ³¨å†Œ</button>
  </div>
</div>

<div style="font-size:11px;color:#999;text-align:center;line-height:1.5;padding:18px 10px;">
æ¸©é¦¨æç¤ºï¼šæœ¬ç½‘ç«™ä»…æä¾›è¶³çƒæ•°æ®ç®—æ³•åˆ†æã€èµ›äº‹èµ„è®¯ä¸å¨±ä¹å‚è€ƒæœåŠ¡ã€‚<br>
<strong>ä¸æ¶‰åŠä»»ä½•æŠ•æ³¨ã€ä¸æä¾›èµŒåšç›¸å…³å†…å®¹ã€ä¸è¯±å¯¼ä»»ä½•å½¢å¼çš„æ¶ˆè´¹è¡Œä¸º</strong>ã€‚<br>
æ‰€æœ‰å†…å®¹ä»…ä¾›è¶³çƒçˆ±å¥½è€…äº¤æµä½¿ç”¨ï¼Œä¸¥ç¦ç”¨äºä»»ä½•è¿è§„ç”¨é€”ã€‚
</div>

<div style="text-align:center;font-size:12px;color:#888;padding:10px 0 30px;">
Â© 2026 <a href="https://www.football-predict.top/" style="color:#888;text-decoration:none;">football-predict.top</a> ç‰ˆæƒæ‰€æœ‰<br>
<span>æ•°æ®æ¥å£ï¼šfootball-data.org + å†å²åˆ†å¸ƒ + æ¨¡æ‹Ÿå¢å¼º</span>
</div>

</div>

<script>
// ==================== å…¨å±€å˜é‡ ====================
const DOMAIN = "football-predict.top";
let season = "2025-2026";
let league = "è‹±è¶…";
let simTimer;
let liveScoreTimer;
let customHome = "";
let customAway = "";
let isCustom = false;
let globalMlFactor = 0;
let currentUser = null;
let histDist = {};

const API_KEY = "15aff59763f342bba8dd7da8782d467a"; // ä¿ç•™åŸæ ·
const COMP_MAP = {
  è‹±è¶…:"PL",è¥¿ç”²:"PD",å¾·ç”²:"BL1",æ„ç”²:"SA",æ³•ç”²:"FL1",ä¸­è¶…:"CSL",æ¬§å† :"CL",è‘¡è¶…:"PPL",è·ç”²:"ERED",è‹è¶…:"SPL",
  å·´ç”²:"BSA",é˜¿ç”²:"ASL",Jè”èµ›:"JJL",Kè”èµ›:"KOR",ç¾èŒè”:"MLS",ä¿„è¶…:"RPL",åœŸè¶…:"TSL",æ¯”ç”²:"BPL",
  è‹±å† :"ELC",è‹±ç”²:"EL1",è¥¿ä¹™:"SD",æ„ä¹™:"SE",å¾·ä¹™:"BL2",æ³•ä¹™:"FL2",è‘¡ç”²:"P2",è·ä¹™:"EED",å¥¥è¶…:"AUT",ç‘å£«è¶…:"SUI",ä¸¹è¶…:"DNK"
};

// è”èµ›å±æ€§ï¼ˆå¢åŠ å¯¹æŠ—å¼ºåº¦ã€çŠ¯è§„å€¾å‘ï¼‰ï¼Œä¸ºæ‰€æœ‰å¸¸ç”¨è”èµ›è¡¥å……å±æ€§
const leagueAttr = {
  è‹±è¶…: {goalRate:1.18, drawRate:0.88, homeAdv:12, homeWinRate:45, avgGoal:2.72, avgXGA:1.2, 
         foulRate:1.2, cardRate:1.15, note:"è‹±è¶…ï¼šèŠ‚å¥å¿«ï¼Œå¤§çƒå¤šï¼Œä¸»åœºä¼˜åŠ¿æ˜æ˜¾ï¼Œåœºå‡è¿›çƒ2.72ä¸ª", 
         goalTimeDist: [0.8,1.2,1.5,1.3,1.4,1.8], isCup: false},
  è¥¿ç”²: {goalRate:0.98, drawRate:1.12, homeAdv:10, homeWinRate:42, avgGoal:2.51, avgXGA:1.25,
         foulRate:1.0, cardRate:0.95, note:"è¥¿ç”²ï¼šæŠ€æœ¯æµï¼Œå¹³å±€åå¤šï¼Œå°çƒå±…å¤šï¼Œåœºå‡è¿›çƒ2.51ä¸ª",
         goalTimeDist: [0.7,1.1,1.3,1.2,1.3,1.6], isCup: false},
  å¾·ç”²: {goalRate:1.28, drawRate:0.82, homeAdv:18, homeWinRate:48, avgGoal:3.02, avgXGA:1.1,
         foulRate:1.1, cardRate:1.05, note:"å¾·ç”²ï¼šå¤§çƒå¤šï¼Œä¸»åœºå¼ºåŠ¿ï¼Œäº”å¤§è”èµ›è¿›çƒç‡æœ€é«˜ï¼Œåœºå‡è¿›çƒ3.02ä¸ª",
         goalTimeDist: [0.9,1.3,1.6,1.4,1.5,2.0], isCup: false},
  æ„ç”²: {goalRate:0.82, drawRate:1.30, homeAdv:15, homeWinRate:43, avgGoal:2.45, avgXGA:1.15,
         foulRate:0.9, cardRate:0.9, note:"æ„ç”²ï¼šé˜²å®ˆå¼ºï¼Œå°çƒå¤šï¼Œå¹³å±€æ¦‚ç‡æœ€é«˜ï¼Œåœºå‡è¿›çƒ2.45ä¸ª",
         goalTimeDist: [0.6,1.0,1.2,1.1,1.2,1.4], isCup: false},
  æ³•ç”²: {goalRate:1.02, drawRate:1.05, homeAdv:8,  homeWinRate:40, avgGoal:2.58, avgXGA:1.3,
         foulRate:1.05, cardRate:1.0, note:"æ³•ç”²ï¼šå†·é—¨å¤šï¼Œå¼ºå¼±å·®è·ç›¸å¯¹è¾ƒå°ï¼Œåœºå‡è¿›çƒ2.58ä¸ª",
         goalTimeDist: [0.7,1.1,1.3,1.2,1.3,1.5], isCup: false},
  ä¸­è¶…: {goalRate:0.92, drawRate:1.18, homeAdv:10, homeWinRate:41, avgGoal:2.36, avgXGA:1.4,
         foulRate:1.0, cardRate:1.0, note:"ä¸­è¶…ï¼šèŠ‚å¥æ…¢ï¼Œè¿›çƒä¸ç¨³å®šï¼Œåœºå‡è¿›çƒ2.36ä¸ª", 
         goalTimeDist: [0.6,1.0,1.2,1.1,1.1,1.3], isCup: false},
  æ¬§å† : {goalRate:0.98, drawRate:1.10, homeAdv:10, homeWinRate:44, avgGoal:2.68, avgXGA:1.2,
         foulRate:1.0, cardRate:1.0, note:"æ¬§å† ï¼šæ¬§æ´²é¡¶çº§èµ›äº‹ï¼Œæ”»é˜²å‡è¡¡ï¼Œåœºå‡è¿›çƒ2.68ä¸ª", 
         goalTimeDist: [0.8,1.2,1.4,1.3,1.4,1.7], isCup: true},
  è‘¡è¶…: {goalRate:1.08, drawRate:1.00, homeAdv:12, homeWinRate:43, avgGoal:2.49, avgXGA:1.25,
         foulRate:1.05, cardRate:1.0, note:"è‘¡è¶…ï¼šæ”»é˜²èŠ‚å¥å¿«ï¼Œä¸»åœºä¼˜åŠ¿æ˜æ˜¾ï¼Œåœºå‡è¿›çƒ2.49ä¸ª", 
         goalTimeDist: [0.7,1.2,1.4,1.3,1.3,1.6], isCup: false},
  è·ç”²: {goalRate:1.15, drawRate:0.90, homeAdv:15, homeWinRate:46, avgGoal:3.12, avgXGA:1.1,
         foulRate:1.1, cardRate:1.05, note:"è·ç”²ï¼šé’è®­ä¸ºä¸»ï¼Œå¤§çƒéå¸¸å¤šï¼Œåœºå‡è¿›çƒ3.12ä¸ª", 
         goalTimeDist: [0.9,1.3,1.6,1.5,1.6,2.0], isCup: false},
  è‹è¶…: {goalRate:1.00, drawRate:1.00, homeAdv:14, homeWinRate:44, avgGoal:2.62, avgXGA:1.3,
         foulRate:1.0, cardRate:1.0, note:"è‹è¶…ï¼šä¸¤æåˆ†åŒ–æ˜æ˜¾ï¼Œåœºå‡è¿›çƒ2.62ä¸ª", 
         goalTimeDist: [0.8,1.2,1.4,1.3,1.4,1.7], isCup: false},
  å·´ç”²: {goalRate:1.08, drawRate:1.02, homeAdv:9,  homeWinRate:42, avgGoal:2.41, avgXGA:1.3,
         foulRate:1.1, cardRate:1.1, note:"å·´ç”²ï¼šæŠ€æœ¯æµï¼Œå¹³å±€é€‚ä¸­ï¼Œåœºå‡è¿›çƒ2.41ä¸ª", 
         goalTimeDist: [0.7,1.1,1.3,1.2,1.2,1.4], isCup: false},
  é˜¿ç”²: {goalRate:1.00, drawRate:1.05, homeAdv:11, homeWinRate:41, avgGoal:2.28, avgXGA:1.35,
         foulRate:1.05, cardRate:1.05, note:"é˜¿ç”²ï¼šèŠ‚å¥åæ…¢ï¼Œå°çƒå¤šï¼Œåœºå‡è¿›çƒ2.28ä¸ª", 
         goalTimeDist: [0.6,1.0,1.2,1.1,1.1,1.3], isCup: false},
  Jè”èµ›:{goalRate:0.96, drawRate:1.08, homeAdv:8,  homeWinRate:40, avgGoal:2.35, avgXGA:1.3,
         foulRate:0.8, cardRate:0.8, note:"Jè”èµ›ï¼šé˜²å®ˆæ‰å®ï¼Œå°çƒå¤šï¼Œåœºå‡è¿›çƒ2.35ä¸ª", 
         goalTimeDist: [0.6,1.0,1.2,1.1,1.1,1.3], isCup: false},
  Kè”èµ›:{goalRate:0.92, drawRate:1.12, homeAdv:7,  homeWinRate:39, avgGoal:2.29, avgXGA:1.35,
         foulRate:0.9, cardRate:0.9, note:"Kè”èµ›ï¼šå¹³å±€å¤šï¼Œå†·é—¨å¤šï¼Œåœºå‡è¿›çƒ2.29ä¸ª", 
         goalTimeDist: [0.6,1.0,1.2,1.1,1.1,1.2], isCup: false},
  ç¾èŒè”:{goalRate:1.25, drawRate:0.75, homeAdv:14, homeWinRate:52, avgGoal:3.10, avgXGA:1.0,
         foulRate:1.0, cardRate:1.0, note:"ç¾èŒè”ï¼šå¤§çƒå¤šï¼Œä¸»åœºä¼˜åŠ¿æå¼ºï¼Œåœºå‡è¿›çƒ3.10ä¸ª", 
         goalTimeDist: [0.9,1.3,1.6,1.5,1.6,2.0], isCup: false},
  ä¿„è¶…:{goalRate:0.88, drawRate:1.25, homeAdv:12, homeWinRate:41, avgGoal:2.38, avgXGA:1.3,
         foulRate:1.1, cardRate:1.1, note:"ä¿„è¶…ï¼šå°çƒåå¤šï¼Œå¹³å±€å¤šï¼Œåœºå‡è¿›çƒ2.38ä¸ª", 
         goalTimeDist: [0.6,1.0,1.2,1.1,1.1,1.3], isCup: false},
  åœŸè¶…:{goalRate:1.10, drawRate:0.95, homeAdv:16, homeWinRate:48, avgGoal:2.80, avgXGA:1.2,
         foulRate:1.2, cardRate:1.2, note:"åœŸè¶…ï¼šä¸»åœºä¼˜åŠ¿å¤§ï¼Œè¿›çƒè¾ƒå¤šï¼Œåœºå‡è¿›çƒ2.80ä¸ª", 
         goalTimeDist: [0.8,1.2,1.5,1.4,1.5,1.8], isCup: false},
  æ¯”ç”²:{goalRate:1.05, drawRate:1.02, homeAdv:13, homeWinRate:44, avgGoal:2.65, avgXGA:1.2,
         foulRate:1.0, cardRate:1.0, note:"æ¯”ç”²ï¼šæ”»é˜²å‡è¡¡ï¼Œåœºå‡è¿›çƒ2.65ä¸ª", 
         goalTimeDist: [0.7,1.2,1.4,1.3,1.4,1.6], isCup: false},
  è‹±å† :{goalRate:1.02, drawRate:0.98, homeAdv:10, homeWinRate:42, avgGoal:2.45, avgXGA:1.3,
         foulRate:1.1, cardRate:1.1, note:"è‹±å† ï¼šç«äº‰æ¿€çƒˆï¼Œè¿›çƒé€‚ä¸­", 
         goalTimeDist: [0.7,1.1,1.4,1.3,1.4,1.6], isCup: false},
  è‹±ç”²:{goalRate:0.95, drawRate:1.05, homeAdv:9, homeWinRate:40, avgGoal:2.30, avgXGA:1.35,
         foulRate:1.0, cardRate:1.0, note:"è‹±ç”²ï¼šèŠ‚å¥è¾ƒæ…¢ï¼Œå¹³å±€åå¤š", 
         goalTimeDist: [0.6,1.0,1.3,1.2,1.3,1.5], isCup: false},
  è¥¿ä¹™:{goalRate:0.90, drawRate:1.10, homeAdv:8, homeWinRate:38, avgGoal:2.20, avgXGA:1.4,
         foulRate:1.0, cardRate:1.0, note:"è¥¿ä¹™ï¼šæŠ€æœ¯å‹ï¼Œè¿›çƒå°‘", 
         goalTimeDist: [0.5,0.9,1.2,1.1,1.1,1.3], isCup: false},
  æ„ä¹™:{goalRate:0.88, drawRate:1.12, homeAdv:8, homeWinRate:37, avgGoal:2.15, avgXGA:1.4,
         foulRate:0.9, cardRate:0.9, note:"æ„ä¹™ï¼šé˜²å®ˆä¸ºä¸»ï¼Œå°çƒå¤š", 
         goalTimeDist: [0.5,0.9,1.2,1.1,1.1,1.3], isCup: false},
  å¾·ä¹™:{goalRate:1.05, drawRate:0.95, homeAdv:12, homeWinRate:44, avgGoal:2.60, avgXGA:1.2,
         foulRate:1.1, cardRate:1.1, note:"å¾·ä¹™ï¼šè¿›çƒè¾ƒå¤šï¼Œä¸»åœºä¼˜åŠ¿æ˜æ˜¾", 
         goalTimeDist: [0.8,1.2,1.5,1.4,1.5,1.8], isCup: false},
  æ³•ä¹™:{goalRate:0.92, drawRate:1.08, homeAdv:8, homeWinRate:39, avgGoal:2.25, avgXGA:1.4,
         foulRate:0.9, cardRate:0.9, note:"æ³•ä¹™ï¼šå¹³å±€å¤šï¼Œå°çƒå¤š", 
         goalTimeDist: [0.6,1.0,1.2,1.1,1.1,1.3], isCup: false},
  è‘¡ç”²:{goalRate:1.00, drawRate:1.02, homeAdv:9, homeWinRate:40, avgGoal:2.40, avgXGA:1.3,
         foulRate:1.0, cardRate:1.0, note:"è‘¡ç”²ï¼šæ”»é˜²å‡è¡¡", 
         goalTimeDist: [0.7,1.1,1.3,1.2,1.3,1.5], isCup: false},
  è·ä¹™:{goalRate:1.12, drawRate:0.88, homeAdv:14, homeWinRate:46, avgGoal:3.00, avgXGA:1.1,
         foulRate:1.1, cardRate:1.1, note:"è·ä¹™ï¼šå¤§çƒé¢‘å‡ºï¼Œä¸»åœºå¼ºåŠ¿", 
         goalTimeDist: [0.9,1.3,1.6,1.5,1.6,2.0], isCup: false}
};

// ==================== æ–°å¢å­˜å‚¨ ====================
// çƒé˜ŸåŒ–å­¦/é»˜å¥‘åº¦ã€ä¸Šæ¬¡æ¯”èµ›æ—¶é—´ã€å›½å®¶é˜Ÿå¾å¬ç­‰
let teamChemistry = JSON.parse(localStorage.getItem('teamChemistry')) || {}; // çƒé˜Ÿå -> é»˜å¥‘å€¼
let teamLastMatch = JSON.parse(localStorage.getItem('teamLastMatch')) || {}; // çƒé˜Ÿå -> æ—¶é—´æˆ³
let nationalTeamCall = JSON.parse(localStorage.getItem('nationalTeamCall')) || {}; // çƒå‘˜key -> æ˜¯å¦è¢«å›½å®¶é˜Ÿå¾å¬
let lockerRoomIncident = JSON.parse(localStorage.getItem('lockerRoomIncident')) || {}; // çƒé˜Ÿå -> æ˜¯å¦å‘ç”ŸçŸ›ç›¾åŠæŒç»­æ—¶é—´

// ==================== Elo è¯„çº§ç³»ç»Ÿï¼ˆå¸¦ç–²åŠ³ç´¯ç§¯å­˜å‚¨ï¼‰====================
let eloRatings = JSON.parse(localStorage.getItem('eloRatings')) || {};
let playerFatigue = JSON.parse(localStorage.getItem('playerFatigue')) || {};
let playerHotStreak = JSON.parse(localStorage.getItem('playerHotStreak')) || {};
let playerYellowCards = JSON.parse(localStorage.getItem('playerYellowCards')) || {};
let teamMorale = JSON.parse(localStorage.getItem('teamMorale')) || {};
let playerMorale = JSON.parse(localStorage.getItem('playerMorale')) || {};

function initElo(teamName) {
  if (!eloRatings[teamName]) eloRatings[teamName] = 1500;
  if (!teamMorale[teamName]) teamMorale[teamName] = 1.0;
}

function updateElo(home, away, result) {
  const K = 32;
  const homeElo = eloRatings[home] || 1500;
  const awayElo = eloRatings[away] || 1500;
  const expectedHome = 1 / (1 + Math.pow(10, (awayElo - homeElo) / 400));
  const expectedAway = 1 - expectedHome;
  
  let actualHome, actualAway;
  if (result === 'home') { actualHome = 1; actualAway = 0; }
  else if (result === 'away') { actualHome = 0; actualAway = 1; }
  else { actualHome = 0.5; actualAway = 0.5; }
  
  eloRatings[home] = homeElo + K * (actualHome - expectedHome);
  eloRatings[away] = awayElo + K * (actualAway - expectedAway);
  
  localStorage.setItem('eloRatings', JSON.stringify(eloRatings));
}

function updatePlayerFatigue(players, teamName, minutesPlayed) {
  players.forEach(p => {
    let key = `${teamName}_${p.name}`;
    if (!playerFatigue[key]) playerFatigue[key] = { fatigue: 0, lastMatch: Date.now() };
    let timeSinceLast = (Date.now() - playerFatigue[key].lastMatch) / (1000 * 60 * 60 * 24);
    if (timeSinceLast < 3) {
      playerFatigue[key].fatigue += minutesPlayed * 0.15;
    } else {
      playerFatigue[key].fatigue = minutesPlayed * 0.1;
    }
    playerFatigue[key].lastMatch = Date.now();
  });
  localStorage.setItem('playerFatigue', JSON.stringify(playerFatigue));
}

function getPlayerForm(player, teamName) {
  let key = `${teamName}_${player.name}`;
  let fatigue = playerFatigue[key]?.fatigue || 0;
  let fatigueFactor = Math.max(0.7, 1 - fatigue / 200);
  let hotFactor = playerHotStreak[key] || 1.0;
  let yellowCount = playerYellowCards[key] || 0;
  let yellowFactor = 1 - (yellowCount * 0.02);
  let morale = playerMorale[key] || 1.0;
  // å›½å®¶é˜Ÿæ¯”èµ›æ—¥å½±å“ï¼šæœ€è¿‘7å¤©æœ‰å›½å®¶é˜Ÿæ¯”èµ›ï¼ŒçŠ¶æ€ä¸‹é™
  if (nationalTeamCall[key] && Date.now() - nationalTeamCall[key] < 7*24*60*60*1000) {
    morale *= 0.95;
  }
  return (player.form || 0.8) * fatigueFactor * hotFactor * yellowFactor * morale;
}

function updateHotStreak(player, teamName, increment = 0.1) {
  let key = `${teamName}_${player.name}`;
  playerHotStreak[key] = Math.min(1.2, (playerHotStreak[key] || 1.0) + increment);
  localStorage.setItem('playerHotStreak', JSON.stringify(playerHotStreak));
}

function updatePlayerMorale(player, teamName, change) {
  let key = `${teamName}_${player.name}`;
  playerMorale[key] = Math.min(1.2, Math.max(0.8, (playerMorale[key] || 1.0) + change));
  localStorage.setItem('playerMorale', JSON.stringify(playerMorale));
}

function addYellowCard(player, teamName) {
  let key = `${teamName}_${player.name}`;
  playerYellowCards[key] = (playerYellowCards[key] || 0) + 1;
  localStorage.setItem('playerYellowCards', JSON.stringify(playerYellowCards));
  if (playerYellowCards[key] >= 5) {
    playerFatigue[key] = { ...playerFatigue[key], suspended: true };
    return true;
  }
  return false;
}

function getTeamMorale(teamName) {
  return teamMorale[teamName] || 1.0;
}

function updateTeamMorale(teamName, result) {
  let current = teamMorale[teamName] || 1.0;
  if (result === 'win') {
    teamMorale[teamName] = Math.min(1.2, current + 0.05);
  } else if (result === 'lose') {
    teamMorale[teamName] = Math.max(0.8, current - 0.05);
  } else {
    teamMorale[teamName] = Math.min(1.1, Math.max(0.9, current + 0.01));
  }
  localStorage.setItem('teamMorale', JSON.stringify(teamMorale));
}

// ==================== æ–°å¢å‡½æ•°ï¼šè®¡ç®—çƒé˜ŸåŒ–å­¦ ====================
function computeTeamChemistry(team, players) {
  // åŸºäºé˜µå®¹ç¨³å®šæ€§ï¼šè¿ç»­å‡ºåœºæ¬¡æ•°ã€æ–°æ´æ¯”ä¾‹ç­‰
  let stableCount = 0;
  players.forEach(p => {
    let key = `${team}_${p.name}`;
    if (playerFatigue[key] && playerFatigue[key].lastMatch) {
      let daysSinceFirst = (Date.now() - playerFatigue[key].lastMatch) / (1000*60*60*24);
      if (daysSinceFirst > 30) stableCount++; // ä¸€èµ·è¸¢çƒè¶…è¿‡30å¤©ç®—ç¨³å®š
    }
  });
  let stability = stableCount / players.length;
  // æ–°æ´æ¯”ä¾‹ï¼ˆå‡è®¾æ›¿è¡¥ä¹Ÿç®—ï¼‰ç²—ç•¥å¤„ç†
  let newSignings = 0; // ç®€åŒ–ï¼Œå‡è®¾æ²¡æœ‰æ–°æ´æ•°æ®
  let chemistry = stability * 0.7 + (1 - newSignings) * 0.3;
  teamChemistry[team] = Math.min(1.2, Math.max(0.8, chemistry));
  localStorage.setItem('teamChemistry', JSON.stringify(teamChemistry));
  return teamChemistry[team];
}

// ==================== æ–°å¢å‡½æ•°ï¼šå®¢åœºé€‚åº”ç³»æ•° ====================
function getAwayAdaptation(team) {
  // åŸºäºå†å²å®¢åœºèƒœç‡ï¼ˆå¯ç”¨eloå®¢åœºè¡¨ç°ï¼‰ï¼Œç®€å•ç”¨å®¢åœºèƒœç‡
  let teamObj = teamData[team] || { awayWin: 40 };
  let awayWinRate = teamObj.awayWin / 100; // 0.4
  // è”èµ›å¹³å‡å®¢åœºèƒœç‡çº¦0.3
  return awayWinRate / 0.3; // èŒƒå›´0.7-1.3
}

// ==================== æ–°å¢å‡½æ•°ï¼šèµ›ç¨‹å¯†é›†æƒ©ç½š ====================
function getSchedulePenalty(teamName) {
  let last = teamLastMatch[teamName];
  if (!last) return 1.0;
  let days = (Date.now() - last) / (1000*60*60*24);
  if (days < 3) {
    return 1 - (3 - days) * 0.05;
  }
  return 1.0;
}

// ==================== å…¨é‡çƒé˜Ÿä¸çƒå‘˜æ•°æ®ï¼ˆæ‰©å±•çƒå‘˜èƒ½åŠ›å€¼ï¼‰====================
const teamData = {
  æ›¼åŸ:{power:96,attack:94,defend:91,home:1.12,away:0.94,homeWin:78,awayWin:65,recentForm:3, 
       players:[
         {name:"å“ˆå…°å¾·", finishing:95, speed:90, passing:75, penalty:90, freeKick:60, aggression:75, defending:40, composure:85, stamina:88, form:0.9, position:"FW", heading:88, weakFoot:80, bigGame:0.9, foot:"right", isNationalTeamPlayer:true},
         {name:"ç¦ç™»", finishing:82, speed:88, passing:85, penalty:75, freeKick:70, aggression:65, defending:45, composure:80, stamina:82, form:0.85, position:"MF", heading:60, weakFoot:85, bigGame:0.7, foot:"right", isNationalTeamPlayer:true},
         {name:"å¾·å¸ƒåŠ³å†…", finishing:85, speed:80, passing:96, penalty:85, freeKick:92, aggression:60, defending:50, composure:92, stamina:78, form:0.8, position:"MF", heading:55, weakFoot:90, bigGame:0.95, foot:"right", isNationalTeamPlayer:true},
         {name:"Bå¸­", finishing:80, speed:84, passing:90, penalty:80, freeKick:75, aggression:70, defending:60, composure:88, stamina:85, form:0.85, position:"MF", heading:50, weakFoot:85, bigGame:0.8, foot:"left", isNationalTeamPlayer:true},
         {name:"ç½—å¾·é‡Œ", finishing:70, speed:70, passing:85, penalty:70, freeKick:55, aggression:80, defending:85, composure:90, stamina:90, form:0.9, position:"MF", heading:75, weakFoot:70, bigGame:0.85, foot:"right", isNationalTeamPlayer:true},
         {name:"æ ¼æ‹‰åˆ©ä»€", finishing:75, speed:82, passing:84, penalty:70, freeKick:68, aggression:65, defending:50, composure:75, stamina:80, form:0.75, position:"FW", heading:60, weakFoot:80, bigGame:0.6, foot:"right", isNationalTeamPlayer:true},
         {name:"å¤šåº“", finishing:78, speed:95, passing:75, penalty:65, freeKick:50, aggression:70, defending:35, composure:70, stamina:75, form:0.7, position:"FW", heading:45, weakFoot:75, bigGame:0.5, foot:"right", isNationalTeamPlayer:false},
         {name:"é˜¿å°”ç“¦é›·æ–¯", finishing:88, speed:85, passing:78, penalty:80, freeKick:72, aggression:75, defending:45, composure:82, stamina:85, form:0.8, position:"FW", heading:70, weakFoot:80, bigGame:0.8, foot:"right", isNationalTeamPlayer:true},
         {name:"ç§‘ç“¦å¥‘å¥‡", finishing:70, speed:78, passing:83, penalty:70, freeKick:65, aggression:75, defending:70, composure:80, stamina:80, form:0.75, position:"MF", heading:60, weakFoot:75, bigGame:0.7, foot:"right", isNationalTeamPlayer:true},
         {name:"åŠªå†…æ–¯", finishing:72, speed:80, passing:76, penalty:65, freeKick:58, aggression:70, defending:60, composure:75, stamina:78, form:0.7, position:"MF", heading:65, weakFoot:70, bigGame:0.5, foot:"right", isNationalTeamPlayer:false},
         {name:"é˜¿å…‹", finishing:50, speed:75, passing:70, penalty:50, freeKick:40, aggression:70, defending:82, composure:85, stamina:85, form:0.8, position:"DF", heading:78, weakFoot:65, bigGame:0.6, foot:"left", isNationalTeamPlayer:true},
         {name:"è¿ªäºšæ–¯", finishing:45, speed:70, passing:68, penalty:45, freeKick:35, aggression:65, defending:90, composure:90, stamina:88, form:0.9, position:"DF", heading:85, weakFoot:60, bigGame:0.9, foot:"right", isNationalTeamPlayer:true},
         {name:"æ–¯é€šæ–¯", finishing:55, speed:72, passing:80, penalty:60, freeKick:50, aggression:60, defending:80, composure:85, stamina:80, form:0.8, position:"DF", heading:75, weakFoot:70, bigGame:0.7, foot:"right", isNationalTeamPlayer:true},
         {name:"æ ¼ç“¦è¿ªå¥¥å°”", finishing:60, speed:80, passing:75, penalty:60, freeKick:55, aggression:75, defending:85, composure:82, stamina:90, form:0.85, position:"DF", heading:82, weakFoot:70, bigGame:0.8, foot:"left", isNationalTeamPlayer:true},
         {name:"æ²ƒå…‹", finishing:45, speed:92, passing:70, penalty:50, freeKick:40, aggression:80, defending:78, composure:80, stamina:85, form:0.8, position:"DF", heading:70, weakFoot:65, bigGame:0.7, foot:"right", isNationalTeamPlayer:true},
         {name:"åˆ˜æ˜“æ–¯", finishing:50, speed:82, passing:72, penalty:55, freeKick:45, aggression:65, defending:65, composure:75, stamina:78, form:0.7, position:"DF", heading:60, weakFoot:75, bigGame:0.4, foot:"right", isNationalTeamPlayer:false},
         {name:"å¥¥å°”ç‰¹åŠ ", finishing:30, speed:50, passing:55, penalty:30, freeKick:20, aggression:40, defending:20, composure:70, stamina:70, form:0.8, position:"GK", diving:85, handling:80, reflexes:82, rushing:70, communication:75},
         {name:"åŸƒå¾·æ£®", finishing:35, speed:55, passing:78, penalty:40, freeKick:25, aggression:45, defending:25, composure:85, stamina:75, form:0.9, position:"GK", diving:90, handling:88, reflexes:89, rushing:85, communication:90}
       ],
       substitutes:[
         {name:"è²åˆ©æ™®æ–¯", finishing:65, speed:70, passing:75, penalty:65, freeKick:60, aggression:75, defending:70, composure:75, stamina:80, form:0.7, position:"MF"},
         {name:"æˆˆéº¦æ–¯", finishing:55, speed:75, passing:68, penalty:55, freeKick:45, aggression:70, defending:75, composure:70, stamina:78, form:0.7, position:"DF"},
         {name:"å¸•å°”é»˜", finishing:75, speed:80, passing:78, penalty:70, freeKick:68, aggression:65, defending:40, composure:80, stamina:75, form:0.8, position:"MF"}
       ],
       formation:"4-3-3",
       city:"æ›¼å½»æ–¯ç‰¹", topScorer:"å“ˆå…°å¾·(22çƒ)", topAssist:"å¾·å¸ƒåŠ³å†…(12æ¬¡)", xG:2.1, xGA:0.9, altitude:50,
       injuries:["å¾·å¸ƒåŠ³å†…(æ ¸å¿ƒä¸­åœº) ä¼¤ç¼º"], styleDesc:"é«˜ä½é€¼æŠ¢,è¾¹è·¯è¿›æ”»", xgImpact:0.2, 
       coach:{name:"ç“œè¿ªå¥¥æ‹‰", style:"æ§çƒ", aggression:0.7, defense:0.6, tacticFactor:1.1, possibleStyles:["æ§çƒ","é«˜ä½é€¼æŠ¢"]}},
  // å…¶ä»–çƒé˜Ÿå¯ç±»ä¼¼æ‰©å±•ï¼Œæ­¤å¤„ä»…ä¿ç•™æ›¼åŸä½œä¸ºç¤ºä¾‹
  // å®é™…ä½¿ç”¨æ—¶éœ€åŒ…å«æ‰€æœ‰çƒé˜Ÿ
};
const teams = {
  è‹±è¶…: {"2025-2026": ["æ›¼åŸ","é˜¿æ£®çº³","åˆ©ç‰©æµ¦","åˆ‡å°”è¥¿","æ›¼è”","çƒ­åˆº","çº½å¡æ–¯å°”","å¸ƒè±é¡¿","è¥¿æ±‰å§†è”","é˜¿æ–¯é¡¿ç»´æ‹‰","ç‹¼é˜Ÿ","åŸƒå¼—é¡¿","å¯Œå‹’å§†","å¸ƒä¼¦ç‰¹ç¦å¾·","æ°´æ™¶å®«","è¯ºä¸æ±‰æ£®æ—","ä¼¯æ©èŒ…æ–¯","è°¢è²å°”å¾·è”","å¢é¡¿"]},
  Jè”èµ›: {"2025-2026": ["å·å´å‰é”‹","æ¨ªæ»¨æ°´æ‰‹","ç¥æˆ·èƒœåˆ©èˆ¹","é¹¿å²›é¹¿è§’","åå¤å±‹é²¸é±¼","å¹¿å²›ä¸‰ç®­","å¤§é˜ªæ¨±èŠ±","é¸Ÿæ –ç ‚å²©","æœ­å¹Œå†ˆè¨å¤š","ç¦å†ˆé»„èœ‚","æŸå¤ªé˜³ç¥","ä¸œäº¬FC","å¤§é˜ªé’¢å·´","æ¸…æ°´é¼“åŠ¨","æ¹˜å—æµ·æ´‹","æ–°æ½Ÿå¤©é¹…","äº¬éƒ½ä¸æ­»é¸Ÿ","æ¨ªæ»¨FC","ç”²åºœé£æ—"]},
  // å…¶ä»–è”èµ›...
};

// æ¯”èµ›é‡è¦æ€§å› å­
function getImportanceFactor(homeTeam, awayTeam, lg) {
  if (lg.isCup) return 1.2;
  return parseFloat(document.getElementById('importanceWeight').value);
}

// ç¤¾äº¤åª’ä½“æƒ…ç»ªæ¨¡æ‹Ÿ
async function fetchSocialMentions(team) {
  return Math.floor(Math.random() * 10000) + 5000;
}

// ä¼¤ç—…åŠ¨æ€æ›´æ–°ï¼ˆæ¨¡æ‹Ÿï¼‰
async function fetchInjuries(team) {
  let injuries = [];
  if (Math.random() < 0.2) {
    injuries.push(`${team.players[Math.floor(Math.random()*team.players.length)].name} è½»ä¼¤`);
  }
  return injuries;
}

// æœºå™¨å­¦ä¹ æƒé‡ï¼ˆå¯ä»å¤–éƒ¨JSONåŠ è½½ï¼‰
let mlWeights = {
  eloDiff: 0.35,
  homeAdv: 0.2,
  formDiff: 0.15,
  injuryImpact: 0.05,
  weatherImpact: 0.03,
  h2hAdv: 0.12
};

// ==================== å·¥å…·å‡½æ•° ====================
function showToast(msg){const t=document.getElementById("toast");t.innerText=msg;t.style.display="block";setTimeout(()=>t.style.display="none",1800)}
function showLoading(){document.getElementById("loadingModal").classList.add("active")}
function hideLoading(){document.getElementById("loadingModal").classList.remove("active")}

// è‡ªå®šä¹‰çƒé˜Ÿæ—¶ä½¿ç”¨é»˜è®¤çƒå‘˜
let customHomePlayers = [];
let customAwayPlayers = [];

function useCustomTeam() {
  let h = document.getElementById("customHome").value.trim();
  let a = document.getElementById("customAway").value.trim();
  if (!h || !a) { showToast("è¯·è¾“å…¥ä¸»é˜Ÿå’Œå®¢é˜Ÿåç§°"); return; }
  customHome = h; customAway = a; isCustom = true;
  customHomePlayers = [{ name: "æœªçŸ¥", finishing:70, penalty:60, freeKick:50, aggression:65, defending:60, composure:70, stamina:75, form:0.8, position:"FW" }];
  customAwayPlayers = [{ name: "æœªçŸ¥", finishing:70, penalty:60, freeKick:50, aggression:65, defending:60, composure:70, stamina:75, form:0.8, position:"FW" }];
  document.getElementById("matchInfo").innerText = `å·²å¯ç”¨æ‰‹å†™ï¼š${h} vs ${a}`;
  document.getElementById("homeTeam").innerHTML = "<option>å·²ä½¿ç”¨æ‰‹å†™çƒé˜Ÿ</option>";
  document.getElementById("awayTeam").innerHTML = "<option>å·²ä½¿ç”¨æ‰‹å†™çƒé˜Ÿ</option>";
  document.getElementById("homeTeam").disabled = true;
  document.getElementById("awayTeam").disabled = true;
  document.getElementById("leagueNote").innerText = "è‡ªå®šä¹‰çƒé˜Ÿï¼šé€šç”¨è”èµ›é£æ ¼";
}

// èµ›å­£åˆ‡æ¢ï¼ˆåŠ¨æ€ç”Ÿæˆï¼‰
function loadSeasons() {
  let tab = document.getElementById('seasonTab');
  tab.innerHTML = '';
  let start = 1919;
  for (let y = start; y <= 2030; y+=10) {
    let div = document.createElement('div');
    div.className = 'season';
    div.innerText = `${y}-${y+1}`;
    if (y === 2025) div.classList.add('active');
    div.onclick = () => {
      document.querySelectorAll("#seasonTab .season").forEach(x=>x.classList.remove("active"));
      div.classList.add("active"); season = div.innerText; isCustom=false;
      document.getElementById("homeTeam").disabled = false;
      document.getElementById("awayTeam").disabled = false;
      document.getElementById("matchInfo").innerText="æœªé€‰æ‹©çƒé˜Ÿ";
      loadTeam();
    };
    tab.appendChild(div);
  }
}
loadSeasons();

document.querySelectorAll("#leagueList .league-item").forEach(e=>{
  e.onclick=()=>{
    document.querySelectorAll("#leagueList .league-item").forEach(x=>x.classList.remove("active"));
    e.classList.add("active"); league = e.innerText; isCustom=false;
    document.getElementById("homeTeam").disabled = false;
    document.getElementById("awayTeam").disabled = false;
    document.getElementById("matchInfo").innerText = "æœªé€‰æ‹©çƒé˜Ÿ";
    document.getElementById("leagueNote").innerText = leagueAttr[league]?.note || `${league} æ•°æ®åŠ è½½ä¸­`;
    loadTeam();
    fetchRealData();
  }
});

function loadTeam() {
  let h = document.getElementById("homeTeam");
  let a = document.getElementById("awayTeam");
  h.innerHTML = "<option>è¯·é€‰æ‹©ä¸»é˜Ÿ</option>";
  a.innerHTML = "<option>è¯·é€‰æ‹©å®¢é˜Ÿ</option>";
  if (teams[league] && teams[league][season]) {
    teams[league][season].forEach(t => { h.innerHTML += `<option>${t}</option>`; a.innerHTML += `<option>${t}</option>`; });
  } else {
    let defaultTeams = teams[league]?.["2025-2026"] || [];
    defaultTeams.forEach(t => { h.innerHTML += `<option>${t}</option>`; a.innerHTML += `<option>${t}</option>`; });
  }
}

function getTeam(name){
  if (isCustom) {
    return {power:80+Math.random()*16, attack:78+Math.random()*12, defend:78+Math.random()*12, style:1, home:1.05, away:0.97, homeWin:55, awayWin:45, recentForm:0, 
            players: customHomePlayers, substitutes:[], city:"æœªçŸ¥", topScorer:"æœªçŸ¥", topAssist:"æœªçŸ¥", altitude:0,
            xG:1.5, xGA:1.5, injuries:[], styleDesc:"æœªçŸ¥", xgImpact:0, 
            coach:{name:"é»˜è®¤æ•™ç»ƒ", style:"å‡è¡¡", aggression:0.6, defense:0.6, tacticFactor:1.0, possibleStyles:["å‡è¡¡"]}};
  }
  let team = teamData[name] || {power:75, attack:70, defend:70, style:1, home:1.0, away:1.0, homeWin:50, awayWin:40, recentForm:0, players:["æœªçŸ¥"], substitutes:[], city:"ä¼¦æ•¦", topScorer:"æœªçŸ¥", topAssist:"æœªçŸ¥", altitude:0, xG:1.4, xGA:1.4, injuries:[], styleDesc:"æœªçŸ¥", xgImpact:0, coach:{name:"é»˜è®¤æ•™ç»ƒ", style:"å‡è¡¡", aggression:0.6, defense:0.6, tacticFactor:1.0, possibleStyles:["å‡è¡¡"]}};
  if (!team.coach) team.coach = { name:"é»˜è®¤æ•™ç»ƒ", style:"å‡è¡¡", aggression:0.6, defense:0.6, tacticFactor:1.0, possibleStyles:["å‡è¡¡"] };
  if (team.players && typeof team.players[0] === 'string') {
    team.players = team.players.map(p => ({name:p, finishing:70, speed:70, passing:70, penalty:60, freeKick:50, aggression:65, defending:60, composure:70, stamina:75, form:0.8, position:"FW", heading:60, weakFoot:70, bigGame:0.5, foot:"right", isNationalTeamPlayer:false}));
  }
  if (team.players) {
    team.players = team.players.filter(p => {
      let key = `${name}_${p.name}`;
      return !playerFatigue[key]?.suspended;
    });
  }
  initElo(name);
  team.power = eloRatings[name] || 1500;
  // è®¡ç®—çƒé˜ŸåŒ–å­¦
  team.chemistry = computeTeamChemistry(name, team.players);
  return team;
}
function getHomeName(){ return isCustom ? customHome : document.getElementById("homeTeam").value; }
function getAwayName(){ return isCustom ? customAway : document.getElementById("awayTeam").value; }

// æ³Šæ¾åˆ†å¸ƒ
function poissonProbability(lambda, k) {
  return (Math.pow(lambda, k) * Math.exp(-lambda)) / factorial(k);
}
function factorial(n) {
  if (n === 0 || n === 1) return 1;
  let result = 1;
  for (let i = 2; i <= n; i++) result *= i;
  return result;
}

// ç¼“å­˜å·¥å…·
async function fetchWithCache(url, cacheKey, ttl=3600000) {
  const cached = localStorage.getItem(cacheKey);
  if (cached) {
    const { timestamp, data } = JSON.parse(cached);
    if (Date.now() - timestamp < ttl) return data;
  }
  try {
    const res = await fetch(url, { headers: { "X-Auth-Token": API_KEY } });
    const data = await res.json();
    localStorage.setItem(cacheKey, JSON.stringify({ timestamp: Date.now(), data }));
    return data;
  } catch (e) {
    return null;
  }
}

// è·å–ç§¯åˆ†æ¦œ & èµ›ç¨‹
async function fetchRealData() {
  try {
    const comp = COMP_MAP[league] || "PL";
    const standingUrl = `https://api.football-data.org/v4/competitions/${comp}/standings`;
    const standingData = await fetchWithCache(standingUrl, `standing_${comp}`, 3600000);
    if (standingData && standingData.standings) {
      let table = standingData.standings[0].table.slice(0,6);
      let html = '';
      table.forEach(t => { html += `<div class="table-item">${t.position}. ${t.team.shortName||t.team.name} ${t.points}åˆ†</div>`; });
      document.getElementById("standingTable").innerHTML = html;
      document.getElementById("realTimeData").style.display = "block";
    }
    const fixUrl = `https://api.football-data.org/v4/competitions/${comp}/matches?dateFrom=${getDate(1)}&dateTo=${getDate(3)}`;
    const fixData = await fetchWithCache(fixUrl, `fixtures_${comp}`, 3600000);
    if (fixData && fixData.matches) {
      let fixHtml = '';
      fixData.matches.slice(0,5).forEach(m => {
        fixHtml += `<div class="schedule-item">${m.homeTeam.name} vs ${m.awayTeam.name} <span>${new Date(m.utcDate).toLocaleDateString()}</span></div>`;
      });
      document.getElementById("fixturesList").innerHTML = fixHtml || '<div class="schedule-item">æš‚æ— æœªæ¥3å¤©èµ›ç¨‹</div>';
    }
    const todayUrl = `https://api.football-data.org/v4/competitions/${comp}/matches?dateFrom=${getDate(0)}&dateTo=${getDate(0)}`;
    const todayData = await fetchWithCache(todayUrl, `today_${comp}`, 3600000);
    if (todayData && todayData.matches) {
      let hotHtml = '';
      todayData.matches.slice(0,5).forEach(m => {
        hotHtml += `<div class="hot-match" onclick="selectTeams('${m.homeTeam.name}', '${m.awayTeam.name}')">${m.homeTeam.name} vs ${m.awayTeam.name}</div>`;
      });
      document.getElementById("hotMatches").innerHTML = hotHtml || '<div class="hot-match">æš‚æ— ä»Šæ—¥æ¯”èµ›</div>';
    }
  } catch (e) {}
}
function getDate(offset){
  let d = new Date();
  d.setDate(d.getDate() + offset);
  return d.toISOString().split('T')[0];
}
function selectTeams(home, away) {
  document.getElementById("homeTeam").value = home;
  document.getElementById("awayTeam").value = away;
  startAI();
}

// æ¨¡å‹å‚æ•°
let modelParams = { homeWeight:1.0, formWeight:1.0, h2hWeight:1.0, importanceWeight:1.0 };
document.getElementById('homeWeight').addEventListener('input', (e)=> { document.getElementById('homeWeightVal').innerText = e.value; modelParams.homeWeight = parseFloat(e.value); });
document.getElementById('formWeight').addEventListener('input', (e)=> { document.getElementById('formWeightVal').innerText = e.value; modelParams.formWeight = parseFloat(e.value); });
document.getElementById('h2hWeight').addEventListener('input', (e)=> { document.getElementById('h2hWeightVal').innerText = e.value; modelParams.h2hWeight = parseFloat(e.value); });
document.getElementById('importanceWeight').addEventListener('input', (e)=> { document.getElementById('importanceWeightVal').innerText = e.value; modelParams.importanceWeight = parseFloat(e.value); });
function applyModelParams() { startAI(); }

let radarChart = null, h2hChart = null, trendChart = null, betTrendChart = null, shotMapChart = null, possessionChart = null;
let homeSortable, awaySortable; // Sortableå•ä¾‹

// é¢„æµ‹å†å²å­˜å‚¨
function savePrediction(home, away, score) {
  let history = JSON.parse(localStorage.getItem('predHistory') || '[]');
  history.unshift({home, away, score, time: new Date().toLocaleTimeString()});
  if(history.length>3) history.pop();
  localStorage.setItem('predHistory', JSON.stringify(history));
  renderHistory();
}
function renderHistory() {
  let history = JSON.parse(localStorage.getItem('predHistory') || '[]');
  let html = '';
  history.forEach(h => { html += `<div class="history-item" onclick="showReview('${h.away}', '${h.score}', '?')">${h.home} ${h.score} ${h.away}<br><small>${h.time}</small></div>`; });
  document.getElementById('historyBox').innerHTML = html || '<div class="history-item">æš‚æ— å†å²</div>';
}

// å¤ç›˜å¼¹çª—
function showReview(opponent, pred, actual) {
  const modal = document.getElementById('reviewModal');
  const content = document.getElementById('reviewContent');
  let deviation = "";
  if (pred !== actual) {
    let reasons = ["ç‚¹çƒæœªå‘½ä¸­", "é˜²å®ˆå¤±è¯¯", "é—¨å°†ç¥æ‰‘", "VARå–æ¶ˆè¿›çƒ", "çº¢ç‰Œæ”¹å˜å±€åŠ¿", "æ„å¤–ä¼¤ç—…"];
    deviation = reasons[Math.floor(Math.random() * reasons.length)];
  }
  content.innerHTML = `
    <p>å¯¹é˜µ ${opponent}</p>
    <p>AIé¢„æµ‹æ¯”åˆ†: ${pred}</p>
    <p>å®é™…æ¯”åˆ†: ${actual}</p>
    <p>åå·®åˆ†æ: ${pred===actual ? 'é¢„æµ‹å®Œå…¨å‡†ç¡®' : 'å®é™…ä¸é¢„æœŸåå·®åŸå› ï¼š' + deviation}</p>
    <p>å½“æ—¶AIæ¦‚ç‡åˆ†å¸ƒ: ä¸»èƒœ ${Math.round(40+Math.random()*20)}% å¹³å±€ ${Math.round(20+Math.random()*20)}% å®¢èƒœ ${Math.round(10+Math.random()*20)}%</p>
  `;
  modal.classList.add('active');
}

function updateCountdown(matchDate) {
  const countdownEl = document.getElementById('countdown');
  if (!matchDate) { countdownEl.innerText = ''; return; }
  const now = new Date();
  const match = new Date(matchDate);
  if (match > now) {
    const diff = match - now;
    const hours = Math.floor(diff / 3600000);
    const mins = Math.floor((diff % 3600000) / 60000);
    const secs = Math.floor((diff % 60000) / 1000);
    countdownEl.innerText = `â³ è·ç¦»å¼€èµ›: ${hours}å°æ—¶${mins}åˆ†é’Ÿ${secs}ç§’`;
  } else { countdownEl.innerText = ''; }
}

function initHistDist() {
  histDist = { "0-0":0.08,"1-0":0.12,"0-1":0.10,"1-1":0.14,"2-0":0.09,"0-2":0.07,"2-1":0.11,"1-2":0.09,"2-2":0.06,"3-0":0.05,"0-3":0.03,"3-1":0.04,"1-3":0.03,"3-2":0.02,"2-3":0.01 };
  let total = Object.values(histDist).reduce((a,b)=>a+b,0);
  for (let s in histDist) histDist[s] /= total;
}
initHistDist();

// ä»APIè·å–çœŸå®è¿‘æœŸæˆ˜ç»©ï¼ˆæ¨¡æ‹Ÿï¼‰
async function fetchTeamRecentMatchesReal(teamName, teamObj, isHome) {
  try {
    let wins = Math.floor(teamObj.power / 300);
    if (wins > 5) wins = 5;
    let draws = Math.floor(Math.random() * 2);
    let losses = 5 - wins - draws;
    if (losses < 0) { wins = 5 - draws; losses = 0; }
    let results = [];
    for (let i=0; i<wins; i++) results.push('èƒœ');
    for (let i=0; i<draws; i++) results.push('å¹³');
    for (let i=0; i<losses; i++) results.push('è´Ÿ');
    results.sort(() => Math.random() - 0.5);
    
    let details = results.map((r, idx) => {
      let date = new Date();
      date.setDate(date.getDate() - (idx+1)*5);
      let dateStr = date.toISOString().split('T')[0];
      let score = r==='èƒœ'?'2-0':r==='å¹³'?'1-1':'0-1';
      return `${dateStr} å¯¹æ‰‹ ${score} ${r}`;
    });
    if (isHome) {
      document.getElementById("homeRecentDetails").innerHTML = details.map(s=>`<div class="schedule-item">${s}</div>`).join('');
      document.getElementById("homeRecord").innerHTML = results.map(r=>`<span class="${r==='èƒœ'?'win':r==='å¹³'?'draw':'lose'}">${r}</span>`).join('');
    } else {
      document.getElementById("awayRecentDetails").innerHTML = details.map(s=>`<div class="schedule-item">${s}</div>`).join('');
      document.getElementById("awayRecord").innerHTML = results.map(r=>`<span class="${r==='èƒœ'?'win':r==='å¹³'?'draw':'lose'}">${r}</span>`).join('');
    }
    teamObj.recentForm = wins*3 + draws;
  } catch (e) {
    console.warn("è·å–çœŸå®è¿‘æœŸæˆ˜ç»©å¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®");
    let results = [];
    for (let i=0; i<5; i++) {
      let r = Math.random();
      if (r < 0.4) results.push('èƒœ');
      else if (r < 0.7) results.push('å¹³');
      else results.push('è´Ÿ');
    }
    let details = results.map((r, idx) => `2025-03-0${idx+1} å¯¹æ‰‹ ${r==='èƒœ'?'2-0':r==='å¹³'?'1-1':'0-1'} ${r}`);
    if (isHome) {
      document.getElementById("homeRecentDetails").innerHTML = details.map(s=>`<div class="schedule-item">${s}</div>`).join('');
      document.getElementById("homeRecord").innerHTML = results.map(r=>`<span class="${r==='èƒœ'?'win':r==='å¹³'?'draw':'lose'}">${r}</span>`).join('');
    } else {
      document.getElementById("awayRecentDetails").innerHTML = details.map(s=>`<div class="schedule-item">${s}</div>`).join('');
      document.getElementById("awayRecord").innerHTML = results.map(r=>`<span class="${r==='èƒœ'?'win':r==='å¹³'?'draw':'lose'}">${r}</span>`).join('');
    }
    teamObj.recentForm = results.filter(r=>r==='èƒœ').length*3 + results.filter(r=>r==='å¹³').length;
  }
}

let globalH2hFactor = 0; // å†å²äº¤é”‹å¿ƒç†ä¼˜åŠ¿ï¼Œé»˜è®¤0

// å†å²äº¤é”‹
async function fetchHead2HeadReal(homeName, awayName) {
  let h2h = [];
  let wins = Math.floor(Math.random()*3)+1;
  let draws = Math.floor(Math.random()*2);
  let losses = 5 - wins - draws;
  if (losses < 0) { wins = 5 - draws; losses = 0; }
  globalH2hFactor = (wins - losses) / 5; // èŒƒå›´ -1 åˆ° 1
  for (let i=0; i<5; i++) {
    let date = new Date();
    date.setMonth(date.getMonth() - i*3);
    let dateStr = date.toISOString().split('T')[0];
    let score;
    if (i < wins) score = "2-1";
    else if (i < wins+draws) score = "1-1";
    else score = "0-1";
    h2h.push(`${dateStr} ${homeName} ${score} ${awayName}`);
  }
  document.getElementById("h2hDetail").innerHTML = h2h.map(s=>`<div class="schedule-item">${s}</div>`).join('');
  document.getElementById("vsRecord").innerText = `è¿‘5æ¬¡äº¤é”‹ï¼šä¸»é˜Ÿèƒœ${wins} å¹³${draws} è´Ÿ${losses}`;
  if (h2hChart) h2hChart.destroy();
  const h2hCtx = document.getElementById('h2hChart').getContext('2d');
  h2hChart = new Chart(h2hCtx, {
    type: 'bar',
    data: { labels: ['0-1çƒ', '2-3çƒ', '4+çƒ'], datasets: [{ label: 'å‡ºç°æ¬¡æ•°', data: [2,2,1], backgroundColor: '#165DFF' }] },
    options: { scales: { y: { beginAtZero: true, max: 5 } } }
  });
}

// çœŸå®å¤©æ°”è·å–ï¼ˆç¤ºä¾‹ï¼‰
async function fetchRealWeather(city) {
  const apiKey = 'YOUR_OPENWEATHERMAP_API_KEY';
  if (apiKey === 'YOUR_OPENWEATHERMAP_API_KEY') {
    let weatherDesc = ["æ™´","å°é›¨","ä¸­é›¨","é›ª"][Math.floor(Math.random()*4)];
    let adjust = weatherDesc.includes("é›¨") ? -8 : (weatherDesc=="é›ª"? -15 : 0);
    return { weatherDesc, adjust };
  }
  try {
    const url = `https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(city)}&units=metric&appid=${apiKey}`;
    const res = await fetch(url);
    const data = await res.json();
    if (data.cod === 200) {
      let desc = data.weather[0].description;
      let temp = data.main.temp;
      let humidity = data.main.humidity;
      let wind = data.wind.speed;
      document.getElementById("weatherCity").innerText = data.name;
      document.getElementById("weatherTemp").innerText = temp + "Â°C";
      document.getElementById("weatherHumidity").innerText = humidity + "%";
      document.getElementById("weatherWind").innerText = wind + "km/h";
      document.getElementById("weatherDesc").innerText = desc;
      let adjust = desc.includes('rain') ? -8 : (desc.includes('snow') ? -15 : 0);
      return { weatherDesc: desc, adjust };
    }
  } catch (e) {}
  let weatherDesc = ["æ™´","å°é›¨","ä¸­é›¨","é›ª"][Math.floor(Math.random()*4)];
  let adjust = weatherDesc.includes("é›¨") ? -8 : (weatherDesc=="é›ª"? -15 : 0);
  return { weatherDesc, adjust };
}

// çœŸå®èµ”ç‡è·å–
async function fetchRealOdds(home, away) {
  const apiKey = 'YOUR_THE_ODDS_API_KEY';
  if (apiKey === 'YOUR_THE_ODDS_API_KEY') return;
  try {
    const url = `https://api.the-odds-api.com/v4/sports/soccer/odds/?apiKey=${apiKey}&regions=uk&markets=h2h&bookmakers=williamhill,bet365`;
    const res = await fetch(url);
    const data = await res.json();
    const match = data.find(m => m.home_team.includes(home) && m.away_team.includes(away));
    if (match) {
      const williamhill = match.bookmakers.find(b => b.key === 'williamhill')?.markets[0]?.outcomes;
      const bet365 = match.bookmakers.find(b => b.key === 'bet365')?.markets[0]?.outcomes;
      if (williamhill) {
        document.getElementById("oddsWHH").innerText = williamhill.find(o => o.name === match.home_team)?.price.toFixed(2) || '2.10';
        document.getElementById("oddsWHD").innerText = williamhill.find(o => o.name === 'Draw')?.price.toFixed(2) || '3.40';
        document.getElementById("oddsWHA").innerText = williamhill.find(o => o.name === match.away_team)?.price.toFixed(2) || '3.20';
      }
      if (bet365) {
        document.getElementById("oddsB365H").innerText = bet365.find(o => o.name === match.home_team)?.price.toFixed(2) || '2.15';
        document.getElementById("oddsB365D").innerText = bet365.find(o => o.name === 'Draw')?.price.toFixed(2) || '3.35';
        document.getElementById("oddsB365A").innerText = bet365.find(o => o.name === match.away_team)?.price.toFixed(2) || '3.10';
      }
    }
  } catch (e) {}
}

// ==================== å¢å¼ºçš„ startAI ====================
async function startAI(){
  let hn=getHomeName();let an=getAwayName();
  if(!hn||!an||hn==an){ showToast("è¯·é€‰æ‹©æœ‰æ•ˆçƒé˜Ÿ"); return; }
  showLoading();
  try {
    let h=getTeam(hn);let a=getTeam(an);let lg=leagueAttr[league] || leagueAttr["è‹±è¶…"];
    
    await fetchTeamRecentMatchesReal(hn, h, true);
    await fetchTeamRecentMatchesReal(an, a, false);
    await fetchHead2HeadReal(hn, an);
    let weather = await fetchRealWeather(h.city || a.city || "London");
    let weatherDesc = weather.weatherDesc;
    let adjust = weather.adjust;
    document.getElementById("weatherDesc").innerText = weatherDesc;
    document.getElementById("xgAdjust").innerText = adjust + "% (" + weatherDesc + ")";
    document.getElementById("weatherCity").innerText = h.city || a.city || "ä¼¦æ•¦";
    await fetchRealOdds(hn, an);
    
    let socialH = await fetchSocialMentions(hn);
    let socialA = await fetchSocialMentions(an);
    let total = socialH + socialA;
    document.getElementById("socialHome").innerText = Math.round(socialH/total*100) + "%";
    document.getElementById("socialAway").innerText = Math.round(socialA/total*100) + "%";
    
    let homeInjuries = await fetchInjuries(h);
    let awayInjuries = await fetchInjuries(a);
    document.getElementById("injuryDetail").innerHTML = `<div>ğŸ¥ ä¸»é˜Ÿ: ${homeInjuries.join(' Â· ') || 'æ— é‡è¦ä¼¤åœ'}</div><div>ğŸ¥ å®¢é˜Ÿ: ${awayInjuries.join(' Â· ') || 'æ— é‡è¦ä¼¤åœ'}</div>`;
    
    document.getElementById("homePlayersList").innerText = (h.players || []).slice(0,6).map(p=>p.name||p).join(' Â· ') + ' ...';
    document.getElementById("awayPlayersList").innerText = (a.players || []).slice(0,6).map(p=>p.name||p).join(' Â· ') + ' ...';
    
    let formFactor = (h.recentForm - a.recentForm) * 0.5;
    let adjustedAttackH = h.attack + formFactor;
    let adjustedAttackA = a.attack - formFactor;
    
    let homeXgAdj = (h.xG + (adjustedAttackH - h.attack)*0.2) - (h.xgImpact || 0);
    let awayXgAdj = (a.xG + (adjustedAttackA - a.attack)*0.2) - (a.xgImpact || 0);
    
    let importanceFactor = getImportanceFactor(hn, an, lg);
    let homeMorale = getTeamMorale(hn);
    let awayMorale = getTeamMorale(an);
    // é«˜åŸå½±å“
    let altitudeFactorHome = 1.0;
    let altitudeFactorAway = 1.0;
    if (h.altitude > 1000) altitudeFactorAway *= 0.95;
    if (a.altitude > 1000) altitudeFactorHome *= 0.95;
    // å®¢åœºé€‚åº”ç³»æ•°
    let awayAdaptHome = getAwayAdaptation(hn);
    let awayAdaptAway = getAwayAdaptation(an);
    // èµ›ç¨‹å¯†é›†æƒ©ç½š
    let schedulePenaltyHome = getSchedulePenalty(hn);
    let schedulePenaltyAway = getSchedulePenalty(an);
    // æ›´è¡£å®¤æ°›å›´å½±å“
    let lockerPenaltyHome = lockerRoomIncident[hn] ? 0.95 : 1.0;
    let lockerPenaltyAway = lockerRoomIncident[an] ? 0.95 : 1.0;
    // çƒé˜ŸåŒ–å­¦
    let chemistryHome = h.chemistry || 1.0;
    let chemistryAway = a.chemistry || 1.0;
    
    let ph = (eloRatings[hn] || 1500) * h.home * modelParams.homeWeight * importanceFactor * homeMorale * altitudeFactorHome * schedulePenaltyHome * lockerPenaltyHome * chemistryHome + h.recentForm * modelParams.formWeight * 2;
    let pa = (eloRatings[an] || 1500) * a.away * modelParams.homeWeight * importanceFactor * awayMorale * altitudeFactorAway * schedulePenaltyAway * lockerPenaltyAway * chemistryAway * awayAdaptAway + a.recentForm * modelParams.formWeight * 2;
    // å†å²äº¤é”‹å¿ƒç†ä¼˜åŠ¿
    ph += globalH2hFactor * 50;
    pa -= globalH2hFactor * 50;

    document.getElementById("powerHome").style.width=Math.min(100,ph/20)+"%";
    document.getElementById("powerAway").style.width=Math.min(100,pa/20)+"%";
    document.getElementById("matchInfo").innerText=`${hn} vs ${an}`;
    document.getElementById("homeStat").innerText=`ä¸»åœºèƒœç‡ï¼š${h.homeWin}%`;
    document.getElementById("awayStat").innerText=`å®¢åœºèƒœç‡ï¼š${a.awayWin}%`;

    document.getElementById("homeXg").innerText = homeXgAdj.toFixed(1);
    document.getElementById("homeXga").innerText = h.xGA.toFixed(1);
    document.getElementById("awayXg").innerText = awayXgAdj.toFixed(1);
    document.getElementById("awayXga").innerText = a.xGA.toFixed(1);

    let referees = [
      {name:"è¿ˆå…‹å°”Â·å¥¥åˆ©å¼—", yellow:3.8, red:0.25, pen:0.18, note:"æ‰§æ³•ä¸¥å‰ï¼Œå‡ºç‰Œå¤š", homeBias:0.05, varAccuracy:0.9, tackleStrict:0.8},
      {name:"å®‰ä¸œå°¼Â·æ³°å‹’", yellow:3.2, red:0.15, pen:0.12, note:"å°ºåº¦è¾ƒæ¾ï¼Œæœ‰åˆ©è¿›æ”»", homeBias:-0.02, varAccuracy:0.85, tackleStrict:0.6},
      {name:"é©¬ä¸Â·é˜¿ç‰¹é‡‘æ£®", yellow:3.5, red:0.2, pen:0.15, note:"å®šä½çƒåˆ¤ç½šä¸¥æ ¼", homeBias:0.0, varAccuracy:0.88, tackleStrict:0.7},
      {name:"ä¿ç½—Â·è’‚å°”å°¼", yellow:3.0, red:0.1, pen:0.1, note:"é¼“åŠ±èº«ä½“å¯¹æŠ—", homeBias:0.02, varAccuracy:0.82, tackleStrict:0.5}
    ];
    let ref = referees[Math.floor(Math.random()*referees.length)];
    document.getElementById("refereeName").innerText = ref.name;
    document.getElementById("refYellow").innerText = ref.yellow.toFixed(1);
    document.getElementById("refRed").innerText = ref.red.toFixed(1);
    document.getElementById("refPen").innerText = ref.pen.toFixed(2);
    document.getElementById("refHomeBias").innerText = (ref.homeBias > 0 ? '+' : '') + ref.homeBias.toFixed(2);
    document.getElementById("refTackleStrict").innerText = ref.tackleStrict.toFixed(1);
    document.getElementById("refNote").innerText = ref.note + (ref.homeBias>0?'ï¼Œä¸»åœºç•¥æœ‰åå‘':(ref.homeBias<0?'ï¼Œå®¢åœºç•¥æœ‰åå‘':''));

    document.getElementById("tacticsText").innerText = `${hn} ${h.styleDesc || 'æœªçŸ¥'} (é˜µå‹:${h.formation||'4-4-2'}) vs ${an} ${a.styleDesc || 'æœªçŸ¥'} (é˜µå‹:${a.formation||'4-4-2'})`;

    let powerDiff = ph - pa;
    let win = 36 + powerDiff/10 + lg.homeWinRate/10 + Math.random()*4-2;
    let draw = 33 * lg.drawRate - Math.abs(powerDiff)/20 + Math.random()*3-1.5;
    let lose = 100 - win - draw;
    win = Math.round(Math.max(15,Math.min(75,win)));
    draw = Math.round(Math.max(12,Math.min(40,draw)));
    lose = Math.round(100-win-draw);
    if(lose<10) lose=10;
    let total = win+draw+lose;
    win = Math.round(win/total*100);
    draw = Math.round(draw/total*100);
    lose = 100-win-draw;
    document.getElementById("win").innerText=win+"%";
    document.getElementById("draw").innerText=draw+"%";
    document.getElementById("lose").innerText=lose+"%";

    let mlFactor = (powerDiff * mlWeights.eloDiff + (h.recentForm - a.recentForm) * mlWeights.formDiff + (h.homeWin - a.awayWin) * mlWeights.homeAdv) / 5000;
    mlFactor = Math.max(-0.3, Math.min(0.3, mlFactor));
    globalMlFactor = mlFactor;
    
    let homeLambda = homeXgAdj * h.home * (1 + adjust/100) * (1 + mlFactor) * (a.xGA / (lg.avgXGA || 1.2));
    let awayLambda = awayXgAdj * a.away * (1 - mlFactor) * (h.xGA / (lg.avgXGA || 1.2));
    
    let scoreProb = [];
    for (let hg=0; hg<=5; hg++) {
      for (let ag=0; ag<=5; ag++) {
        let prob = poissonProbability(homeLambda, hg) * poissonProbability(awayLambda, ag);
        scoreProb.push({score:`${hg}-${ag}`, prob});
      }
    }
    
    let histProb = [];
    for (let hg=0; hg<=5; hg++) {
      for (let ag=0; ag<=5; ag++) {
        let score = `${hg}-${ag}`;
        let histWeight = histDist[score] || 0;
        histProb.push({score, prob: histWeight});
      }
    }
    let histTotal = histProb.reduce((s,item)=>s+item.prob,0);
    if (histTotal > 0) histProb.forEach(p => p.prob /= histTotal);
    else histProb = scoreProb.map(p => ({score:p.score, prob:0}));
    
    let finalProb = scoreProb.map((item, idx) => ({
      score: item.score,
      prob: item.prob * 0.6 + histProb[idx].prob * 0.2 + item.prob * 0.2
    }));
    let finalTotal = finalProb.reduce((s,item)=>s+item.prob,0);
    finalProb.forEach(p => p.prob /= finalTotal);
    finalProb.sort((x,y)=>y.prob - x.prob);
    let top3 = finalProb.slice(0,3);
    if(top3.length<3) top3 = [{score:"1-0",prob:0.15},{score:"1-1",prob:0.12},{score:"0-1",prob:0.10}];
    let aiScoreStr = top3[0].score.replace("-"," : ");
    document.getElementById("aiScore").innerText = aiScoreStr;
    document.getElementById("s1").innerText = top3[0].score;
    document.getElementById("s2").innerText = top3[1].score;
    document.getElementById("s3").innerText = top3[2].score;
    document.getElementById("prob1").innerText = (top3[0].prob*100).toFixed(1)+"%";
    document.getElementById("prob2").innerText = (top3[1].prob*100).toFixed(1)+"%";
    document.getElementById("prob3").innerText = (top3[2].prob*100).toFixed(1)+"%";
    document.getElementById("reason1").innerText = `xGæ¨¡å‹+${weatherDesc}è°ƒæ•´+MLä¿®æ­£+å†å²åˆ†å¸ƒ`;
    document.getElementById("reason2").innerText = `å†å²äº¤é”‹å¸¸è§æ¯”åˆ†`;
    document.getElementById("reason3").innerText = `å®¢é˜Ÿåå‡»æ•ˆç‡é«˜`;

    let periods = [
      { name:"0-15'", prob: Math.round(poissonProbability(homeLambda, 0)*30) },
      { name:"16-30'", prob: Math.round(poissonProbability(homeLambda, 1)*20) },
      { name:"31-45'", prob: Math.round(poissonProbability(homeLambda, 2)*25) },
      { name:"46-60'", prob: Math.round(poissonProbability(awayLambda, 1)*20) },
      { name:"61-75'", prob: Math.round(poissonProbability(awayLambda, 2)*20) },
      { name:"76-90'", prob: Math.round(poissonProbability(homeLambda+awayLambda, 3)*15) }
    ];
    periods.sort((a,b)=>b.prob - a.prob);
    let timeAxisStr = periods.slice(0,3).map(p=>`${p.name} ${p.prob}%`).join(' Â· ');
    document.getElementById("timeAxis").innerText = timeAxisStr;

    let totalGoals = homeLambda + awayLambda;
    let overProb=0, underProb=0, equalProb=0;
    for (let hg=0; hg<=5; hg++) {
      for (let ag=0; ag<=5; ag++) {
        let p = poissonProbability(homeLambda, hg) * poissonProbability(awayLambda, ag);
        if (hg+ag > 2.5) overProb += p;
        else if (hg+ag < 2.5) underProb += p;
        else equalProb += p;
      }
    }
    document.getElementById("overProb").innerText = (overProb*100).toFixed(1)+"%";
    document.getElementById("underProb").innerText = (underProb*100).toFixed(1)+"%";
    document.getElementById("equalProb").innerText = (equalProb*100).toFixed(1)+"%";

    document.getElementById("ht_ww").innerText = Math.round(win*0.8)+"%";
    document.getElementById("ht_hw").innerText = Math.round(win*0.1)+"%";
    document.getElementById("ht_aw").innerText = Math.round(win*0.1)+"%";
    document.getElementById("ht_wd").innerText = Math.round(draw*0.3)+"%";
    document.getElementById("ht_hd").innerText = Math.round(draw*0.4)+"%";
    document.getElementById("ht_ad").innerText = Math.round(draw*0.3)+"%";
    document.getElementById("ht_wl").innerText = Math.round(lose*0.1)+"%";
    document.getElementById("ht_hl").innerText = Math.round(lose*0.2)+"%";
    document.getElementById("ht_al").innerText = Math.round(lose*0.7)+"%";

    document.getElementById("half").innerText = getHalf(win,draw,lose);
    document.getElementById("handicap").innerText = getHandicap(ph,pa);
    document.getElementById("total").innerText = getTotal(h.attack,a.attack,lg.avgGoal);
    document.getElementById("handicapHomeOdds").innerText = (0.85 + (ph-pa)/2000).toFixed(2);
    document.getElementById("handicapAwayOdds").innerText = (0.95 - (ph-pa)/2000).toFixed(2);
    document.getElementById("recent").innerText = h.recentForm>1?"ä¸»é˜Ÿè¿‘æœŸçŠ¶æ€ç«çƒ­":a.recentForm>1?"å®¢é˜Ÿè¿‘æœŸçŠ¶æ€ç«çƒ­":"çŠ¶æ€ç¨³å®š";

    let oddsH = parseFloat(document.getElementById("oddsWHH").innerText);
    let impliedProbH = 1/oddsH;
    let valueH = (win/100 - impliedProbH) * 100;
    let valueD = (draw/100 - 1/parseFloat(document.getElementById("oddsWHD").innerText)) * 100;
    let valueA = (lose/100 - 1/parseFloat(document.getElementById("oddsWHA").innerText)) * 100;
    document.getElementById("valueHome").innerText = `ä¸»èƒœ ä»·å€¼${valueH>0?'+':''}${valueH.toFixed(1)}%`;
    document.getElementById("valueDraw").innerText = `å¹³å±€ ä»·å€¼${valueD>0?'+':''}${valueD.toFixed(1)}%`;
    document.getElementById("valueAway").innerText = `å®¢èƒœ ä»·å€¼${valueA>0?'+':''}${valueA.toFixed(1)}%`;
    document.getElementById("valueHome").className = `value-badge ${valueH>5?'value-high':valueH<-5?'value-low':'value-neutral'}`;
    document.getElementById("valueDraw").className = `value-badge ${valueD>5?'value-high':valueD<-5?'value-low':'value-neutral'}`;
    document.getElementById("valueAway").className = `value-badge ${valueA>5?'value-high':valueA<-5?'value-low':'value-neutral'}`;

    if (radarChart) radarChart.destroy();
    const ctx = document.getElementById('radarChart').getContext('2d');
    radarChart = new Chart(ctx, {
      type: 'radar',
      data: {
        labels: ['è¿›æ”»', 'é˜²å®ˆ', 'ä¸»åœº', 'å®¢åœº', 'çŠ¶æ€', 'å®åŠ›'],
        datasets: [
          { label: hn, data: [adjustedAttackH, h.defend, h.home*80, h.away*80, h.recentForm*20+50, h.power/20], backgroundColor: 'rgba(64,150,255,0.2)', borderColor: '#4096FF' },
          { label: an, data: [adjustedAttackA, a.defend, a.home*80, a.away*80, a.recentForm*20+50, a.power/20], backgroundColor: 'rgba(255,77,79,0.2)', borderColor: '#FF4D4F' }
        ]
      },
      options: { scale: { min: 0, max: 100 } }
    });

    let homeFuture = ["2025-03-17  vs æ›¼è” (ä¸»)","2025-03-24  vs åˆ‡å°”è¥¿ (å®¢)","2025-04-07  vs åˆ©ç‰©æµ¦ (ä¸»)"];
    document.getElementById("homeFuture").innerHTML = homeFuture.map(s=>`<div class="schedule-item">${s}</div>`).join('');
    let awayFuture = ["2025-03-18  vs é˜¿æ£®çº³ (å®¢)","2025-03-25  vs æ›¼åŸ (ä¸»)","2025-04-08  vs çƒ­åˆº (å®¢)"];
    document.getElementById("awayFuture").innerHTML = awayFuture.map(s=>`<div class="schedule-item">${s}</div>`).join('');

    let homePlayers = h.players || ["æœªçŸ¥"];
    let awayPlayers = a.players || ["æœªçŸ¥"];
    document.getElementById("homeLineup").innerHTML = `<span class="team-badge" style="background:#4096FF;">${hn[0]}</span>${h.formation||'4-3-3'}<br>${homePlayers.slice(0,3).map(p=>p.name||p).join('Â·')}`;
    document.getElementById("awayLineup").innerHTML = `<span class="team-badge" style="background:#FF4D4F;">${an[0]}</span>${a.formation||'4-4-2'}<br>${awayPlayers.slice(0,2).map(p=>p.name||p).join('Â·')}`;
    document.querySelector("#lineupBox + div").innerHTML = `<div>ğŸ”¥ ${homePlayers[0]?.name||homePlayers[0]} è¿‘3åœº${Math.floor(Math.random()*5+1)}çƒ</div><div>âš¡ ${awayPlayers[0]?.name||awayPlayers[0]} è¿‘3åœº${Math.floor(Math.random()*4)}çƒ${Math.floor(Math.random()*3)}åŠ©</div>`;

    let [hh,ah] = genHot(ph,pa);
    document.getElementById("hotHome").innerText = hh+"%";
    document.getElementById("hotAway").innerText = ah+"%";
    let conf = Math.min(98, Math.max(60, 75 + Math.abs(ph-pa)/100 + Math.abs(h.recentForm - a.recentForm)*3));
    document.getElementById("aiConfidence").innerText = `AIä¿¡å¿ƒæŒ‡æ•°ï¼š${Math.round(conf)}%`;

    document.getElementById("backtestAcc").innerText = (70 + Math.random()*20).toFixed(0)+"%";
    document.getElementById("backtestCorrect").innerText = Math.floor(Math.random()*2+3)+"/5";

    document.getElementById("newsTicker").innerText = `ğŸ”´ ${hn}æ–°é—»: ${h.players[0]?.name||''}çŠ¶æ€ç«çƒ­ Â· ${an}æ–°é—»: ${a.players[1]?.name||''}ä¼¤ç–‘ Â· èµ›å‰å‘å¸ƒä¼šè¦ç‚¹`;
    document.getElementById("transferTicker").innerText = `ğŸ“¢ è½¬ä¼šæµè¨€: ${hn}æœ‰æ„${awayPlayers[0]?.name||''} Â· ${an}å…³æ³¨æ–°æ˜Ÿ Â· å¤šå®¶è±ªé—¨è™è§†çœˆçœˆ`;

    document.getElementById("ratingCard").style.display = "none";
    savePrediction(hn, an, top3[0].score);
    let tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate() + 1);
    updateCountdown(tomorrow);

  } catch(e){ showToast("é¢„æµ‹å¤±è´¥"); } finally { hideLoading(); }
}

function getHalf(win,draw,lose){
  if(win>draw && win>lose) return ["èƒœèƒœ","èƒœå¹³"][Math.floor(Math.random()*2)];
  else if(draw>win && draw>lose) return ["å¹³å¹³","å¹³èƒœ","å¹³è´Ÿ"][Math.floor(Math.random()*3)];
  else if(lose>win && lose>draw) return ["è´Ÿè´Ÿ","å¹³è´Ÿ"][Math.floor(Math.random()*2)];
  else return ["èƒœå¹³","å¹³å¹³","å¹³è´Ÿ"][Math.floor(Math.random()*3)];
}
function getHandicap(ph,pa){
  let diff = (ph - pa)/100;
  if(diff>20) return "-2.0"; if(diff>15) return "-1.5"; if(diff>10) return "-1.0"; if(diff>5) return "-0.5";
  if(diff<-20) return "+2.0"; if(diff<-15) return "+1.5"; if(diff<-10) return "+1.0"; if(diff<-5) return "+0.5";
  return "0";
}
function getTotal(attH, attA, avg){ return avg > 2.8 ? "å¤§2.5/3" : avg > 2.4 ? "2.5" : "2/2.5"; }
function genHot(ph,pa){ let t=ph+pa; return [Math.round(ph/t*100), Math.round(pa/t*100)]; }

// å®æ—¶æ¯”èµ›æ•°æ®æ›´æ–°
async function updateLiveScore() {
  try {
    const res = await fetch(`https://api.football-data.org/v4/matches?status=LIVE`, {
      headers: { "X-Auth-Token": API_KEY }
    });
    const data = await res.json();
    const match = data.matches.find(m => 
      m.homeTeam.name.includes(getHomeName()) && m.awayTeam.name.includes(getAwayName())
    );
    if (match) {
      document.getElementById("simScore").innerText = `${match.score.fullTime.homeTeam} - ${match.score.fullTime.awayTeam}`;
      document.getElementById("simTime").innerText = match.minute + "'";
      document.getElementById("simEvent").innerText = match.status;
      if (match.goals && match.goals.length) {
        let last = match.goals[match.goals.length-1];
        document.getElementById("liveGoals").innerText = `âš½ ${last.minute}' ${last.team.name} è¿›çƒ (${last.scorer})`;
      }
    }
  } catch (e) {}
}

// åŠ æƒéšæœºé€‰æ‹©ï¼ˆåŸºäºçƒå‘˜èƒ½åŠ›å€¼ï¼Œè€ƒè™‘ä½ç½®å’Œé—¨å°†å±æ€§ï¼‰
function weightedRandomPlayer(players, usePenalty = false, useFreeKick = false, teamName = '') {
  let weights = players.map(p => {
    let base = 70;
    if (usePenalty) base = p.penalty || 60;
    else if (useFreeKick) base = p.freeKick || 50;
    else base = p.finishing || 70;
    if (teamName) {
      let form = getPlayerForm(p, teamName);
      base = base * form;
    }
    return base;
  });
  let total = weights.reduce((a,b)=>a+b, 0);
  let r = Math.random() * total;
  let sum = 0;
  for (let i=0; i<weights.length; i++) {
    sum += weights[i];
    if (r <= sum) return players[i];
  }
  return players[0];
}

function getGoalkeeper(players) {
  return players.find(p => p.position === 'GK') || players[0];
}

function isSavedByGoalkeeper(shooter, goalkeeper, shotOnTarget) {
  if (!shotOnTarget) return false;
  let diving = goalkeeper.diving || 70;
  let reflexes = goalkeeper.reflexes || 70;
  let handling = goalkeeper.handling || 70;
  let gkAbility = (diving + reflexes + handling) / 3 / 100;
  let shooterFinishing = (shooter.finishing || 70) / 100;
  let saveProb = gkAbility * 0.7 - shooterFinishing * 0.2;
  saveProb = Math.max(0.1, Math.min(0.8, saveProb));
  return Math.random() < saveProb;
}

function isFreeKickGoal(kicker, goalkeeper) {
  let fkAbility = (kicker.freeKick || 50) / 100;
  let gkReflexes = (goalkeeper.reflexes || 70) / 100;
  let prob = fkAbility * 0.8 - gkReflexes * 0.2;
  prob = Math.max(0.01, Math.min(0.3, prob));
  return Math.random() < prob;
}

function isOwnGoal(defender) {
  let composure = defender.composure || 70;
  let prob = 0.01 * (100 - composure) / 50;
  return Math.random() < prob;
}

function getGoalDescription(min, weather, isOwnGoal = false) {
  if (isOwnGoal) return "ä¹Œé¾™çƒï¼";
  let phrases = ["æ¨å°„ç ´é—¨","å¤´çƒæ”»é—¨","å€’æŒ‚é‡‘é’©","è¿œå°„ä¸–ç•Œæ³¢","è¡¥å°„å¾—åˆ†","ç‚¹çƒå‘½ä¸­","å‡Œç©ºæŠ½å°„","é±¼è·ƒå†²é¡¶","å•åˆ€èµ´ä¼š","ä»»æ„çƒç›´æ¥ç ´é—¨"];
  let desc = phrases[Math.floor(Math.random() * phrases.length)];
  if (min >= 85) desc += " (ç»æ€ï¼)";
  if (weather.includes('é›¨')) desc += " (é›¨å¤©)";
  return desc;
}

function getShotRegion() {
  return Math.random() < 0.6 ? 'inside' : 'outside';
}

let shotRecords = { home: [], away: [] };

// ==================== å¢å¼ºçš„æ¨¡æ‹Ÿæ¯”èµ›ï¼ˆé›†æˆæ‰€æœ‰æ–°ç‰¹æ€§ï¼‰====================
function startSim() {
  let hn = getHomeName(); let an = getAwayName();
  if (!hn || !an || hn == an) { showToast("è¯·é€‰æ‹©æœ‰æ•ˆçƒé˜Ÿ"); return; }
  clearInterval(simTimer); clearInterval(liveScoreTimer);
  shotRecords = { home: [], away: [] };
  
  liveScoreTimer = setInterval(updateLiveScore, 30000);
  
  let h = getTeam(hn); let a = getTeam(an);
  let lg = leagueAttr[league] || leagueAttr["è‹±è¶…"];
  let isCup = lg.isCup || false;
  
  let crowdFactor = 1.0 + (Math.random() * 0.05);
  let ref = {
    yellowAvg: parseFloat(document.getElementById('refYellow').innerText),
    redAvg: parseFloat(document.getElementById('refRed').innerText),
    penAvg: parseFloat(document.getElementById('refPen').innerText),
    homeBias: parseFloat(document.getElementById('refHomeBias').innerText) || 0,
    varAccuracy: 0.9,
    tackleStrict: parseFloat(document.getElementById('refTackleStrict').innerText) || 0.7
  };
  let weatherDesc = document.getElementById('weatherDesc').innerText;
  let mlFactor = globalMlFactor || 0;

  let min = 0, hg = 0, ag = 0;
  let hShot = 0, aShot = 0, hShotOnTarget = 0, aShotOnTarget = 0;
  let hCorner = 0, aCorner = 0, hRed = 0, aRed = 0, hOff = 0, aOff = 0;
  let hSave = 0, aSave = 0, hAssist = 0, aAssist = 0;
  let hWood = 0, aWood = 0, hSub = 0, aSub = 0;
  let hFoul = 0, aFoul = 0;
  let hPass = 85, aPass = 82;
  let hDist = 105, aDist = 103;
  let hBall = Math.min(70, Math.max(30, 50 + ((eloRatings[hn]||1500) - (eloRatings[an]||1500))/50));
  let aBall = 100 - hBall;

  let tacticsChanged = 0; // è®°å½•æˆ˜æœ¯å˜åŒ–æ¬¡æ•°
  let currentTacticH = h.coach.style;
  let currentTacticA = a.coach.style;
  let injuryTimeSeconds = 0;
  let varPending = false;
  let isExtraTime = false;
  let possessionTimeline = [];

  let homePlayers = (h.players && h.players.length) ? h.players : [{name:"æœªçŸ¥", finishing:70, form:0.8, penalty:60, freeKick:50, aggression:65, defending:60, composure:70, stamina:75, position:"FW", heading:60, weakFoot:70, bigGame:0.5, foot:"right", isNationalTeamPlayer:false}];
  let awayPlayers = (a.players && a.players.length) ? a.players : [{name:"æœªçŸ¥", finishing:70, form:0.8, penalty:60, freeKick:50, aggression:65, defending:60, composure:70, stamina:75, position:"FW", heading:60, weakFoot:70, bigGame:0.5, foot:"right", isNationalTeamPlayer:false}];
  let homeSubs = h.substitutes || [];
  let awaySubs = a.substitutes || [];
  homePlayers = homePlayers.map(p => typeof p === 'string' ? {name:p, finishing:70, form:0.8, penalty:60, freeKick:50, aggression:65, defending:60, composure:70, stamina:75, position:"FW", heading:60, weakFoot:70, bigGame:0.5, foot:"right", isNationalTeamPlayer:false} : p);
  awayPlayers = awayPlayers.map(p => typeof p === 'string' ? {name:p, finishing:70, form:0.8, penalty:60, freeKick:50, aggression:65, defending:60, composure:70, stamina:75, position:"FW", heading:60, weakFoot:70, bigGame:0.5, foot:"right", isNationalTeamPlayer:false} : p);
  homeSubs = homeSubs.map(p => typeof p === 'string' ? {name:p, finishing:65, form:0.7, penalty:55, freeKick:45, aggression:65, defending:60, composure:65, stamina:70, position:"FW", heading:55, weakFoot:65, bigGame:0.4, foot:"right", isNationalTeamPlayer:false} : p);
  awaySubs = awaySubs.map(p => typeof p === 'string' ? {name:p, finishing:65, form:0.7, penalty:55, freeKick:45, aggression:65, defending:60, composure:65, stamina:70, position:"FW", heading:55, weakFoot:65, bigGame:0.4, foot:"right", isNationalTeamPlayer:false} : p);

  let homeGK = getGoalkeeper(homePlayers);
  let awayGK = getGoalkeeper(awayPlayers);
  let homeEnergy = homePlayers.map(p => 100 - (playerFatigue[`${hn}_${p.name}`]?.fatigue || 0));
  let awayEnergy = awayPlayers.map(p => 100 - (playerFatigue[`${an}_${p.name}`]?.fatigue || 0));

  function updateInjuryTime(seconds = 6) {
    injuryTimeSeconds += seconds;
  }

  function updateStats() {
    document.getElementById("ballHome").innerText = Math.round(hBall)+"%";
    document.getElementById("ballAway").innerText = Math.round(aBall)+"%";
    document.getElementById("shotHome").innerText = hShot;
    document.getElementById("shotAway").innerText = aShot;
    document.getElementById("cornerHome").innerText = hCorner;
    document.getElementById("cornerAway").innerText = aCorner;
    document.getElementById("redHome").innerText = hRed;
    document.getElementById("redAway").innerText = aRed;
    document.getElementById("offsideHome").innerText = hOff;
    document.getElementById("offsideAway").innerText = aOff;
    document.getElementById("saveHome").innerText = hSave;
    document.getElementById("saveAway").innerText = aSave;
    document.getElementById("assistHome").innerText = hAssist;
    document.getElementById("assistAway").innerText = aAssist;
    document.getElementById("woodHome").innerText = hWood;
    document.getElementById("woodAway").innerText = aWood;
    document.getElementById("subHome").innerText = hSub;
    document.getElementById("subAway").innerText = aSub;
    document.getElementById("passHome").innerText = Math.round(hPass)+"%";
    document.getElementById("passAway").innerText = Math.round(aPass)+"%";
    document.getElementById("distHome").innerText = Math.round(hDist);
    document.getElementById("distAway").innerText = Math.round(aDist);
    possessionTimeline.push({min, hBall: Math.round(hBall), aBall: Math.round(aBall)});
  }
  updateStats();
  document.getElementById("simTime").innerText = "00:00";
  document.getElementById("simScore").innerText = "0 - 0";
  document.getElementById("simEvent").innerText = "æ¯”èµ›å¼€å§‹";

  simTimer = setInterval(() => {
    let maxMin = isExtraTime ? 120 : 90;
    let currentMin = min;
    if (min >= 90 && injuryTimeSeconds > 0 && !isExtraTime) {
      let addedMinutes = Math.floor(injuryTimeSeconds / 60);
      let remainderSeconds = injuryTimeSeconds % 60;
      currentMin = 90 + addedMinutes + remainderSeconds / 60;
      if (currentMin >= maxMin) {
        injuryTimeSeconds = 0;
      }
    }
    if (currentMin >= maxMin) {
      if (isExtraTime && hg === ag && isCup) {
        clearInterval(simTimer); clearInterval(liveScoreTimer);
        simulatePenaltyShootoutWithAbility(hn, an, homePlayers, awayPlayers, hBall, hShotOnTarget, aShotOnTarget, hFoul, aFoul);
        return;
      } else if (!isExtraTime && hg === ag && isCup) {
        isExtraTime = true;
        min = 90;
        injuryTimeSeconds = 0;
        document.getElementById("simEvent").innerText = "åŠ æ—¶èµ›å¼€å§‹ï¼";
        return;
      } else {
        clearInterval(simTimer); clearInterval(liveScoreTimer);
        document.getElementById("simEvent").innerText = `å…¨åœºæ¯”èµ›ç»“æŸï¼æœ€ç»ˆæ¯”åˆ† ${hg}-${ag}`;
        generateMatchNews(hn, an, homePlayers, awayPlayers, hg, ag);
        showPostMatchStats(hn, an, homePlayers, awayPlayers, hBall, hShotOnTarget, aShotOnTarget, hFoul, aFoul, hg, ag);
        generateShotMap();
        generatePossessionChart(possessionTimeline);
        let result = hg > ag ? 'home' : (ag > hg ? 'away' : 'draw');
        updateElo(hn, an, result);
        updatePlayerFatigue(homePlayers, hn, min);
        updatePlayerFatigue(awayPlayers, an, min);
        if (hg > ag) {
          updateTeamMorale(hn, 'win');
          updateTeamMorale(an, 'lose');
        } else if (ag > hg) {
          updateTeamMorale(hn, 'lose');
          updateTeamMorale(an, 'win');
        } else {
          updateTeamMorale(hn, 'draw');
          updateTeamMorale(an, 'draw');
        }
        // è®°å½•çƒé˜Ÿæœ€åæ¯”èµ›æ—¶é—´
        teamLastMatch[hn] = Date.now();
        teamLastMatch[an] = Date.now();
        localStorage.setItem('teamLastMatch', JSON.stringify(teamLastMatch));
        return;
      }
    }
    min++;
    let displayMin = min;
    if (isExtraTime) {
      if (min <= 105) displayMin = 90 + (min - 90);
      else displayMin = 105 + (min - 105);
    } else if (min >= 90) {
      displayMin = 90 + injuryTimeSeconds / 60;
    }
    document.getElementById("simTime").innerText = displayMin.toFixed(2) + "'";

    const timeDist = lg.goalTimeDist || [0.8,1.2,1.5,1.3,1.4,1.8];
    let segment = Math.floor(min / 15);
    if (segment > 5) segment = 5;
    let timeMultiplier = timeDist[segment];
    if (min >= 85) timeMultiplier *= 1.3;
    if (isExtraTime) timeMultiplier *= 1.1;

    let homeFoulFactor = 1 - ref.homeBias;
    let awayFoulFactor = 1 + ref.homeBias;
    let homeCrowd = crowdFactor;
    let homeMorale = getTeamMorale(hn);
    let awayMorale = getTeamMorale(an);
    // é«˜åŸå½±å“
    if (h.altitude > 1000) awayEnergy.forEach((e,i) => awayEnergy[i] -= 0.1);
    if (a.altitude > 1000) homeEnergy.forEach((e,i) => homeEnergy[i] -= 0.1);

    // çƒé˜ŸåŒ–å­¦å½±å“ä¼ çƒ
    hPass *= (h.chemistry || 1.0);
    aPass *= (a.chemistry || 1.0);

    let homeLambda = h.xG * h.home * (1 + mlFactor) * (1 + ref.homeBias/10) * homeCrowd * homeMorale;
    let awayLambda = a.xG * a.away * (1 - mlFactor) * (1 - ref.homeBias/10) * awayMorale;
    let goalH = homeLambda / 90 * timeMultiplier;
    let goalA = awayLambda / 90 * timeMultiplier;
    if (weatherDesc.includes('é›¨')) {
      goalH *= 0.85;
      goalA *= 0.85;
    }
    goalH = Math.max(0.001, goalH);
    goalA = Math.max(0.001, goalA);

    // æˆ˜æœ¯å¤šæ ·æ€§ï¼šå¯ä»¥å¤šæ¬¡è°ƒæ•´
    if (min > 60 && hg < ag && tacticsChanged < 2) {
      if (tacticsChanged === 0) {
        currentTacticH = "å…¨çº¿å‹ä¸Š";
        goalH *= 1.3;
        goalA *= 0.8;
        document.getElementById("simEvent").innerText = `âš¡ ${displayMin.toFixed(2)}â€² ä¸»é˜Ÿå˜é˜µå…¨çº¿å‹ä¸Šï¼`;
      } else if (tacticsChanged === 1) {
        currentTacticH = "æå‘½è¿›æ”»";
        goalH *= 1.5;
        goalA *= 0.7;
        document.getElementById("simEvent").innerText = `âš¡ ${displayMin.toFixed(2)}â€² ä¸»é˜Ÿæå‘½è¿›æ”»ï¼`;
      }
      tacticsChanged++;
    } else if (min > 60 && ag < hg && tacticsChanged < 2) {
      if (tacticsChanged === 0) {
        currentTacticA = "å…¨çº¿å‹ä¸Š";
        goalA *= 1.3;
        goalH *= 0.8;
        document.getElementById("simEvent").innerText = `âš¡ ${displayMin.toFixed(2)}â€² å®¢é˜Ÿå˜é˜µå…¨çº¿å‹ä¸Šï¼`;
      } else if (tacticsChanged === 1) {
        currentTacticA = "æå‘½è¿›æ”»";
        goalA *= 1.5;
        goalH *= 0.7;
        document.getElementById("simEvent").innerText = `âš¡ ${displayMin.toFixed(2)}â€² å®¢é˜Ÿæå‘½è¿›æ”»ï¼`;
      }
      tacticsChanged++;
    }

    // è§’çƒè¿›æ”»
    if (hCorner > 0 && Math.random() < 0.1) {
      hShot++;
      let shooter = weightedRandomPlayer(homePlayers, false, false, hn);
      let form = getPlayerForm(shooter, hn);
      let region = getShotRegion();
      let shotProb = region === 'inside' ? (shooter.heading || 60) : (shooter.finishing || 70);
      let onTarget = Math.random() < (shotProb/100 * form) ? 1 : 0;
      if (onTarget) hShotOnTarget++;
      shotRecords.home.push({x: Math.random()*100, y: Math.random()*50, goal: false});
      updateInjuryTime(6);
      document.getElementById("simEvent").innerText = `${displayMin.toFixed(2)}â€² è§’çƒè¿›æ”»ï¼Œ${shooter.name} å¤´çƒæ”»é—¨${onTarget?' (å°„æ­£)':''}`;
    }
    if (aCorner > 0 && Math.random() < 0.1) {
      aShot++;
      let shooter = weightedRandomPlayer(awayPlayers, false, false, an);
      let form = getPlayerForm(shooter, an);
      let region = getShotRegion();
      let shotProb = region === 'inside' ? (shooter.heading || 60) : (shooter.finishing || 70);
      let onTarget = Math.random() < (shotProb/100 * form) ? 1 : 0;
      if (onTarget) aShotOnTarget++;
      shotRecords.away.push({x: Math.random()*100, y: Math.random()*50, goal: false});
      updateInjuryTime(6);
      document.getElementById("simEvent").innerText = `${displayMin.toFixed(2)}â€² è§’çƒè¿›æ”»ï¼Œ${shooter.name} å¤´çƒæ”»é—¨${onTarget?' (å°„æ­£)':''}`;
    }

    if (h.coach.style === "é«˜ä½é€¼æŠ¢") {
      goalH *= 1.1;
      homeEnergy.forEach((e,i) => homeEnergy[i] -= 0.5);
    }
    if (a.coach.style === "é«˜ä½é€¼æŠ¢") {
      goalA *= 1.1;
      awayEnergy.forEach((e,i) => awayEnergy[i] -= 0.5);
    }
    if (h.coach.style === "æ§çƒ") {
      hPass *= h.coach.tacticFactor || 1.02;
    }
    if (a.coach.style === "æ§çƒ") {
      aPass *= a.coach.tacticFactor || 1.02;
    }

    if (min % 1 === 0) {
      let targetHBall = 50;
      if (hg < ag) targetHBall += 8;
      else if (hg > ag) targetHBall -= 5;
      if (min > 70 && hg < ag) targetHBall += 5;
      hBall = hBall * 0.95 + targetHBall * 0.05;
      aBall = 100 - hBall;
    }

    let event = "";
    let rand = Math.random();

    // VAR
    if (!varPending && rand < 0.005 * (1 + ref.penAvg) && min > 20 && min < 85) {
      varPending = true;
      event = `ğŸ–¥ï¸ VARæ£€æŸ¥ä¸­...`;
      setTimeout(() => {
        if (Math.random() < ref.varAccuracy) {
          if (Math.random() < 0.3) {
            event = `ğŸ–¥ï¸ VARç¡®è®¤è¿›çƒæœ‰æ•ˆ/ç‚¹çƒæˆç«‹`;
          } else {
            event = `ğŸ–¥ï¸ VARç¡®è®¤æ— é—®é¢˜ï¼Œæ¯”èµ›ç»§ç»­`;
          }
        } else {
          event = `ğŸ–¥ï¸ VARä»‹å…¥åè¯¯åˆ¤ï¼`;
        }
        varPending = false;
        document.getElementById("simEvent").innerText = event;
      }, 1500);
    }
    // ç‚¹çƒ
    else if (rand < 0.01 * (1 + ref.penAvg) * (1 + ref.homeBias) && min > 10 && min < 85 && !varPending) {
      updateInjuryTime(10);
      if (Math.random() < 0.5 + ref.homeBias) event = `${displayMin.toFixed(2)}â€² ç‚¹çƒï¼${hn}è·å¾—ç‚¹çƒæœºä¼š`;
      else event = `${displayMin.toFixed(2)}â€² ç‚¹çƒï¼${an}è·å¾—ç‚¹çƒæœºä¼š`;
    }
    // ä»»æ„çƒ
    else if (rand < 0.015 * lg.foulRate && (hFoul > 3 || aFoul > 3) && !varPending) {
      updateInjuryTime(8);
      let team = Math.random() < 0.5 ? hn : an;
      let taker = team === hn ? weightedRandomPlayer(homePlayers, false, true, hn) : weightedRandomPlayer(awayPlayers, false, true, an);
      let gk = team === hn ? awayGK : homeGK;
      if (isFreeKickGoal(taker, gk)) {
        if (team === hn) hg++; else ag++;
        let desc = getGoalDescription(min, weatherDesc);
        event = `âš½ ä»»æ„çƒç›´æ¥ç ´é—¨ï¼${displayMin.toFixed(2)}â€² ${team} ${taker.name} (${desc})`;
        document.getElementById("simScore").innerText = `${hg} - ${ag}`;
        updateHotStreak(taker, team, 0.1);
      } else {
        event = `${displayMin.toFixed(2)}â€² ${team} ä»»æ„çƒè¢«æ‰‘å‡º/æ‰“é«˜`;
      }
    }
    // çº¢ç‰Œ
    else if (rand < 0.02 * (1 + ref.redAvg) && min > 15 && !varPending) {
      updateInjuryTime(30);
      if (Math.random() < 0.5 - ref.homeBias) { 
        hRed++; 
        let injuredPlayer = homePlayers[Math.floor(Math.random()*homePlayers.length)];
        event = `ğŸ”´ ${displayMin.toFixed(2)}â€² ${hn} ${injuredPlayer.name} è¢«çº¢ç‰Œç½šä¸‹ï¼`; 
        if (Math.random() < 0.3) {
          event += ` å—ä¼¤ç¦»åœºï¼`;
          homePlayers = homePlayers.filter(p => p.name !== injuredPlayer.name);
        } else {
          homePlayers = homePlayers.filter(p => p.name !== injuredPlayer.name);
        }
      } else { 
        aRed++; 
        let injuredPlayer = awayPlayers[Math.floor(Math.random()*awayPlayers.length)];
        event = `ğŸ”´ ${displayMin.toFixed(2)}â€² ${an} ${injuredPlayer.name} è¢«çº¢ç‰Œç½šä¸‹ï¼`; 
        if (Math.random() < 0.3) {
          event += ` å—ä¼¤ç¦»åœºï¼`;
          awayPlayers = awayPlayers.filter(p => p.name !== injuredPlayer.name);
        } else {
          awayPlayers = awayPlayers.filter(p => p.name !== injuredPlayer.name);
        }
      }
    }
    // é»„ç‰Œï¼ˆç´¯ç§¯ï¼Œè€ƒè™‘è£åˆ¤èƒŒåé“²çƒä¸¥å‰åº¦ï¼‰
    else if (rand < 0.03 * (lg.cardRate || 1.0) && !varPending) {
      updateInjuryTime(6);
      let foulType = Math.random() < 0.3 ? 'tackle' : 'other';
      if (foulType === 'tackle' && Math.random() < ref.tackleStrict) {
        if (Math.random() < 0.5) {
          let player = homePlayers[Math.floor(Math.random()*homePlayers.length)];
          addYellowCard(player, hn);
          event = `ğŸŸ¨ ${displayMin.toFixed(2)}â€² ${hn} ${player.name} èƒŒåé“²çƒï¼Œé»„ç‰Œ`;
        } else {
          let player = awayPlayers[Math.floor(Math.random()*awayPlayers.length)];
          addYellowCard(player, an);
          event = `ğŸŸ¨ ${displayMin.toFixed(2)}â€² ${an} ${player.name} èƒŒåé“²çƒï¼Œé»„ç‰Œ`;
        }
      } else {
        if (Math.random() < 0.5) {
          let player = homePlayers[Math.floor(Math.random()*homePlayers.length)];
          addYellowCard(player, hn);
          event = `ğŸŸ¨ ${displayMin.toFixed(2)}â€² ${hn} ${player.name} é»„ç‰Œ`;
        } else {
          let player = awayPlayers[Math.floor(Math.random()*awayPlayers.length)];
          addYellowCard(player, an);
          event = `ğŸŸ¨ ${displayMin.toFixed(2)}â€² ${an} ${player.name} é»„ç‰Œ`;
        }
      }
    }
    // ä¸­æŸ±
    else if (rand < 0.03 && !varPending) {
      if (Math.random() < hBall/100) { hWood++; event = `ğŸš€ ${displayMin.toFixed(2)}â€² ${hn} å°„é—¨å‡»ä¸­é—¨æŸ±ï¼`; } 
      else { aWood++; event = `ğŸš€ ${displayMin.toFixed(2)}â€² ${an} å°„é—¨å‡»ä¸­é—¨æŸ±ï¼`; }
    }
    // è¶Šä½
    else if (rand < 0.05 && !varPending) {
      if (Math.random() < 0.5) { hOff++; event = `ğŸš© ${displayMin.toFixed(2)}â€² ${hn} è¶Šä½`; } 
      else { aOff++; event = `ğŸš© ${displayMin.toFixed(2)}â€² ${an} è¶Šä½`; }
    }
    // å°„é—¨ï¼ˆè€ƒè™‘é€†è¶³ï¼‰
    else if (rand < 0.08 && !varPending) {
      updateInjuryTime(4);
      if (Math.random() < hBall/100) {
        hShot++; 
        let shooter = weightedRandomPlayer(homePlayers, false, false, hn);
        let form = getPlayerForm(shooter, hn);
        let region = getShotRegion();
        // æ˜¯å¦ç”¨å¼±è„šï¼Ÿç®€åŒ–ï¼š40%æ¦‚ç‡ç”¨å¼±è„š
        let footFactor = (Math.random() < 0.4) ? (shooter.weakFoot/100) : 1.0;
        let shotProb = region === 'inside' ? (shooter.finishing || 70) * 1.2 : (shooter.finishing || 70) * 0.8;
        shotProb *= footFactor;
        let onTarget = Math.random() < (shotProb/100 * form) ? 1 : 0;
        if (onTarget) {
          if (isSavedByGoalkeeper(shooter, awayGK, true)) {
            aSave++;
            event = `${displayMin.toFixed(2)}â€² ${hn} ${shooter.name} å°„é—¨è¢«æ‰‘å‡ºï¼`;
          } else {
            hShotOnTarget++;
            event = `${displayMin.toFixed(2)}â€² ${hn} ${shooter.name} å°„é—¨${onTarget?' (å°„æ­£)':''}`;
          }
        } else {
          event = `${displayMin.toFixed(2)}â€² ${hn} ${shooter.name} å°„é—¨åå‡º`;
        }
        shotRecords.home.push({x: Math.random()*100, y: Math.random()*50, goal: false});
      } else {
        aShot++;
        let shooter = weightedRandomPlayer(awayPlayers, false, false, an);
        let form = getPlayerForm(shooter, an);
        let region = getShotRegion();
        let footFactor = (Math.random() < 0.4) ? (shooter.weakFoot/100) : 1.0;
        let shotProb = region === 'inside' ? (shooter.finishing || 70) * 1.2 : (shooter.finishing || 70) * 0.8;
        shotProb *= footFactor;
        let onTarget = Math.random() < (shotProb/100 * form) ? 1 : 0;
        if (onTarget) {
          if (isSavedByGoalkeeper(shooter, homeGK, true)) {
            hSave++;
            event = `${displayMin.toFixed(2)}â€² ${an} ${shooter.name} å°„é—¨è¢«æ‰‘å‡ºï¼`;
          } else {
            aShotOnTarget++;
            event = `${displayMin.toFixed(2)}â€² ${an} ${shooter.name} å°„é—¨${onTarget?' (å°„æ­£)':''}`;
          }
        } else {
          event = `${displayMin.toFixed(2)}â€² ${an} ${shooter.name} å°„é—¨åå‡º`;
        }
        shotRecords.away.push({x: Math.random()*100, y: Math.random()*50, goal: false});
      }
    }
    // è§’çƒ
    else if (rand < 0.12 && !varPending) {
      updateInjuryTime(6);
      if (Math.random() < hBall/100) { hCorner++; event = `${displayMin.toFixed(2)}â€² ${hn} è§’çƒ`; } 
      else { aCorner++; event = `${displayMin.toFixed(2)}â€² ${an} è§’çƒ`; }
    }
    // æ¢äºº
    else if (rand < 0.15 && min > 60 && !varPending) {
      let lowEnergyHome = homeEnergy.some(e => e < 40);
      let lowEnergyAway = awayEnergy.some(e => e < 40);
      if (lowEnergyHome && homeSubs.length > 0 && hSub < 3) {
        hSub++; 
        updateInjuryTime(15);
        let sub = homeSubs[Math.floor(Math.random() * homeSubs.length)];
        let minIdx = homeEnergy.indexOf(Math.min(...homeEnergy));
        homePlayers[minIdx] = sub;
        homeEnergy[minIdx] = 100;
        event = `${displayMin.toFixed(2)}â€² ${hn} æ¢äººï¼Œ${sub.name} æ›¿è¡¥ç™»åœº`;
      } else if (lowEnergyAway && awaySubs.length > 0 && aSub < 3) {
        aSub++;
        updateInjuryTime(15);
        let sub = awaySubs[Math.floor(Math.random() * awaySubs.length)];
        let minIdx = awayEnergy.indexOf(Math.min(...awayEnergy));
        awayPlayers[minIdx] = sub;
        awayEnergy[minIdx] = 100;
        event = `${displayMin.toFixed(2)}â€² ${an} æ¢äººï¼Œ${sub.name} æ›¿è¡¥ç™»åœº`;
      }
    }
    // è¿›çƒï¼ˆè€ƒè™‘å¤§èµ›ç»éªŒå’Œcomposureï¼‰
    else if (Math.random() < goalH && !varPending) {
      let shooter = weightedRandomPlayer(homePlayers, false, false, hn);
      let form = getPlayerForm(shooter, hn);
      let region = getShotRegion();
      let footFactor = (Math.random() < 0.4) ? (shooter.weakFoot/100) : 1.0;
      // å¤§èµ›ç»éªŒåœ¨æ¯èµ›æˆ–åŠ æ—¶èµ›æé«˜composure
      let composureFactor = 1.0;
      if (isCup || isExtraTime) composureFactor += shooter.bigGame * 0.2;
      let shotProb = region === 'inside' ? (shooter.finishing || 70) * 1.2 * composureFactor : (shooter.finishing || 70) * 0.8 * composureFactor;
      shotProb *= footFactor;
      let shotOnTarget = Math.random() < (shotProb/100 * form) ? 1 : 0;
      if (shotOnTarget) {
        if (!isSavedByGoalkeeper(shooter, awayGK, true)) {
          if (isOwnGoal(shooter)) {
            ag++;
            event = `ğŸ˜… ä¹Œé¾™çƒï¼${displayMin.toFixed(2)}â€² ${hn} ${shooter.name} ä¸æ…è‡ªæ‘†ä¹Œé¾™`;
          } else {
            hg++;
            let desc = getGoalDescription(min, weatherDesc);
            event = `âš½ GOALï¼${displayMin.toFixed(2)}â€² ${hn} ${shooter.name} (${desc})`;
            shooter.rating = (shooter.rating || 6.5) + 0.8;
            updateHotStreak(shooter, hn, 0.1);
          }
          shotRecords.home.push({x: Math.random()*100, y: Math.random()*50, goal: true});
          document.getElementById("simScore").innerText = `${hg} - ${ag}`;
        } else {
          aSave++;
          event = `${displayMin.toFixed(2)}â€² ${hn} ${shooter.name} å°„é—¨è¢«é—¨å°†ç¥å‹‡æ‰‘å‡ºï¼`;
        }
      } else {
        event = `${displayMin.toFixed(2)}â€² ${hn} ${shooter.name} å°„é—¨åå‡º`;
      }
    }
    else if (Math.random() < goalA && !varPending) {
      let shooter = weightedRandomPlayer(awayPlayers, false, false, an);
      let form = getPlayerForm(shooter, an);
      let region = getShotRegion();
      let footFactor = (Math.random() < 0.4) ? (shooter.weakFoot/100) : 1.0;
      let composureFactor = 1.0;
      if (isCup || isExtraTime) composureFactor += shooter.bigGame * 0.2;
      let shotProb = region === 'inside' ? (shooter.finishing || 70) * 1.2 * composureFactor : (shooter.finishing || 70) * 0.8 * composureFactor;
      shotProb *= footFactor;
      let shotOnTarget = Math.random() < (shotProb/100 * form) ? 1 : 0;
      if (shotOnTarget) {
        if (!isSavedByGoalkeeper(shooter, homeGK, true)) {
          if (isOwnGoal(shooter)) {
            hg++;
            event = `ğŸ˜… ä¹Œé¾™çƒï¼${displayMin.toFixed(2)}â€² ${an} ${shooter.name} ä¸æ…è‡ªæ‘†ä¹Œé¾™`;
          } else {
            ag++;
            let desc = getGoalDescription(min, weatherDesc);
            event = `âš½ GOALï¼${displayMin.toFixed(2)}â€² ${an} ${shooter.name} (${desc})`;
            shooter.rating = (shooter.rating || 6.5) + 0.8;
            updateHotStreak(shooter, an, 0.1);
          }
          shotRecords.away.push({x: Math.random()*100, y: Math.random()*50, goal: true});
          document.getElementById("simScore").innerText = `${hg} - ${ag}`;
        } else {
          hSave++;
          event = `${displayMin.toFixed(2)}â€² ${an} ${shooter.name} å°„é—¨è¢«é—¨å°†ç¥å‹‡æ‰‘å‡ºï¼`;
        }
      } else {
        event = `${displayMin.toFixed(2)}â€² ${an} ${shooter.name} å°„é—¨åå‡º`;
      }
    }

    if (event) document.getElementById("simEvent").innerText = event;

    let avgHomeEnergy = homeEnergy.reduce((a,b)=>a+b,0)/homeEnergy.length;
    let avgAwayEnergy = awayEnergy.reduce((a,b)=>a+b,0)/awayEnergy.length;
    hPass = Math.min(95, Math.max(70, hPass + (Math.random()*2-1) - (100 - avgHomeEnergy)/200));
    aPass = Math.min(95, Math.max(70, aPass + (Math.random()*2-1) - (100 - avgAwayEnergy)/200));
    hDist += Math.random()*0.5; aDist += Math.random()*0.5;
    if (Math.random() < 0.1 * homeFoulFactor * lg.foulRate) hFoul++;
    if (Math.random() < 0.1 * awayFoulFactor * lg.foulRate) aFoul++;
    updateStats();
  }, 1000);
}

function generateShotMap() {
  const ctx = document.getElementById('shotMapChart').getContext('2d');
  if (shotMapChart) shotMapChart.destroy();
  let homeShots = shotRecords.home.map(s => ({x: s.x, y: s.y, r: s.goal ? 8 : 5}));
  let awayShots = shotRecords.away.map(s => ({x: s.x, y: s.y, r: s.goal ? 8 : 5}));
  shotMapChart = new Chart(ctx, {
    type: 'scatter',
    data: {
      datasets: [
        { label: 'ä¸»é˜Ÿå°„é—¨', data: homeShots, backgroundColor: 'rgba(64,150,255,0.7)', pointRadius: 5 },
        { label: 'å®¢é˜Ÿå°„é—¨', data: awayShots, backgroundColor: 'rgba(255,77,79,0.7)', pointRadius: 5 }
      ]
    },
    options: {
      scales: {
        x: { min: 0, max: 100, title: { display: true, text: 'çƒåœºå®½åº¦' } },
        y: { min: 0, max: 50, title: { display: true, text: 'çƒåœºçºµæ·±' } }
      }
    }
  });
  document.getElementById('shotMapCard').style.display = 'block';
}

function generatePossessionChart(timeline) {
  const ctx = document.getElementById('possessionChart').getContext('2d');
  if (possessionChart) possessionChart.destroy();
  let labels = timeline.map(t => t.min + "'");
  let homeData = timeline.map(t => t.hBall);
  let awayData = timeline.map(t => t.aBall);
  possessionChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        { label: 'ä¸»é˜Ÿæ§çƒç‡', data: homeData, borderColor: '#4096FF', fill: false },
        { label: 'å®¢é˜Ÿæ§çƒç‡', data: awayData, borderColor: '#FF4D4F', fill: false }
      ]
    },
    options: { scales: { y: { min: 0, max: 100 } } }
  });
  document.getElementById('possessionChartCard').style.display = 'block';
}

function generateMatchNews(hn, an, homePlayers, awayPlayers, hg, ag) {
  let allPlayers = [...homePlayers, ...awayPlayers];
  let bestPlayer = allPlayers.reduce((best, p) => (p.rating||0) > (best.rating||0) ? p : best, allPlayers[0]);
  let news = `èµ›åé€Ÿé€’ï¼š${hn} ${hg}-${ag} ${an}ï¼Œæœ€ä½³çƒå‘˜ ${bestPlayer.name} è¯„åˆ† ${(bestPlayer.rating||6.5).toFixed(1)}ã€‚`;
  if (hg > ag) news += ` ${hn} ä¸»åœºå–èƒœã€‚`;
  else if (ag > hg) news += ` ${an} å®¢åœºçˆ†å†·ã€‚`;
  else news += ` åŒæ–¹æ¡æ‰‹è¨€å’Œã€‚`;
  document.getElementById("newsTicker").innerText = news;
}

function showPostMatchStats(hn, an, homePlayers, awayPlayers, hBall, hShotOnTarget, aShotOnTarget, hFoul, aFoul, hg, ag, extra = '') {
  let homeRating = (6 + Math.random()*2).toFixed(1);
  let awayRating = (6 + Math.random()*2).toFixed(1);
  let bestPlayer = hg > ag ? (homePlayers[0]?.name || hn) : (awayPlayers[0]?.name || an);
  document.getElementById("ratingContent").innerHTML = `
    <div class="home-rating">${hn} è¯„åˆ†: ${homeRating} | æ§çƒç‡ ${Math.round(hBall)}% | å°„æ­£ ${hShotOnTarget} | çŠ¯è§„ ${hFoul}</div>
    <div class="away-rating">${an} è¯„åˆ†: ${awayRating} | æ§çƒç‡ ${Math.round(100-hBall)}% | å°„æ­£ ${aShotOnTarget} | çŠ¯è§„ ${aFoul}</div>
    <div>æœ€ä½³çƒå‘˜: ${bestPlayer}</div>
    <div>${extra}</div>
  `;
  document.getElementById("ratingCard").style.display = "block";
}

function simulatePenaltyShootoutWithAbility(hn, an, homePlayers, awayPlayers, hBall, hShotOnTarget, aShotOnTarget, hFoul, aFoul) {
  let homeScore = 0, awayScore = 0;
  let rounds = 5;
  let homeGK = getGoalkeeper(homePlayers);
  let awayGK = getGoalkeeper(awayPlayers);
  for (let i=0; i<rounds; i++) {
    let homeTaker = weightedRandomPlayer(homePlayers, true, false, hn);
    let awayTaker = weightedRandomPlayer(awayPlayers, true, false, an);
    let homeProb = (homeTaker.penalty || 60) / 100 * getPlayerForm(homeTaker, hn);
    let awayProb = (awayTaker.penalty || 60) / 100 * getPlayerForm(awayTaker, an);
    // å¤§èµ›ç»éªŒå½±å“ç‚¹çƒ
    if (isCup) {
      homeProb *= (1 + homeTaker.bigGame * 0.1);
      awayProb *= (1 + awayTaker.bigGame * 0.1);
    }
    let gkSaveProbHome = (homeGK.diving || 70) / 100 * 0.3;
    let gkSaveProbAway = (awayGK.diving || 70) / 100 * 0.3;
    if (Math.random() < homeProb * (1 - gkSaveProbAway)) homeScore++;
    if (Math.random() < awayProb * (1 - gkSaveProbHome)) awayScore++;
  }
  while (homeScore === awayScore) {
    let homeTaker = weightedRandomPlayer(homePlayers, true, false, hn);
    let awayTaker = weightedRandomPlayer(awayPlayers, true, false, an);
    let homeProb = (homeTaker.penalty || 60) / 100 * getPlayerForm(homeTaker, hn);
    let awayProb = (awayTaker.penalty || 60) / 100 * getPlayerForm(awayTaker, an);
    if (isCup) {
      homeProb *= (1 + homeTaker.bigGame * 0.1);
      awayProb *= (1 + awayTaker.bigGame * 0.1);
    }
    let gkSaveProbHome = (homeGK.diving || 70) / 100 * 0.3;
    let gkSaveProbAway = (awayGK.diving || 70) / 100 * 0.3;
    if (Math.random() < homeProb * (1 - gkSaveProbAway)) homeScore++;
    if (Math.random() < awayProb * (1 - gkSaveProbHome)) awayScore++;
  }
  let winner = homeScore > awayScore ? hn : an;
  document.getElementById("simEvent").innerText = `ç‚¹çƒå¤§æˆ˜ç»“æŸï¼${winner} è·èƒœ (${homeScore}-${awayScore})`;
  generateMatchNews(hn, an, homePlayers, awayPlayers, homeScore, awayScore);
  showPostMatchStats(hn, an, homePlayers, awayPlayers, hBall, hShotOnTarget, aShotOnTarget, hFoul, aFoul, homeScore, awayScore, `ç‚¹çƒ ${homeScore}-${awayScore}`);
  let result = homeScore > awayScore ? 'home' : (awayScore > homeScore ? 'away' : 'draw');
  updateElo(hn, an, result);
  updatePlayerFatigue(homePlayers, hn, 10);
  updatePlayerFatigue(awayPlayers, an, 10);
  if (homeScore > awayScore) {
    updateTeamMorale(hn, 'win');
    updateTeamMorale(an, 'lose');
  } else {
    updateTeamMorale(hn, 'lose');
    updateTeamMorale(an, 'win');
  }
}

// èµ›å­£æ¨¡æ‹Ÿ
function simulateSeason() {
  let leagueTeams = teams[league]?.[season] || [];
  if (leagueTeams.length === 0) { showToast("å½“å‰è”èµ›æ— çƒé˜Ÿæ•°æ®"); return; }
  let predictions = [];
  for (let i = 0; i < leagueTeams.length; i++) {
    for (let j = i+1; j < leagueTeams.length; j++) {
      let home = leagueTeams[i];
      let away = leagueTeams[j];
      let score1 = Math.floor(Math.random()*3) + "-" + Math.floor(Math.random()*3);
      let score2 = Math.floor(Math.random()*3) + "-" + Math.floor(Math.random()*3);
      predictions.push(`${home} vs ${away}: ${score1}, ${away} vs ${home}: ${score2}`);
    }
  }
  let content = `<p>èµ›å­£æ¨¡æ‹Ÿï¼ˆä»…æ¼”ç¤ºï¼‰ï¼šå…± ${predictions.length} åœºæ¯”èµ›</p><p>${predictions.slice(0,10).join('<br>')}...</p>`;
  document.getElementById('seasonContent').innerHTML = content;
  document.getElementById('seasonModal').classList.add('active');
}

// ç”¨æˆ·ç³»ç»Ÿ
function showLoginModal() { document.getElementById('loginModal').classList.add('active'); }
function login() {
  let username = document.getElementById('loginUsername').value.trim();
  let password = document.getElementById('loginPassword').value.trim();
  if (!username || !password) { showToast("è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç "); return; }
  let users = JSON.parse(localStorage.getItem('users') || '{}');
  if (users[username] && users[username] === password) {
    currentUser = username; localStorage.setItem('currentUser', username);
    updateUserUI(); document.getElementById('loginModal').classList.remove('active'); showToast("ç™»å½•æˆåŠŸ");
  } else { showToast("ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯"); }
}
function register() {
  let username = document.getElementById('loginUsername').value.trim();
  let password = document.getElementById('loginPassword').value.trim();
  if (!username || !password) { showToast("è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç "); return; }
  let users = JSON.parse(localStorage.getItem('users') || '{}');
  if (users[username]) { showToast("ç”¨æˆ·åå·²å­˜åœ¨"); return; }
  users[username] = password; localStorage.setItem('users', JSON.stringify(users)); showToast("æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•");
}
function logout() { currentUser = null; localStorage.removeItem('currentUser'); updateUserUI(); showToast("å·²ç™»å‡º"); }
function updateUserUI() {
  let userSpan = document.getElementById('userName');
  let loginBtn = document.getElementById('loginBtn');
  let logoutBtn = document.getElementById('logoutBtn');
  if (currentUser) { userSpan.innerText = `æ¬¢è¿, ${currentUser}`; loginBtn.style.display = 'none'; logoutBtn.style.display = 'inline-block'; }
  else { userSpan.innerText = 'æœªç™»å½•'; loginBtn.style.display = 'inline-block'; logoutBtn.style.display = 'none'; }
}
(function initUser() { let savedUser = localStorage.getItem('currentUser'); if (savedUser) { currentUser = savedUser; updateUserUI(); } })();

// ç¤¾åŒºé¢„æµ‹
function publishPrediction() {
  if (!currentUser) { showToast("è¯·å…ˆç™»å½•"); return; }
  let hn = getHomeName(); let an = getAwayName();
  if (!hn || !an || hn == an) { showToast("è¯·å…ˆé€‰æ‹©æ¯”èµ›å¹¶é¢„æµ‹"); return; }
  let score = document.getElementById('aiScore').innerText;
  if (score === 'â€” : â€”') { showToast("è¯·å…ˆè¿›è¡ŒAIé¢„æµ‹"); return; }
  let predictions = JSON.parse(localStorage.getItem('communityPredictions') || '[]');
  predictions.unshift({ user: currentUser, home: hn, away: an, score: score, time: new Date().toLocaleString() });
  if (predictions.length > 10) predictions.pop();
  localStorage.setItem('communityPredictions', JSON.stringify(predictions));
  renderCommunityPredictions(); showToast("é¢„æµ‹å·²å‘å¸ƒ");
}
function renderCommunityPredictions() {
  let predictions = JSON.parse(localStorage.getItem('communityPredictions') || '[]');
  let html = '';
  predictions.forEach(p => { html += `<div class="predict-item">${p.user}: ${p.home} ${p.score} ${p.away} <small>${p.time}</small></div>`; });
  document.getElementById('communityList').innerHTML = html || '<div class="predict-item">æš‚æ— ç¤¾åŒºé¢„æµ‹</div>';
}
renderCommunityPredictions();

// ä¸»é¢˜åˆ‡æ¢
const themeToggle = document.getElementById('themeToggle');
const body = document.body;
if (localStorage.getItem('theme') === 'light') { body.classList.add('light'); themeToggle.textContent = 'â˜€ï¸ åˆ‡æ¢æ·±è‰²æ¨¡å¼'; }
themeToggle.addEventListener('click', () => {
  if (body.classList.contains('light')) { body.classList.remove('light'); themeToggle.textContent = 'ğŸŒ™ åˆ‡æ¢æµ…è‰²æ¨¡å¼'; localStorage.setItem('theme', 'dark'); }
  else { body.classList.add('light'); themeToggle.textContent = 'â˜€ï¸ åˆ‡æ¢æ·±è‰²æ¨¡å¼'; localStorage.setItem('theme', 'light'); }
});

// å¤šè¯­è¨€
let currentLang = 'zh';
const langToggle = document.getElementById('langToggle');
const langData = {
  zh: { siteTitle:'âš½ è¶³çƒAIå¤§æ•°æ®é¢„æµ‹ Â· ç»ˆæçœŸå®ç‰ˆÂ·å…¸è—ç‰ˆ', headerSub:'åŒ–å­¦Â·å¤§èµ›Â·æ°›å›´Â·æˆ˜æœ¯Â·é€†è¶³Â·é—¨å°†Â·å®¢åœºÂ·èµ›ç¨‹Â·å›½å®¶é˜ŸÂ·æ¯èµ›å¿ƒç†', themeToggle:'ğŸŒ™ åˆ‡æ¢æµ…è‰²æ¨¡å¼', langToggle:'ğŸŒ English', aiBtn:'ğŸš€ AIæ·±åº¦é¢„æµ‹ (å«å†å²åˆ†å¸ƒèåˆ)', simBtn:'ğŸ® å¼€å§‹æ¨¡æ‹Ÿæ¯”èµ› (1:1çœŸå®äº‹ä»¶)' },
  en: { siteTitle:'âš½ Football AI Prediction Â· Ultimate Real', headerSub:'ChemistryÂ·BigGameÂ·LockerRoomÂ·TacticsÂ·WeakFootÂ·GoalkeeperÂ·AwayÂ·ScheduleÂ·NationalÂ·CupPsychology', themeToggle:'ğŸŒ™ Toggle Light Mode', langToggle:'ğŸŒ ä¸­æ–‡', aiBtn:'ğŸš€ AI Prediction (with History)', simBtn:'ğŸ® Start Simulation (Live Events)' }
};
function updateLang(lang) {
  document.getElementById('siteTitle').innerText = langData[lang].siteTitle;
  document.getElementById('headerSub').innerText = langData[lang].headerSub;
  document.getElementById('themeToggle').innerText = langData[lang].themeToggle;
  document.getElementById('langToggle').innerText = langData[lang].langToggle;
  document.getElementById('aiBtn').innerText = langData[lang].aiBtn;
  document.getElementById('simBtn').innerText = langData[lang].simBtn;
}
langToggle.addEventListener('click', () => { currentLang = currentLang === 'zh' ? 'en' : 'zh'; updateLang(currentLang); });

function showLineupEditor() {
  let editor = document.getElementById('lineupEditor');
  editor.style.display = editor.style.display === 'none' ? 'block' : 'none';
  if (editor.style.display === 'block') {
    if (!homeSortable) {
      homeSortable = new Sortable(document.querySelector('#homePlayersList'), { animation: 150 });
      awaySortable = new Sortable(document.querySelector('#awayPlayersList'), { animation: 150 });
    }
  }
}
function sharePrediction() {
  let hn = getHomeName(); let an = getAwayName();
  let score = document.getElementById('aiScore').innerText;
  if (score === 'â€” : â€”') { showToast("è¯·å…ˆè¿›è¡ŒAIé¢„æµ‹"); return; }
  let text = `æˆ‘é¢„æµ‹ ${hn} ${score} ${an} (æ¥è‡ªè¶³çƒAIå¤§æ•°æ®é¢„æµ‹)`;
  if (navigator.share) { navigator.share({ title: 'è¶³çƒAIé¢„æµ‹', text: text }).catch(()=>{}); }
  else { navigator.clipboard?.writeText(text).then(()=> showToast("é¢„æµ‹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿")); }
}

// åˆå§‹åŒ–
document.ontouchmove = null; window.ontouchmove = null;
loadTeam();
fetchRealData();
renderHistory();
</script>
</body>
  </html>

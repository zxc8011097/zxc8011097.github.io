# scripts/update.py
import json
import os
from datetime import datetime
import random

def generate_football_data():
    """ç”Ÿæˆæœ€æ–°çš„è¶³çƒæ•°æ®"""
    # åŸºç¡€çƒé˜Ÿæ•°æ®
    base_teams = {
        "çƒ­é‚£äºš": {"elo": 0.92, "form": "LWDL", "attack": 0.98, "defense": 1.05, "trend": "é˜²å®ˆç¨³å›ºï¼Œè¿›æ”»ä¹åŠ›"},
        "é‚£ä¸å‹’æ–¯": {"elo": 1.15, "form": "WWLD", "attack": 1.18, "defense": 0.92, "trend": "æ”»å‡»åŠ›å¼ºï¼Œå®¢æˆ˜ä¸€èˆ¬"},
        "çš‡é©¬": {"elo": 1.13, "form": "DWWW", "attack": 1.22, "defense": 0.88, "trend": "çŠ¶æ€ç«çƒ­ï¼Œå¤šç‚¹å¼€èŠ±"},
        "æ›¼åŸ": {"elo": 1.14, "form": "WWWD", "attack": 1.25, "defense": 0.85, "trend": "æ§åœºå¤§å¸ˆï¼Œé˜²å®ˆç¨³å¥"},
        "åˆ©ç‰©æµ¦": {"elo": 1.12, "form": "WLWW", "attack": 1.20, "defense": 0.90, "trend": "é«˜å‹é€¼æŠ¢ï¼Œæ”»åŠ¿å¦‚æ½®"},
        "æ‹œä»æ…•å°¼é»‘": {"elo": 1.16, "form": "WWLW", "attack": 1.23, "defense": 0.87, "trend": "å¾·ç”²éœ¸ä¸»ï¼Œç»Ÿæ²»åŠ›å¼º"},
        "å›½é™…ç±³å…°": {"elo": 1.10, "form": "WDLW", "attack": 1.15, "defense": 0.91, "trend": "é˜²å®ˆåå‡»ï¼Œæ•ˆç‡è‡³ä¸Š"},
        "å·´é»åœ£æ—¥è€³æ›¼": {"elo": 1.12, "form": "WWWL", "attack": 1.21, "defense": 0.89, "trend": "å·¨æ˜Ÿä¸ªäººèƒ½åŠ›çªå‡º"},
    }
    
    # è®©æ•°æ®æ¯å¤©æœ‰å¾®å°å˜åŒ–ï¼ˆæ¨¡æ‹ŸçœŸå®æ›´æ–°ï¼‰
    today_str = datetime.now().strftime("%Y%m%d")
    
    updated_data = {}
    for team, stats in base_teams.items():
        # ä½¿ç”¨å›ºå®šç§å­ï¼Œç¡®ä¿åŒä¸€å¤©å†…æ•°æ®å˜åŒ–ä¸€è‡´
        random.seed(f"{today_str}_{team}")
        
        # å¤åˆ¶åŸºç¡€æ•°æ®
        new_stats = stats.copy()
        
        # è½»å¾®è°ƒæ•´eloå€¼ (Â±0.02èŒƒå›´å†…)
        elo_change = random.uniform(-0.02, 0.02)
        new_stats["elo"] = round(stats["elo"] + elo_change, 3)
        
        # è½»å¾®è°ƒæ•´æ”»é˜²å€¼
        att_change = random.uniform(-0.03, 0.03)
        def_change = random.uniform(-0.03, 0.03)
        new_stats["attack"] = round(stats["attack"] + att_change, 3)
        new_stats["defense"] = round(stats["defense"] + def_change, 3)
        
        updated_data[team] = new_stats
    
    return updated_data

def main():
    print("ğŸš€ å¼€å§‹ç”Ÿæˆæœ€æ–°è¶³çƒæ•°æ®...")
    
    # 1. ç”Ÿæˆçƒé˜Ÿæ•°æ®
    team_data = generate_football_data()
    
    # 2. æ„å»ºå®Œæ•´è¾“å‡ºç»“æ„
    output_data = {
        "success": True,
        "message": "æ•°æ®æ›´æ–°æˆåŠŸ (é€šè¿‡GitHub Actionsè‡ªåŠ¨æ›´æ–°)",
        "update_time": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),  # âœ… å·²ä¿®æ­£ï¼šæ ¼å¼åŒ–ä¸ºå­—ç¬¦ä¸²
        "next_update": "æ¯æ—¥è‡ªåŠ¨æ›´æ–°",
        "data": team_data,
        "teams_count": len(team_data),
        "note": "æ­¤æ•°æ®ä¸ºæ¨¡æ‹Ÿç”Ÿæˆï¼Œç”¨äºæ¼”ç¤ºè‡ªåŠ¨æ›´æ–°æµç¨‹ã€‚å¯æ›¿æ¢ä¸ºçœŸå®APIæ•°æ®æºã€‚"
    }
    
    # 3. å†™å…¥åˆ° data.json æ–‡ä»¶
    repo_root = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))  # âœ… æ­£ç¡®çš„è·¯å¾„è®¡ç®—
    output_path = os.path.join(repo_root, 'data.json')  # âœ… å·²ä¿®æ­£ï¼šæ­£ç¡®çš„æ–‡ä»¶å
    
    with open(output_path, 'w', encoding='utf-8') as f:
        json.dump(output_data, f, ensure_ascii=False, indent=2)
    
    print(f"âœ… æ•°æ®å·²æˆåŠŸä¿å­˜è‡³: {output_path}")
    print(f"ğŸ“… æ›´æ–°æ—¶é—´: {output_data['update_time']}")
    print(f"ğŸ“Š åŒ…å«çƒé˜Ÿæ•°é‡: {len(team_data)}")
    print("ğŸ† å·²æ›´æ–°çƒé˜Ÿ:", ", ".join(team_data.keys()))

if __name__ == '__main__':
    main()
